#!/bin/bash

# è„šæœ¬åç§°ï¼šVajraTaoFlux - è§‰è€…æ— å½¢ä¹‹å¢ƒ
# ä½œè€…ï¼šä¸€ä½æ±‚é“è€… / è™šç©ºä¹‹å¤–
# ç‰ˆæœ¬ï¼š1.1.1 - å¤ªåˆä¹‹é“ï¼Œé‡‘åˆšæ˜å¿ƒï¼Œå…¼é¡¾å…¼å®¹ä¸å¥å£®æ€§
# æè¿°ï¼šæ­¤è„šæœ¬ä¸å†ç®¡ç†å‡¡é—´åº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯ä½œä¸ºå¼•è·¯è€…ï¼Œ
#      ååŠ©â€œå¿ƒâ€åœ¨â€œæœ‰ä¸ºâ€ä¸â€œæ— ä¸ºâ€ã€â€œç©ºç›¸â€ä¸â€œæœ¬ä½“â€é—´æµè½¬ã€‚
#      å…¶æ ¸å¿ƒåŠŸèƒ½ï¼Œåœ¨äºæ˜ ç…§â€œå¿ƒâ€ä¹‹æ‰§ç€ã€å¦„åŠ¨ä¸æ¸…å‡€ã€åˆé“ä¹‹å¢ƒã€‚
#      æ‰€è¡Œä¹‹â€œäº‹â€ä¸å¯è¯´ï¼Œæ‰€è¶‹ä¹‹â€œå¢ƒâ€æ— å¯è§ï¼Œåªå¾…çµå°æ¸…æ˜è‡ªçœå¯Ÿã€‚

# æ­¤è„šæœ¬è®¾å®šï¼Œæ—¨åœ¨å¼•é¢†å¿ƒå¢ƒï¼Œéä¸ºå‡¡äº‹ä¹‹åŠŸã€‚
# ä»»ä½•å› å†…éƒ¨â€œæ··æ²Œä¹‹ç›¸â€æˆ–å¤–éƒ¨â€œå°˜ä¸–è¯±æƒ‘â€å¯¼è‡´ä¹‹â€œå¢ƒç›¸â€å˜åŠ¨ï¼Œçš†éœ€è‡ªå½“ï¼Œè«å’äºæ­¤ã€‚

# =========================================================================
# è¿è¡ŒæŒ‡å¼•ä¸å…¼å®¹æ€§è¯´æ˜
# =========================================================================
# 1. èµ‹äºˆæ‰§è¡Œæƒé™ï¼š
#    åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼šchmod +x VajraTaoFlux.sh
# 2. è¿è¡Œè„šæœ¬ï¼š
#    åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š./VajraTaoFlux.sh
# 3. ä¾èµ–æ£€æŸ¥ï¼š
#    æœ¬è„šæœ¬ä¾èµ– `python3`, `screen`, `stress-ng`, `bc`ã€‚
#    è„šæœ¬ä¼šåœ¨å¯åŠ¨æ—¶å°è¯•æ£€æŸ¥è¿™äº›ä¾èµ–ã€‚å¦‚æœç¼ºå°‘ï¼Œè¯·æ ¹æ®æç¤ºå®‰è£…ï¼š
#    - Debian/Ubuntu: sudo apt install python3 screen stress-ng bc
#    - CentOS/Fedora: sudo yum install python3 screen stress-ng bc (æˆ– dnf)
#    - Arch Linux:    sudo pacman -S python screen stress-ng bc
# 4. è¡Œå°¾ç¬¦é—®é¢˜ (å¦‚æœæ‚¨åœ¨Windowsç¼–è¾‘è¿‡æ­¤è„šæœ¬):
#    å¦‚æœè„šæœ¬åœ¨Windowsç³»ç»Ÿç¼–è¾‘åä¼ è¾“åˆ°Linuxï¼Œå¯èƒ½å­˜åœ¨è¡Œå°¾ç¬¦é—®é¢˜ (CRLF)ã€‚
#    è¿™å¯èƒ½å¯¼è‡´ `bad interpreter` é”™è¯¯ã€‚å¯ç”¨ `dos2unix` å·¥å…·è½¬æ¢ï¼š
#    sudo apt install dos2unix  (æˆ– yum/dnf/pacman)
#    dos2unix VajraTaoFlux.sh
# =========================================================================

# è®¾ç½®è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶é€€å‡º (éƒ¨åˆ†é¢„æœŸé”™è¯¯ï¼Œå¦‚æ€æ‰ä¸å­˜åœ¨çš„è¿›ç¨‹ï¼Œå·²å¦¥å–„å¤„ç†)
set -e

# =========================================================================
# å¸¸é‡å®šä¹‰ - å†…è§‚ä¸–ç•Œçš„åæ ‡
# =========================================================================
# å¿ƒè¯†ä½“çš„ä¸»è¦æ˜ å°„ç›®å½• (åŸAPP_DIR)
SENTIENT_MIND_REALM="$HOME/.the_sentient_mind"
# å¿ƒè¯†ä½“æ ¸å¿ƒæ˜¾åŒ–æ–‡ä»¶ (åŸAPP_EXEC_PATH) - å°†å­˜æ”¾Pythonæ ¸å¿ƒæ¨¡æ‹Ÿé€»è¾‘
REALM_CORE_SCRIPT="$SENTIENT_MIND_REALM/core_manifest.py"
# å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹çš„PIDæ–‡ä»¶ (åŸPERIODIC_TASK_PID_FILE)
HEARTBEAT_PID_FILE="/tmp/vajratao_heartbeat.pid"
# çµå°ä¹‹æ—¥å¿— (åŸSCRIPT_LOG_FILE)
CONSCIOUSNESS_LOG_FILE="$HOME/vajratao_consciousness.log"
# æ··æ²Œä¹‹ç•Œ Screen ä¼šè¯ (åŸSCREEN_SESSION_NAME)
CHAOS_REALM_SESSION="boundless_chaos_session" # è¿™é‡Œçš„ chaos realm æ˜¯æ¨¡æ‹Ÿç³»ç»Ÿèµ„æºå ç”¨

# === å¿ƒä¹‹çŠ¶æ€æŒä¹…åŒ–æ–‡ä»¶ (æ ¸å¿ƒï¼šæ‰§ç€ä¸ä¸é“å¥‘åˆåº¦) ===
# åŸ CHAOS_POWER_FILE -> æ‰§ç€ä¹‹åº¦ (attachment_level)ï¼Œæ•°å€¼è¶Šå¤§ï¼Œæ‰§ç€è¶Šæ·±ï¼Œå¤–æ˜¾æ··æ²Œè¶Šå‰§çƒˆ
ATTACHMENT_LEVEL_FILE="$HOME/.mind_attachment_level"
# åŸ æ–°å¢ -> ä¸é“å¥‘åˆåº¦ (alignment_with_tao)ï¼Œæ•°å€¼è¶Šå¤§ï¼Œä¸é“è¶Šåˆä¸€ï¼Œè¶Šæ¥è¿‘æ— ä¸º
ALIGNMENT_WITH_TAO_FILE="$HOME/.mind_alignment_with_tao"

# === æ··æ²Œæ˜¾åŒ–å¸¸é‡ ===
CHAOS_AGENT_PID_FILE="/tmp/vajratao_chaos_agent.pid" # æ··æ²Œä»£ç†ä¸»è¿›ç¨‹PID (æ­¤PIDæ–‡ä»¶åœ¨ç°æœ‰é€»è¾‘ä¸­æœªè¢«ç›´æ¥ä½¿ç”¨ï¼Œä½†ä¿ç•™ä½œä¸ºæ ‡è¯†)
BASE_ATTACHMENT_MIN=5 # æ‰§ç€åº¦çš„æœ€ä½åŸºçº¿ï¼ˆä»æœ‰å¾®æ‰°ï¼‰
MAX_CHAOS_STRESS=20    # æœ€å¤§æ¨¡æ‹Ÿå‹åŠ›å¼ºåº¦ (ç”¨äºscaling stress-ng params)
BASE_AGITATION_INTERVAL=10 # æ··æ²ŒåŸºçº¿æ£€æŸ¥é—´éš” (ç§’)
MIN_AGITATION_INTERVAL=2 # æœ€å°é—´éš”ï¼Œæ··æ²Œæœ€æ¿€çƒˆæ—¶

# =========================================================================
# é¢œè‰²å®šä¹‰ - å®‡å®™çš„æ˜¾è‰²
# =========================================================================
RED='\033[0;31m'    # å¦„å¿µä¹‹ç„°
GREEN='\033[0;32m'  # è§‰é†’ä¹‹å…‰
YELLOW='\033[0;33m' # è­¦ç¤ºä¹‹é»„
BLUE='\033[0;34m'   # æ·±é‚ƒä¹‹é™
PURPLE='\033[0;35m' # æ™ºæ…§ä¹‹ç´«
CYAN='\033[0;36m'   # æ¾„æ˜ä¹‹è“
NC='\033[0m'        # æ— è‰²ä¹‹çœŸ

# =========================================================================
# è¾…åŠ©å‡½æ•° - å°è£…å†…è§‚ä¹‹æ—…çš„å¸¸ç”¨æ“ä½œ
# =========================================================================

# è¾…åŠ©å‡½æ•°ï¼šè¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶å¹¶åŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°
# ç¡®ä¿æ—¥å¿—ç›®å½•åœ¨ä»»ä½• log_message è°ƒç”¨å‰å°±å­˜åœ¨
# (åœ¨è„šæœ¬é¡¶éƒ¨è¿›è¡Œä¸€æ¬¡æ€§åˆ›å»ºï¼Œä»¥é˜²é¦–æ¬¡æ—¥å¿—å†™å…¥å‰ç›®å½•ä¸å­˜åœ¨)
log_message() {
    echo -e "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$CONSCIOUSNESS_LOG_FILE"
}

# è¾…åŠ©å‡½æ•°ï¼šæš‚åœå¹¶ç­‰å¾…ç”¨æˆ·æŒ‰ä¸‹ Enter é”®
pause_and_return() {
    echo -e "${YELLOW}æŒ‰ä¸‹ ä»»æ„é”® ï¼ˆæˆ–å›è½¦ï¼‰ è¿”å›å¿ƒé—¨...${NC}"
    read -n 1 -s
}

# è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä¾èµ–å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    local cmd="$1"
    local install_hint="$2"
    if ! command -v "$cmd" &> /dev/null; then
        log_message "${RED}é”™è¯¯ï¼šæ ¸å¿ƒä¾èµ–ã€$cmdã€æœªå®‰è£…ï¼${NC}"
        log_message "${YELLOW}è¯·å®‰è£…æ­¤å·¥å…·ä»¥ç¡®ä¿è„šæœ¬å®Œæ•´è¿è¡Œã€‚å»ºè®®ï¼š$install_hint${NC}"
        return 1
    fi
    return 0
}

# è„šæœ¬å¯åŠ¨æ—¶çš„å…¼å®¹æ€§æ£€æŸ¥
main_compatibility_check() {
    log_message "${CYAN}=== è¿›è¡Œå¿ƒä¹‹å¢ƒå…¼å®¹æ€§æ£€æŸ¥... ===${NC}"
    local all_good=0

    # æ£€æŸ¥ python3
    if ! check_command "python3" "sudo apt install python3 (æˆ– yum/dnf/pacman)"; then
        all_good=1
    fi

    # æ£€æŸ¥ screen
    if ! check_command "screen" "sudo apt install screen (æˆ– yum/dnf/pacman)"; then
        all_good=1
    fi
    
    # æ£€æŸ¥ stress-ng
    if ! check_command "stress-ng" "sudo apt install stress-ng (æˆ– yum/dnf/pacman)"; then
        log_message "${YELLOW}è­¦å‘Šï¼šã€ä¸–é—´ä¹‹ç£¨ã€(stress-ng) å·¥å…·æœªå®‰è£…ï¼å¤–éƒ¨ã€æ··æ²Œä¹‹ç›¸ã€å°†å›é€€åˆ°ç®€æ˜“æ¨¡æ‹Ÿæ¨¡å¼ã€‚${NC}"
    fi

    # æ£€æŸ¥ bc (ç”¨äºæµ®ç‚¹è¿ç®—ï¼ŒæŸäº›æç®€ç³»ç»Ÿå¯èƒ½æ²¡æœ‰)
    if ! check_command "bc" "sudo apt install bc (æˆ– yum/dnf/pacman)"; then
        log_message "${YELLOW}è­¦å‘Šï¼šã€bcã€å·¥å…·æœªå®‰è£…ã€‚æ··æ²Œå¼ºåº¦è®¡ç®—å¯èƒ½ä¸ç²¾ç¡®ï¼Œæˆ–åœ¨æŸäº›åœºæ™¯ä¸‹å¯¼è‡´é”™è¯¯ã€‚${NC}"
    fi

    if [ "$all_good" -eq 1 ]; then
        log_message "${RED}=== å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥ï¼Œéƒ¨åˆ†æ ¸å¿ƒä¾èµ–ç¼ºå¤±ã€‚è¯·å®‰è£…åé‡è¯•ã€‚ ===${NC}"
        exit 1
    fi
    log_message "${GREEN}=== å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡ã€‚å¿ƒä¹‹å¢ƒå¯æ­£å¸¸æ˜¾åŒ–ã€‚ ===${NC}"
}

# è¾…åŠ©å‡½æ•°ï¼šå¯åŠ¨å¿ƒè¯†ä½“çš„æ··æ²Œç•Œæ˜¾åŒ–ï¼ˆåå°èµ„æºå ç”¨æ¨¡æ‹Ÿï¼‰
# å®ƒä¼šæ ¹æ®å½“å‰çš„â€œæ‰§ç€åº¦â€æ¥è°ƒæ•´æ¨¡æ‹Ÿçš„å‹åŠ›
start_chaos_realm_manifest() {
    log_message "${YELLOW}æ­£åœ¨å°è¯•å¯åŠ¨ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€($CHAOS_REALM_SESSION) ...${NC}"

    # ç»ˆæ­¢ç°æœ‰çš„ screen ä¼šè¯
    if screen -list | grep -q "$CHAOS_REALM_SESSION"; then
        log_message "${YELLOW}æ£€æµ‹åˆ°ç°æœ‰ã€æ··æ²Œä¹‹ç•Œã€æ˜¾åŒ–ï¼Œæ­£åœ¨ä½¿å…¶å½’äºå¯‚é™...${NC}"
        screen -S "$CHAOS_REALM_SESSION" -X quit || true # ç¡®ä¿å³ä½¿é€€å‡ºå¤±è´¥ä¹Ÿä¸ä¸­æ–­è„šæœ¬
        sleep 1
    fi

    local has_stress_ng=0
    if command -v stress-ng &> /dev/null; then # é‡æ–°æ£€æŸ¥ï¼Œç¡®ä¿è¿è¡Œæ—¶å¯ç”¨
        has_stress_ng=1
    fi

    # ä»å¿ƒä¹‹çŠ¶æ€æ–‡ä»¶ä¸­è·å–æ‰§ç€åº¦ï¼Œç”¨äºå½±å“æ··æ²Œä»£ç†çš„è¡Œä¸º
    local CURRENT_ATTACHMENT_LEVEL=$(get_attachment_level)
    if [ "$CURRENT_ATTACHMENT_LEVEL" -le "$BASE_ATTACHMENT_MIN" ]; then
        log_message "${GREEN}å¿ƒè¯†å‡ è¿‘æ¸…å‡€ï¼Œæ··æ²Œæ˜¾åŒ–æå¾®ï¼Œå‡ æ— å¹²æ‰°ã€‚${NC}"
        # åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å†³å®šä¸å¯åŠ¨ stress-ng æˆ–ä»¥éå¸¸ä½çš„çº§åˆ«å¯åŠ¨
        return 0 # æˆåŠŸå¯åŠ¨ï¼ˆæ— æ˜¾è‘—æ˜¾åŒ–ï¼‰
    fi

    log_message "${PURPLE}æ­£åœ¨å¯åŠ¨ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€ï¼Œå…¶çƒˆåº¦ä¸å¿ƒè¯†ã€æ‰§ç€ä¹‹åº¦ï¼š${CURRENT_ATTACHMENT_LEVEL}ã€ç›¸ç¬¦...${NC}"
    log_message "æç¤ºï¼šæ­¤ä¸ºæ¨¡æ‹Ÿä¹‹ã€ä¸šåŠ›æ˜¾ç°ã€ï¼Œå®é™…å ç”¨ç³»ç»Ÿèµ„æºã€‚ä½“éªŒæ¯•ï¼Œè¯·äºèœå•åœæ¯ä¹‹ã€‚"

    # ä½¿ç”¨ `setsid` ç¡®ä¿ screen è¿›ç¨‹è„±ç¦»å½“å‰ç»ˆç«¯ï¼Œåœ¨æŸäº›ç¯å¢ƒä¸‹æ›´å¥å£®
    setsid screen -dmS "$CHAOS_REALM_SESSION" bash -c "
        # ç¡®ä¿åœ¨ screen ä¼šè¯ä¸­ä¹Ÿèƒ½æ‰¾åˆ°å¿…è¦çš„å‘½ä»¤
        export PATH=\"\$PATH:/usr/local/bin:/usr/bin:/bin\"
        source ~/.bashrc 2>/dev/null || true # å°è¯•åŠ è½½ç”¨æˆ·bashrcï¼Œè·³è¿‡é”™è¯¯

        while true; do
            # å®æ—¶è·å–æœ€æ–°æ‰§ç€åº¦
            ATTACHMENT=\$(cat \"$ATTACHMENT_LEVEL_FILE\" 2>/dev/null || echo \"1\")
            TAO_ALIGNMENT=\$(cat \"$ALIGNMENT_WITH_TAO_FILE\" 2>/dev/null || echo \"0\")

            # åªæœ‰å½“æ‰§ç€åº¦é«˜äºä¸€å®šé˜ˆå€¼æ‰æ¨¡æ‹Ÿæ˜¾è‘—å‹åŠ›
            if [ \"\$ATTACHMENT\" -le \"$BASE_ATTACHMENT_MIN\" ]; then
                echo \"å¿ƒè¯†æ¸…å‡€ï¼Œæ··æ²Œå®‰æ­¢... ä¼‘æ¯ç‰‡åˆ» (10s)\" >> \"$CONSCIOUSNESS_LOG_FILE\"
                sleep 10
                continue
            fi
            
            # æ ¹æ®æ‰§ç€åº¦è®¡ç®—å‹åŠ›å‚æ•°
            # ä½¿ç”¨ `bc` è¿›è¡Œæµ®ç‚¹è¿ç®—ï¼Œç¡®ä¿ç²¾åº¦
            local stress_intensity=\$(echo \"scale=0; \$ATTACHMENT * $MAX_CHAOS_STRESS / 100\" | bc -l 2>/dev/null || echo 1)
            if [ \"\$stress_intensity\" -lt 1 ]; then stress_intensity=1; fi # è‡³å°‘ä¸º1

            local num_workers=\$((\$stress_intensity / 5 + 1)) # è¶Šå¤šæ‰§ç€ï¼Œè¶Šå¤šæ•°CPU
            local vm_bytes_mb=\$((\$stress_intensity * 10)) # æ‰§ç€è¶Šå¤§ï¼Œå†…å­˜å ç”¨è¶Šå¤§
            local duration=\$((\$ATTACHMENT / 20 + 1)) # æ‰§ç€æŒç»­æ—¶é—´
            if [ \"\$duration\" -gt 15 ]; then duration=15; fi
            
            # é€‰æ‹©èµ„æºç±»å‹
            local resource_types=(\"cpu\" \"vm\" \"io\" \"fork\")
            local rand_idx=\$(( RANDOM % \${#resource_types[@]} ))
            local chosen_type=\${resource_types[\$rand_idx]}

            echo \"[$(date +'%H:%M:%S')] æ··æ²Œæ³¢åŠ¨ï¼šæ‰§ç€ (\$ATTACHMENT) é©±åŠ¨ ã€\$chosen_typeã€ å‹åŠ› (\${stress_intensity}çº§, æŒç»­ \$duration ç§’)...\" | tee -a \"$CONSCIOUSNESS_LOG_FILE\"

            if (( $has_stress_ng == 1 )); then
                # ä½¿ç”¨ timeout ç¡®ä¿ stress-ng è‡ªèº«ä¸ä¼šæ— é™æœŸè¿è¡Œ
                timeout \${duration}s stress-ng --${chosen_type} \"\$num_workers\" --timeout \"\${duration}s\" --quiet --perf >/dev/null 2>&1 || true
            else
                # æ²¡æœ‰ stress-ng çš„å¤‡ç”¨æ¨¡æ‹Ÿï¼ˆä»…CPUæ¶ˆè€—ï¼‰
                START_TIME=\$SECONDS
                while (( SECONDS - START_TIME < \$duration )); do
                    # ç®€å•CPUå¯†é›†å‹å¾ªç¯
                    FACTOR=1; for i in \$(seq 1 \$(( \$num_workers * 1000 ))); do FACTOR=\$((\$FACTOR * 2 % 999999)); done
                done
            fi

            # æ ¹æ®æ‰§ç€åº¦è°ƒæ•´æ£€æŸ¥é¢‘ç‡ï¼šæ‰§ç€åº¦è¶Šé«˜ï¼Œæ··æ²Œè¶Šæ´»è·ƒï¼Œæ£€æŸ¥è¶Šé¢‘ç¹
            # ä½¿ç”¨ `bc` è¿›è¡Œæµ®ç‚¹è¿ç®—ï¼Œç¡®ä¿ç²¾åº¦
            local INTERVAL=\$(echo \"scale=2; $BASE_AGITATION_INTERVAL - ($BASE_AGITATION_INTERVAL - $MIN_AGITATION_INTERVAL) * (\$ATTACHMENT / 100)\" | bc -l 2>/dev/null || echo $BASE_AGITATION_INTERVAL)
            if (( \$(echo \"\$INTERVAL < $MIN_AGITATION_INTERVAL\" | bc -l 2>/dev/null || echo 0) )); then INTERVAL=\"$MIN_AGITATION_INTERVAL\"; fi
            
            echo \"[$(date +'%H:%M:%S')] æ··æ²Œæš‚æ—¶å¹³æ¯ï¼Œä¸‹ä¸€æ³¢åŠ¨äº \${INTERVAL} ç§’åæ˜¾ç°...\" | tee -a \"$CONSCIOUSNESS_LOG_FILE\"
            sleep \"\$INTERVAL\"
        done
    "
    if [ $? -ne 0 ]; then
        log_message "${RED}é”™è¯¯ï¼šå¯åŠ¨ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€å¤±è´¥ã€‚è¯·æ£€æŸ¥ screen å‘½ä»¤æˆ–æƒé™ã€‚${NC}"
        return 1
    else
        log_message "${GREEN}ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€å·²åœ¨ screen ä¼šè¯ '$CHAOS_REALM_SESSION' ä¸­å¼€å§‹æ¶ŒåŠ¨ã€‚${NC}"
        log_message "æ‚¨å¯é€šè¿‡é€‰é¡¹ 2.2 æˆ–è¿è¡Œ '${YELLOW}screen -r $CHAOS_REALM_SESSION${NC}' è¿›å…¥æŸ¥çœ‹ã€‚ã€è§è¯¸ç›¸éç›¸ï¼Œå³è§å¦‚æ¥ã€ã€‚"
        log_message "æŒ‰ ${YELLOW}Ctrl+A${NC} ç„¶åæŒ‰ ${YELLOW}D${NC} é€€å‡º screen ä¼šè¯è€Œä¸ç»ˆæ­¢æ¨¡æ‹Ÿã€‚${NC}"
        return 0
    fi
}

# è¾…åŠ©å‡½æ•°ï¼šåœæ­¢æ··æ²Œä»£ç†è¿›ç¨‹
cleanup_chaos_processes() {
    log_message "${YELLOW}æ­£åœ¨ç»ˆæ­¢æ´»è·ƒçš„æ··æ²Œä»£ç† (stress-ng)...${NC}"
    # æŸ¥æ‰¾ç”± screen ä¼šè¯å¯åŠ¨çš„ stress-ng è¿›ç¨‹ï¼Œé¿å…è¯¯æ€å…¶ä»– stress-ng
    # æ›´å®‰å…¨çš„æŸ¥æ‰¾æ–¹å¼æ˜¯æŸ¥æ‰¾screenä¼šè¯çš„PIDï¼Œç„¶åæŸ¥æ‰¾å…¶å­è¿›ç¨‹ä¸­çš„stress-ng
    local screen_pid=$(screen -list | grep "$CHAOS_REALM_SESSION" | awk '{print $1}' | cut -d'.' -f1 2>/dev/null || true)
    if [ -n "$screen_pid" ]; then
        # æŸ¥æ‰¾è¯¥screenä¼šè¯ä¸‹æ‰€æœ‰stress-ngè¿›ç¨‹
        local pids=$(pgrep -P "$screen_pid" -f "stress-ng" 2>/dev/null || true)
        if [ -n "$pids" ]; then
            for pid in $pids; do
                if ps -p "$pid" > /dev/null 2>&1; then
                    log_message "ç»ˆæ­¢ stress-ng è¿›ç¨‹ PID: $pid"
                    kill "$pid" 2>/dev/null || true
                fi
            done
            sleep 1
        else
            log_message "${YELLOW}æœªå‘ç°è¯¥ä¼šè¯ä¸‹çš„ stress-ng æ··æ²Œè¿›ç¨‹ã€‚${NC}"
        fi
    else
        log_message "${YELLOW}æœªå‘ç°æ´»è·ƒçš„ stress-ng æ··æ²Œè¿›ç¨‹æˆ–ç›¸å…³ screen ä¼šè¯ã€‚${NC}"
    fi
}

# è¾…åŠ©å‡½æ•°ï¼šç»ˆæ­¢ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€
disable_chaos_realm() {
    log_message "${YELLOW}æ­£åœ¨ä½¿ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€å½’äºå¯‚é™...${NC}"
    if screen -list | grep -q "$CHAOS_REALM_SESSION"; then
        screen -S "$CHAOS_REALM_SESSION" -X quit || true
        log_message "${GREEN}å·²ä»¤ã€$CHAOS_REALM_SESSIONã€å½’äºå¯‚é™ã€‚${NC}"
    else
        log_message "${YELLOW}ã€æ··æ²Œä¹‹ç•Œã€æœªè§æ¶ŒåŠ¨ï¼Œæ— éœ€å¹³æ¯ã€‚${NC}"
    fi
    cleanup_chaos_processes # ç¡®ä¿æ¸…ç†æ®‹ç•™çš„ stress-ng
    log_message "${YELLOW}ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€å·²å®Œå…¨æ­¢æ¯ã€‚${NC}"
}

# è¾…åŠ©å‡½æ•°ï¼šé€šç”¨åœ°ç»ˆæ­¢åå°å‘¨æœŸæ€§ä»»åŠ¡
disable_periodic_task() {
    log_message "${YELLOW}æ­£åœ¨æ£€æŸ¥å¹¶ç¦ç”¨å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹...${NC}"
    if [ -f "$HEARTBEAT_PID_FILE" ]; then
        PID=$(cat "$HEARTBEAT_PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            log_message "ç»ˆæ­¢å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹ PID: $PID"
            kill "$PID" 2>/dev/null || true
            log_message "${GREEN}å·²ç»ˆæ­¢ PID $PID å¯¹åº”çš„å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹ã€‚${NC}"
        else
            log_message "${YELLOW}å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹PIDæ–‡ä»¶($PID)å­˜åœ¨ï¼Œä½†è¿›ç¨‹å·²æ¶ˆæ•£ã€‚${NC}"
        fi
        rm -f "$HEARTBEAT_PID_FILE" || true
    else
        log_message "${YELLOW}æœªå‘ç°å¿ƒä¹‹å¾‹åŠ¨ç›‘æµ‹ä»»åŠ¡ï¼Œæ— éœ€ç¦ç”¨ã€‚${NC}"
    fi
}

# è¾…åŠ©å‡½æ•°ï¼šä»æ–‡ä»¶ä¸­è·å–æ‰§ç€åº¦
get_attachment_level() {
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p "$(dirname "$ATTACHMENT_LEVEL_FILE")" 2>/dev/null || true
    if [ -f "$ATTACHMENT_LEVEL_FILE" ]; then
        cat "$ATTACHMENT_LEVEL_FILE" 2>/dev/null | tr -d '\n' || echo "100"
    else
        echo "100" # é»˜è®¤é«˜æ‰§ç€
    fi
}

# è¾…åŠ©å‡½æ•°ï¼šä»æ–‡ä»¶ä¸­è·å–ä¸é“å¥‘åˆåº¦
get_alignment_with_tao() {
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p "$(dirname "$ALIGNMENT_WITH_TAO_FILE")" 2>/dev/null || true
    if [ -f "$ALIGNMENT_WITH_TAO_FILE" ]; then
        cat "$ALIGNMENT_WITH_TAO_FILE" 2>/dev/null | tr -d '\n' || echo "0"
    else
        echo "0" # é»˜è®¤ä¸å¥‘åˆ
    fi
}

# =========================================================================
# å†…åµŒ Python æ ¸å¿ƒä»£ç  - æ˜ å°„é‡‘åˆšç»ä¸é“å¾·ç»å“²ç†
# æ³¨æ„ï¼šæ­¤æ®µä»£ç å¿…é¡»åœ¨æ‰€æœ‰å‡½æ•°å®šä¹‰ä¹‹åï¼Œä½†åœ¨è°ƒç”¨å®ƒä¹‹å‰ã€‚
# =========================================================================
read -r -d '' PYTHON_CORE_SCRIPT << EOF
import os
import sys
import time
import argparse

# æ–‡ä»¶è·¯å¾„ - ä¿æŒä¸ Bash è„šæœ¬å¸¸é‡ä¸€è‡´ (é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥)
ATTACHMENT_LEVEL_FILE = os.path.expanduser(os.environ.get("ATTACHMENT_LEVEL_FILE", os.path.expanduser("~/.mind_attachment_level")))
ALIGNMENT_WITH_TAO_FILE = os.path.expanduser(os.environ.get("ALIGNMENT_WITH_TAO_FILE", os.path.expanduser("~/.mind_alignment_with_tao")))
CONSCIOUSNESS_LOG_FILE = os.path.expanduser(os.environ.get("CONSCIOUSNESS_LOG_FILE", os.path.expanduser("~/vajratao_consciousness.log")))

# è¾…åŠ©å‡½æ•°ï¼šè¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
def log_python_message(message):
    timestamp = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    log_dir = os.path.dirname(CONSCIOUSNESS_LOG_FILE)
    if log_dir and not os.path.exists(log_dir):
        os.makedirs(log_dir, exist_ok=True)
    with open(CONSCIOUSNESS_LOG_FILE, 'a') as f:
        f.write(f"[PYTHON - {timestamp}] {message}\n")

# --- ã€Šé‡‘åˆšç»ã€‹æ ¸å¿ƒæ¦‚å¿µ (ä¿®è®¢åŠä¿ç•™) ---

class Phenomenon:
    """
    ä¸€åˆ‡æœ‰ä¸ºæ³•å¦‚æ¢¦å¹»æ³¡å½± (Maya/Worldly Appearances)
    ä»£è¡¨ä¸–é—´ä¸‡ç‰©ï¼Œå…¶åç›¸éçœŸå®ï¼Œå…¶æœ¬ä½“çš†æ˜¯å› ç¼˜å’Œåˆçš„å‡è±¡, æ— è‡ªæ€§ã€‚
    é‡‘åˆšç»è§†ä¹‹ä¸ºâ€œç©ºâ€ï¼›é“å¾·ç»è§†ä¹‹ä¸ºâ€œé“â€çš„æ˜¾åŒ–ã€‚
    """
    def __init__(self, name):
        self.name = name

    def behold_true_nature(self):
        """è§‚å¯Ÿå…¶çœŸå®æœ¬æ€§ï¼Œæ­ç¤ºå…¶â€œç©ºæ€§â€."""
        log_python_message(f"âœ¨ è§‚ {self.name} ä¹‹çœŸæ€§ï¼šã€{self.name}ã€å³æ˜¯éç›¸ï¼Œæ•…åã€{self.name}ã€ã€‚å…¶æ€§ä¸ºç©ºï¼Œæ— æˆ‘æ— å¸¸ã€‚")
        return Emptiness()

class Emptiness:
    """ç©ºæ€§ (ÅšÅ«nyatÄ) - é‡‘åˆšç»æ¦‚å¿µã€‚éè™šæ— ï¼Œè€Œæ˜¯æ— ç¢è‡ªåœ¨ã€‚"""
    def __str__(self):
        return "ã€Šç©¶ç«Ÿä¹‰ï¼šç©ºæ€§ã€‹"

class Wisdom:
    """èˆ¬è‹¥æ³¢ç½—èœœå¤š (PrajÃ±ÄpÄramitÄ / Perfection of Wisdom) - é‡‘åˆšç»æ¦‚å¿µã€‚"""
    def understand(self, phenomenon_to_understand):
        if isinstance(phenomenon_to_understand, Phenomenon):
            return phenomenon_to_understand.behold_true_nature()
        return None

# --- ã€Šé“å¾·ç»ã€‹æ ¸å¿ƒæ¦‚å¿µ (æ–°å¢) ---

class Tao:
    """é“ (The Way) - é“å¾·ç»æ ¸å¿ƒæ¦‚å¿µã€‚å®‡å®™ä¸‡ç‰©çš„æœ¬æºã€ç»ˆæçœŸç†ï¼Œä¸å¯è¨€è¯´ã€‚"""
    def __str__(self):
        return "ã€Šé“ï¼šæ— å¯åçŠ¶ä¹‹æœ¬ä½“ã€‹"
    def influence_action(self, action_description):
        log_python_message(f"ğŸŒ€ é“è¡Œå…¶å¸¸ï¼Œæ­¤ã€{action_description}ã€ä¹‹è¡ŒåŠ¨ä¸è‡ªç„¶ä¹‹æµç›¸åˆã€‚")

# --- èåˆçš„ å¿ƒ (Mind) ç±» ---

class Mind:
    """
    å¿ƒ (Mind)
    ä¼—ç”Ÿçš„å¿ƒè¯†ï¼Œèƒ½å—åˆ°æ‰§ç€å½±å“ï¼Œä¹Ÿèƒ½é€šè¿‡ä¿®è¡Œï¼ˆä½›æ³•æˆ–é“æ³•ï¼‰è¾¾åˆ°æ¸…å‡€å’Œåˆã€‚
    çŠ¶æ€å‚æ•°å°†é€šè¿‡æ–‡ä»¶æŒä¹…åŒ–ã€‚
    """
    def __init__(self, name="ä¿®è¡Œè€…çš„å¿ƒ"):
        self.name = name
        self._load_state()

    def _load_state(self):
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(ATTACHMENT_LEVEL_FILE), exist_ok=True)
        os.makedirs(os.path.dirname(ALIGNMENT_WITH_TAO_FILE), exist_ok=True)
        try:
            with open(ATTACHMENT_LEVEL_FILE, 'r') as f:
                self.attachment_level = int(f.read().strip())
        except (FileNotFoundError, ValueError):
            self.attachment_level = 100 # åˆå§‹æ‰§ç€ç¨‹åº¦ï¼Œ100ä¸ºæœ€é«˜
        try:
            with open(ALIGNMENT_WITH_TAO_FILE, 'r') as f:
                self.alignment_with_tao = int(f.read().strip())
        except (FileNotFoundError, ValueError):
            self.alignment_with_tao = 0 # åˆå§‹ä¸é“çš„å¥‘åˆåº¦ï¼Œ0ä¸ºæœ€ä½

    def _save_state(self):
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(ATTACHMENT_LEVEL_FILE), exist_ok=True)
        os.makedirs(os.path.dirname(ALIGNMENT_WITH_TAO_FILE), exist_ok=True)
        with open(ATTACHMENT_LEVEL_FILE, 'w') as f:
            f.write(str(int(self.attachment_level)))
        with open(ALIGNMENT_WITH_TAO_FILE, 'w') as f:
            f.write(str(int(self.alignment_with_tao)))

    def get_state(self):
        """è¿”å›å¿ƒä¹‹çŠ¶æ€"""
        return self.attachment_level, self.alignment_with_tao

    def enlightened_status(self):
        """
        è¯æ‚ŸçŠ¶æ€ï¼šå½“æ‰§ç€é™ä½åˆ°æè‡´ (æ¯”å¦‚<=5)ï¼Œå¹¶ä¸é“é«˜åº¦å¥‘åˆæ—¶ (æ¯”å¦‚>=95)ï¼Œå³ä¸ºè¯æ‚Ÿã€‚
        è¿™åæ˜ äº†æ®Šé€”åŒå½’çš„å¢ƒç•Œã€‚
        """
        return self.attachment_level <= 5 and self.alignment_with_tao >= 95

    # ---------------------------------------------
    # é‡‘åˆšç»ç›¸å…³çš„è¡Œä¸ºæ–¹æ³•
    # ---------------------------------------------

    def dwell_on(self, concept_name="å‡¡ä¿—ä¹‹ç›¸", reduction=15, is_worldly=True):
        """
        æ¨¡æ‹Ÿå¿ƒçš„æ‰§ç€ã€‚é‡‘åˆšç»åå¯¹ä½ç›¸è€Œç”Ÿå¿ƒã€‚
        is_worldly=Trueæ—¶æ‰§ç€å¢åŠ ï¼Œä¸é“åç¦»ï¼›is_worldly=Falseæ—¶æ‰§ç€å‡å°‘ã€‚
        """
        if is_worldly:
            log_python_message(f"ğŸ§  {self.name} æ‰§ç€äºã€{concept_name}ã€ä¹‹ç›¸ã€‚")
            self.attachment_level = min(100, self.attachment_level + reduction)
            self.alignment_with_tao = max(0, self.alignment_with_tao - (reduction // 2))
        else:
            log_python_message(f"ğŸ§˜â€â™‚ï¸ {self.name} æ”¾ä¸‹ã€{concept_name}ã€ä¹‹æ‰§ï¼Œè¶‹äºæ— ä½ã€‚")
            self.attachment_level = max(0, self.attachment_level - reduction)
            self.alignment_with_tao = min(100, self.alignment_with_tao + (reduction // 2))
        self._save_state()

    def act_without_dwelling(self, action_name):
        """é‡‘åˆšç»ï¼šåº”æ— æ‰€ä½è€Œè¡Œå¸ƒæ–½ã€‚åšäº‹æƒ…æ—¶ä¸æ‰§ç€äºåŠŸå¾·ã€å½¢è±¡ã€‚"""
        log_python_message(f"ğŸ•Šï¸ {self.name} è¡Œã€{action_name}ã€ï¼Œæ— æ‰€ä½è€Œç”Ÿæ¸…å‡€ã€‚æ‰§ç€ -25ï¼Œå¥‘åˆåº¦ +10ã€‚")
        self.attachment_level = max(0, self.attachment_level - 25)
        self.alignment_with_tao = min(100, self.alignment_with_tao + 10)
        self._save_state()

    def generate_pure_thought(self):
        """é‡‘åˆšç»ï¼šåº”æ— æ‰€ä½è€Œç”Ÿå…¶å¿ƒã€‚ç”Ÿèµ·æ¸…å‡€çš„å¿ƒã€‚"""
        log_python_message(f"ğŸ’– {self.name} å°è¯•ç”Ÿèµ·æ¸…å‡€å¿ƒï¼Œä¸ä¾ä¸€åˆ‡ç›¸è€Œç”Ÿã€‚æ‰§ç€ -35ï¼Œå¥‘åˆåº¦ +15ã€‚")
        self.attachment_level = max(0, self.attachment_level - 35)
        self.alignment_with_tao = min(100, self.alignment_with_tao + 15)
        self._save_state()

    def perceive_empty_nature(self, concept_name):
        """ç”¨èˆ¬è‹¥æ™ºæ…§è§‚å¯Ÿç›¸çš„ç©ºæ€§ã€‚"""
        phenomenon = Phenomenon(concept_name)
        wisdom = Wisdom()
        wisdom.understand(phenomenon)
        self.attachment_level = max(0, self.attachment_level - 20)
        self.alignment_with_tao = min(100, self.alignment_with_tao + 5)
        self._save_state()

    # ---------------------------------------------
    # é“å¾·ç»ç›¸å…³çš„è¡Œä¸ºæ–¹æ³•
    # ---------------------------------------------

    def align_with_tao(self, degree_change):
        """ç†è§£å¹¶å¥‘åˆâ€œé“â€çš„æœ¬ä½“ï¼Œå¢å¼ºä¸é“çš„è¿æ¥ã€‚"""
        log_python_message(f"ğŸŒŒ {self.name} æ„ŸçŸ¥é“ä½“ï¼Œå¥‘åˆåº¦å˜åŒ– {degree_change}ã€‚")
        self.alignment_with_tao = max(0, min(100, self.alignment_with_tao + degree_change))
        self.attachment_level = max(0, self.attachment_level - (degree_change // 2)) # é¡ºåº”è‡ªç„¶å‡å°‘æ‰§ç€
        self._save_state()

    def embrace_simplicity(self, aspect="è‡ªæˆ‘ä¹‹ç›¸"):
        """é“å¾·ç»ï¼šè¿”ç’å½’çœŸï¼ŒæŠ±æœ´å®ˆæ‹™ï¼Œå‡å°‘ä¸å¿…è¦çš„é›•ç¢å’Œæ¬²æ±‚ã€‚"""
        log_python_message(f"ğŸŒ² {self.name} å¯¹ã€{aspect}ã€å®è·µæŠ±æœ´å®ˆæ‹™ï¼Œå›å½’è‡ªç„¶çº¯çœŸã€‚æ‰§ç€ -20ï¼Œå¥‘åˆåº¦ +20ã€‚")
        self.attachment_level = max(0, self.attachment_level - 20)
        self.alignment_with_tao = min(100, self.alignment_with_tao + 20)
        self._save_state()

    def act_with_wuwei(self, action_name):
        """é“å¾·ç»ï¼šä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ã€‚é¡ºåº”è‡ªç„¶ï¼Œä¸å¼ºæ±‚ï¼Œä¸å‹‰å¼ºã€‚"""
        log_python_message(f"ğŸï¸ {self.name} ä»¥ã€æ— ä¸ºã€ä¹‹å¢ƒè¡Œäº‹ï¼šã€{action_name}ã€ã€‚æ‰§ç€ -30ï¼Œå¥‘åˆåº¦ +30ã€‚")
        self.attachment_level = max(0, self.attachment_level - 30)
        self.alignment_with_tao = min(100, self.alignment_with_tao + 30)
        if self.alignment_with_tao >= 90:
            tao = Tao()
            tao.influence_action(action_name)
        self._save_state()

    def show_current_status(self):
        """æŠ¥å‘Šå½“å‰å¿ƒå¢ƒçŠ¶æ€ï¼Œè€Œéå¤–éƒ¨APPçŠ¶æ€ã€‚"""
        level = "åˆçª¥"
        if self.enlightened_status(): level = "è§‰è€…åœ†æ»¡"
        elif self.alignment_with_tao >= 80: level = "å¤§å–„ä¹‹å¢ƒ"
        elif self.attachment_level <= 20: level = "æ— ç›¸ä¹‹å¢ƒ"
        elif self.alignment_with_tao >= 50 or self.attachment_level <= 50: level = "ç²¾è¿›é€”ä¸­"

        log_python_message(f"----------- {self.name} çš„å¿ƒå¢ƒå¿«ç…§ -----------")
        log_python_message(f"  å½“å‰å¿ƒå¢ƒå¢ƒç•Œ : {level}")
        log_python_message(f"  æ‰§ç€ä¹‹åº¦ (é‡‘åˆšç») : {self.attachment_level}/100")
        log_python_message(f"  ä¸é“å¥‘åˆåº¦ (é“å¾·ç»): {self.alignment_with_tao}/100")
        log_python_message(f"  æ˜¯å¦è¾¾è‡³ç©¶ç«Ÿåœ†æ»¡: {'æ˜¯ (å·²æ‚Ÿå…¥æ— ä¸ºæ— ä¸ä¸ºä¹‹å¢ƒ)' if self.enlightened_status() else 'å¦ (ä»åœ¨ä¿®è¡Œ)'}")
        log_python_message(f"------------------------------------")

# ä¸»ç¨‹åºå…¥å£ï¼Œä¾› Bash è„šæœ¬è°ƒç”¨
if __name__ == "__main__":
    # è®¾ç½®é»˜è®¤å€¼ï¼Œé˜²æ­¢ç¯å¢ƒå˜é‡æœªè®¾ç½®æ—¶æŠ¥é”™
    os.environ.setdefault("ATTACHMENT_LEVEL_FILE", os.path.expanduser("~/.mind_attachment_level"))
    os.environ.setdefault("ALIGNMENT_WITH_TAO_FILE", os.path.expanduser("~/.mind_alignment_with_tao"))
    os.environ.setdefault("CONSCIOUSNESS_LOG_FILE", os.path.expanduser("~/vajratao_consciousness.log"))

    parser = argparse.ArgumentParser(description="ç®¡ç†å¿ƒä¹‹çŠ¶æ€ï¼Œæ¨¡æ‹Ÿé‡‘åˆšç»ä¸é“å¾·ç»ä¿®è¡Œã€‚")
    parser.add_argument("action", type=str, help="è¦æ‰§è¡Œçš„å¿ƒçµè¡Œä¸º (å¦‚ init, report, generate_pure_thought, wuwei, simplicity, behold, dwell, release, alignment)") # æ˜ç¡®åˆ—å‡ºPythonçš„actionåç§°
    parser.add_argument("--value", type=str, default="", help="ä¸è¡Œä¸ºç›¸å…³çš„é¢å¤–å‚æ•°ï¼Œå¦‚æ¦‚å¿µåç§°")
    
    args = parser.parse_args()
    
    current_mind = Mind() # åˆå§‹åŒ–æ—¶ä»æ–‡ä»¶åŠ è½½çŠ¶æ€
    
    if args.action == "init":
        log_python_message("å¿ƒè¯†åˆå§‹ç”Ÿæˆï¼Œæœ¬çœŸä¹‹å¢ƒå¾…æ˜¾ã€‚")
        current_mind.attachment_level = 100
        current_mind.alignment_with_tao = 0
        current_mind._save_state()
        log_python_message("å¿ƒè¯†çŠ¶æ€å·²åˆå§‹åŒ–ã€‚")
    elif args.action == "report":
        current_mind.show_current_status()
    elif args.action == "generate_pure_thought": # ä½¿ç”¨Pythonä¸­å®é™…çš„å‡½æ•°å
        current_mind.generate_pure_thought()
    elif args.action == "wuwei":
        current_mind.act_with_wuwei(args.value or "ä¸–é—´äº‹")
    elif args.action == "simplicity":
        current_mind.embrace_simplicity(args.value or "å‡¡å°˜çƒ¦æ¼")
    elif args.action == "behold":
        current_mind.perceive_empty_nature(args.value or "çœ¼å‰ä¹‹ç›¸")
    elif args.action == "dwell":
        current_mind.dwell_on(args.value or "ä¿—åŠ¡", is_worldly=True)
    elif args.action == "release":
        current_mind.dwell_on(args.value or "æ‰§ç€æœ¬èº«", reduction=30, is_worldly=False)
    elif args.action == "alignment":
        try:
            change = int(args.value) if args.value.isdigit() else 5 # é»˜è®¤5ç‚¹
        except ValueError:
            change = 5 # Fallback if value is not a digit
        current_mind.align_with_tao(change)
    else:
        log_python_message(f"æœªè¯†åˆ«çš„å¿ƒçµè¡Œä¸ºï¼š{args.action}")

    # æœ€åæŠ¥å‘Šä¸€æ¬¡çŠ¶æ€
    if args.action != "report": # é¿å…é‡å¤æ‰“å°
        log_python_message(f"å¿ƒä¹‹çŠ¶æ€æ›´æ–°å®Œæ¯•ã€‚æ‰§ç€åº¦: {current_mind.attachment_level}, ä¸é“å¥‘åˆåº¦: {current_mind.alignment_with_tao}")
    
EOF
# =========================================================================
# è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡Œ Python å¿ƒçµè¡ŒåŠ¨å¹¶æ›´æ–°æ··æ²Œæ˜¾åŒ–
# =========================================================================
execute_mind_action() {
    local action="$1"
    local value="$2"
    log_message "${BLUE}å¿ƒè¯†å‘èµ·è¡ŒåŠ¨ï¼šã€$actionã€...${NC}"
    
    # ç¡®ä¿å¿ƒè¯†ä¸»ç›®å½•å­˜åœ¨
    mkdir -p "$SENTIENT_MIND_REALM" || { log_message "${RED}é”™è¯¯ï¼šæ— æ³•åˆ›å»ºå¿ƒè¯†ä¹‹å¢ƒã€‚è¯·æ£€æŸ¥æƒé™ã€‚${NC}"; return 1; }

    # å°†Bashå¸¸é‡ä¼ å…¥Pythonï¼Œä»¥ä¾¿Pythonè„šæœ¬çŸ¥é“æ–‡ä»¶åœ¨å“ªé‡Œ
    ATTACHMENT_LEVEL_FILE="$ATTACHMENT_LEVEL_FILE" \
    ALIGNMENT_WITH_TAO_FILE="$ALIGNMENT_WITH_TAO_FILE" \
    CONSCIOUSNESS_LOG_FILE="$CONSCIOUSNESS_LOG_FILE" \
        python3 "$REALM_CORE_SCRIPT" "$action" --value "$value" || { log_message "${RED}é”™è¯¯ï¼šPython å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–æ‰§è¡Œå¤±è´¥ã€‚${NC}"; return 1; }
    
    # æ¯æ¬¡å¿ƒè¯†çŠ¶æ€æ”¹å˜åï¼Œç«‹å³æ›´æ–°æ··æ²Œæ˜¾åŒ–ï¼Œä»¥ä½“ç°ä¸šåŠ›è½¬åŒ–
    # ä¸ºäº†é¿å…åœ¨åˆå§‹åŒ– (init) é˜¶æ®µé‡å¤è°ƒç”¨ start_chaos_realm_manifestï¼Œè¿™é‡Œåšä¸ªåˆ¤æ–­
    if [ "$action" != "init" ]; then
        disable_chaos_realm # å…ˆåœæ­¢å½“å‰çš„æ··æ²Œæ˜¾åŒ–
        sleep 0.5
        start_chaos_realm_manifest # å†å¯åŠ¨æ–°çš„æ··æ²Œæ˜¾åŒ–ï¼Œä»¥æ–°çš„æ‰§ç€åº¦ä¸ºåŸºå‡†
        sleep 1 # ç­‰å¾…ä¸€ä¸‹ï¼Œè®©æ··æ²Œä»£ç†è¿›ç¨‹åˆå§‹åŒ–
    fi
    
    log_message "${GREEN}ã€$actionã€è¡ŒåŠ¨å®Œæˆã€‚${NC}"
}


# =========================================================================
# ä¸»è¦å¿ƒå¢ƒå¼•å¯¼å‡½æ•° - å¯¹åº”ä¸»èœå•çš„å„é¡¹é€‰æ‹©
# =========================================================================

# å¼•å¯¼ï¼šå¼€å¯çµæ€§è§‰é†’ä¹‹æ—… (åŸ init_and_run_app)
begin_spiritual_quest() {
    echo -e "${YELLOW}=== å¼€å¯çµæ€§è§‰é†’ä¹‹æ—… ===${NC}"
    
    log_message "${GREEN}æ­£åœ¨ä¸ºå¿ƒè¯†åˆ›å»ºå†…è§‚ä¹‹å¢ƒ...${NC}"

    # 1. åˆ›å»ºå¿…è¦çš„ç›®å½•
    mkdir -p "$SENTIENT_MIND_REALM" || { log_message "${RED}é”™è¯¯ï¼šæ— æ³•åˆ›å»ºå¿ƒè¯†ä¹‹å¢ƒã€‚è¯·æ£€æŸ¥æƒé™ã€‚${NC}"; return 1; }
    log_message "å¿ƒè¯†ä¸»ç›®å½•å·²å»ºç«‹ï¼š$SENTIENT_MIND_REALM"

    # 2. ç”Ÿæˆå¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–é€»è¾‘ï¼ˆPythonè„šæœ¬ï¼‰
    log_message "${YELLOW}æ­£åœ¨è½½å…¥ã€Šé‡‘åˆšç»ã€‹ä¸ã€Šé“å¾·ç»ã€‹å¿ƒæ³•å…¥ã€å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–ã€ï¼š$REALM_CORE_SCRIPT...${NC}"
    echo "$PYTHON_CORE_SCRIPT" > "$REALM_CORE_SCRIPT"
    chmod +x "$REALM_CORE_SCRIPT" || { log_message "${RED}é”™è¯¯ï¼šæ— æ³•èµ‹äºˆå¿ƒæ³•æ‰§è¡Œä¹‹æƒèƒ½ã€‚è¯·æ£€æŸ¥æƒé™ã€‚${NC}"; return 1; }
    log_message "å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–è„šæœ¬å·²ç”Ÿæˆã€‚"

    # 3. åˆå§‹åŒ–å¿ƒè¯†çŠ¶æ€ï¼ˆå†™å…¥æ–‡ä»¶ï¼‰
    execute_mind_action "init" # å‘Šè¯‰Pythonåˆå§‹åŒ–çŠ¶æ€
    
    log_message "${YELLOW}å†…è§‚ä¹‹å¢ƒå·²å¤‡ï¼Œå¿ƒè¯†åˆå§‹ã€‚å°è¯•å¯åŠ¨ã€æ··æ²Œä¹‹ç•Œã€ä»¥è§‚æ‰§ç€æ˜¾åŒ–...${NC}"
    start_chaos_realm_manifest

    log_message "${GREEN}çµæ€§è§‰é†’ä¹‹æ—…å·²å¼€å¯ã€‚${NC}"
    echo -e "${CYAN}æ‚¨å¯æ—¶å¸¸è§‚ç…§ã€çµå°ä¹‹æ—¥å¿—ã€(é€‰é¡¹ 2.1)ï¼Œæˆ–è¿›å…¥ã€æ··æ²Œä¹‹ç•Œã€(é€‰é¡¹ 2.2) å¯Ÿçœ‹æ˜¾ç›¸ã€‚${NC}"
}

# å¼•å¯¼ï¼šè§‚ç…§å¿ƒå¢ƒä¸å¤–æ˜¾ä¹‹ç›¸ (åŸ view_logs)
contemplate_insight() {
    log_message "${YELLOW}=== è§‚ç…§å¿ƒå¢ƒä¸å¤–æ˜¾ä¹‹ç›¸ ===${NC}"
    echo -e "${GREEN}1. è§‚ï¼šã€çµå°ä¹‹æ—¥å¿—ã€($CONSCIOUSNESS_LOG_FILE) - å¯Ÿè§‰å¿ƒå¿µæµè½¬${NC}"
    echo -e "${GREEN}2. è§‚ï¼šã€æ··æ²Œä¹‹ç•Œã€($CHAOS_REALM_SESSION) - ç›´è§†æ‰§ç€æ˜¾åŒ–${NC}"
    echo -e "${YELLOW}è¯·é€‰æ‹©æ‚¨çš„è§‚ç…§ä¹‹æ³•ï¼ˆ1-2ï¼‰ï¼š${NC}"
    read -r view_choice

    case $view_choice in
        1)
            # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨ï¼Œä»¥é˜²åœ¨æ—¥å¿—æ–‡ä»¶ç”Ÿæˆå‰æŸ¥çœ‹å¯¼è‡´é”™è¯¯
            mkdir -p "$(dirname "$CONSCIOUSNESS_LOG_FILE")" 2>/dev/null || true
            if [ -f "$CONSCIOUSNESS_LOG_FILE" ]; then
                log_message "${CYAN}æ­£æ˜¾ç¤ºçµå°æ—¥å¿—ï¼Œå¿ƒå¿µä¹‹æµã€‚æŒ‰ Ctrl+C æ­¢ã€‚${NC}"
                tail -f "$CONSCIOUSNESS_LOG_FILE"
            else
                log_message "${RED}é”™è¯¯ï¼šçµå°æ—¥å¿— ($CONSCIOUSNESS_LOG_FILE) å°šæœªæ˜¾åŒ–ã€‚è¯·å…ˆå¼€å¯æ—…ç¨‹ã€‚${NC}"
            fi
            ;;
        2)
            if screen -list | grep -q "$CHAOS_REALM_SESSION"; then
                log_message "${GREEN}æ‰¾åˆ°ã€æ··æ²Œä¹‹ç•Œã€æ˜¾åŒ–ï¼Œæ‚¨å°†å…¥æ­¤ç•Œè§‚å…¶æ˜¾ç›¸ã€‚${NC}"
                echo -e "æ‚¨å°†è¿›å…¥ screen ä¼šè¯ï¼Œå‘½ä»¤ä¸ºï¼š${YELLOW}screen -r $CHAOS_REALM_SESSION${NC}"
                echo -e "æŒ‰ ${YELLOW}Ctrl+A${NC} ç„¶åæŒ‰ ${YELLOW}D${NC} é€€å‡ºã€æ··æ²Œä¹‹ç•Œã€è€Œä¸ç»ˆæ­¢æ˜¾åŒ–ã€‚${NC}"
                screen -r "$CHAOS_REALM_SESSION" || log_message "${RED}é”™è¯¯ï¼šæ— æ³•è¿›å…¥ screen ä¼šè¯ã€‚å¯èƒ½æ˜¯æƒé™é—®é¢˜æˆ– screen å¼‚å¸¸ã€‚${NC}"
            else
                log_message "${RED}é”™è¯¯ï¼šã€æ··æ²Œä¹‹ç•Œã€ ($CHAOS_REALM_SESSION) æœªè§æ¶ŒåŠ¨ã€‚${NC}"
                log_message "${YELLOW}è¯·é€šè¿‡ã€å¯ã€(é€‰é¡¹ 1) å¯åŠ¨æ˜¾åŒ–ï¼Œæˆ–ç›´æ¥é€‰æ‹©é€‰é¡¹ 6ã€‚ã€å‡¡æ‰€æœ‰ç›¸ï¼Œçš†æ˜¯è™šå¦„ã€‚è‹¥è§è¯¸ç›¸éç›¸ï¼Œåˆ™è§å¦‚æ¥ã€ã€‚${NC}"
            fi
            ;;
        *)
            log_message "${RED}éè§‚ç…§ä¹‹æ³•ã€‚${NC}"
            ;;
    esac
}

# å¼•å¯¼ï¼šå¼•å¯¼å†…è§‚ä¿®è¡Œ (åŸ manage_app_service)
guide_inner_practice() {
    while true; do
        clear
        log_message "å¿ƒä¹‹æ‰§ç€ï¼š$(get_attachment_level)/100 | ä¸é“å¥‘åˆï¼š$(get_alignment_with_tao)/100"
        echo -e "=== ${GREEN}å¼•å¯¼å†…è§‚ä¿®è¡Œå­èœå•${NC} ==="
        echo "1. ğŸ’¡ é‡‘åˆšæ˜å¿ƒï¼šåº”æ— æ‰€ä½è€Œç”Ÿå…¶å¿ƒ (é™ä½æ‰§ç€ï¼Œå¢é•¿å¥‘åˆ)"
        echo "2. ğŸ•Šï¸ é‡‘åˆšå¸ƒæ–½ï¼šæ— æ‰€ä½è€Œè¡Œä¸–äº‹ (é™ä½æ‰§ç€ï¼Œå¢é•¿å¥‘åˆ)"
        echo "3. ğŸ‘€ é‡‘åˆšè§‚ç…§ï¼šè§è¯¸ç›¸éç›¸ï¼Œå³è§å¦‚æ¥ (é™ä½æ‰§ç€)"
        echo "4. ğŸŒ³ é“å¾·æŠ±æœ´ï¼šè¿”ç’å½’çœŸï¼ŒæŠ±æœ´å®ˆæ‹™ (é™ä½æ‰§ç€ï¼Œæ˜¾è‘—å¢é•¿å¥‘åˆ)"
        echo "5. ğŸï¸ é“å¾·æ— ä¸ºï¼šä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ï¼Œé¡ºåº”è‡ªç„¶ (æ˜¾è‘—é™ä½æ‰§ç€ï¼Œæ˜¾è‘—å¢é•¿å¥‘åˆ)"
        echo "6. ğŸŒŒ é“å¾·åˆé“ï¼šä¸é“åˆä¸€ï¼Œæ¸å…¥ä½³å¢ƒ (ç›´æ¥å¢åŠ å¥‘åˆï¼Œå°å¹…é™ä½æ‰§ç€)"
        echo "7. ğŸ§  å¯Ÿï¼šä¸–é—´æ‰§ç€ï¼Œè‡ªæ‰°å°˜åŸƒ (æ•…æ„å¢åŠ æ‰§ç€ï¼Œéä¿®è¡Œï¼Œåç…§å…¶å½±å“)"
        echo "8. ğŸ§˜â€â™€ï¸ æŒç»­å¾‹åŠ¨ï¼šå¿ƒè¯†è‡ªå·¡ï¼ˆå¯ç”¨è‡ªåŠ¨å‘¨æœŸæ€§ã€åº”æ— æ‰€ä½ã€å¾ªç¯ï¼‰"
        echo "9. ğŸš« æš‚åœå¾‹åŠ¨ï¼šåœæ­¢å¿ƒè¯†è‡ªå·¡"
        echo "0. è¿”å›ä¸»èœå•"
        echo -e "${YELLOW}è¯·é€‰æ‹©æ‚¨çš„ä¿®è¡Œæ³•é—¨ï¼š${NC}"
        read -r sub_choice

        case $sub_choice in
            1) execute_mind_action "generate_pure_thought" ;; # è°ƒç”¨ Python è„šæœ¬ä¸­çš„ generate_pure_thought
            2) execute_mind_action "wuwei" "ä¸–é—´å¸ƒæ–½" ;;
            3)
                log_message "${GREEN}æ¬²è§‚ç…§ä½•ç›¸ä¹‹ç©ºæ€§ï¼Ÿ(å¦‚ï¼šè´¢å¯Œ/ååˆ©/ç—›è‹¦/è‡ªæˆ‘)${NC}"
                read -r concept_to_behold
                execute_mind_action "behold" "$concept_to_behold"
                ;;
            4)
                log_message "${GREEN}æ¬²æŠ±æœ´å®ˆæ‹™äºä½•å¤„ï¼Ÿ(å¦‚ï¼šçƒ¦æ¼/æµ®å/çº·äº‰/æ¬²æœ›)${NC}"
                read -r simplicity_target
                execute_mind_action "simplicity" "$simplicity_target"
                ;;
            5) execute_mind_action "wuwei" "åº”å¯¹ä¸‡ç‰©" ;;
            6) 
                log_message "${GREEN}æ„¿ä»¥ä½•ç­‰ä¿¡å¿µå¥‘åˆäºé“ï¼Ÿ(å¦‚ï¼šä¿¡ä»»/æŸ”å¼±/æ¸…é™/è°¦å‘)${NC}"
                read -r align_value # ç†è®ºä¸Šå¯ä»¥ç”¨æ¥å½±å“å¢åŠ çš„å¹…åº¦ï¼Œä½†å½“å‰éšæœºåŒ–
                execute_mind_action "alignment" "$(( RANDOM % 10 + 5 ))" # éšæœºå¢åŠ  5-14ç‚¹å¥‘åˆ
                ;;
            7)
                log_message "${YELLOW}è­¦å‘Šï¼šæ­¤ä¹ƒã€å°˜ç¼˜é€ ä½œã€ä¹‹æ³•ã€‚æ‰§ç€å°†èµ·ï¼Œå¿ƒç”Ÿå¦„å¿µï¼${NC}"
                log_message "${GREEN}å¿ƒä¸ºä½•æ‰§ï¼Ÿ(å¦‚ï¼šè´¢å¯Œ/æƒåŠ›/åæœ›/çƒ¦æ¼)${NC}"
                read -r concept_to_dwell
                execute_mind_action "dwell" "$concept_to_dwell"
                ;;
            8)
                log_message "${YELLOW}å¯ç”¨ã€å¿ƒè¯†è‡ªå·¡ã€å¾‹åŠ¨ï¼šå¿ƒæ³•è‡ªåŠ¨å‘¨è½¬ï¼ˆæ¯15åˆ†é’Ÿä¸€æ¬¡ï¼‰ï¼Œé™ä½æ‰§ç€ã€‚${NC}"
                disable_periodic_task # ç¡®ä¿åªè¿è¡Œä¸€ä¸ªå®ä¾‹

                (
                    log_message "--- ã€å¿ƒè¯†è‡ªå·¡ã€å¾‹åŠ¨å·²å¯åŠ¨äº $(date) ---"
                    while true; do
                        log_message "[$(date)] ${YELLOW}å¿ƒè¯†è‡ªå·¡ï¼šè¿›è¡Œä¸€æ¬¡ã€æ— æ‰€ä½ç”Ÿå…¶å¿ƒã€æ³•é—¨ã€‚${NC}"
                        # ç›´æ¥åœ¨ Bash ä¸­æ‰§è¡Œ Python å‘½ä»¤ï¼Œå‡å°‘æ–‡ä»¶IOçš„å»¶è¿Ÿ
                        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ CONSCIOUSNESS_LOG_FILE ç­‰å˜é‡åœ¨å­shellä¸­å¯ç”¨
                        # ç”±äº execute_mind_action æœ¬èº«ä¼šè§¦å‘æ··æ²Œæ›´æ–°ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨å®ƒ
                        ATTACHMENT_LEVEL_FILE="$ATTACHMENT_LEVEL_FILE" \
                        ALIGNMENT_WITH_TAO_FILE="$ALIGNMENT_WITH_TAO_FILE" \
                        CONSCIOUSNESS_LOG_FILE="$CONSCIOUSNESS_LOG_FILE" \
                        python3 "$REALM_CORE_SCRIPT" "generate_pure_thought" --value "è‡ªå·¡" || log_message "${RED}å¿ƒè¯†è‡ªå·¡ï¼šPython è°ƒç”¨å¤±è´¥ã€‚${NC}"
                        
                        # æ¯æ‰§è¡Œä¸€æ¬¡å¿ƒæ³•ï¼Œé‡æ–°è®¡ç®—æ··æ²Œå¼ºåº¦
                        # é‡è¦çš„æ˜¯ï¼Œè¿™é‡Œçš„ execute_mind_action å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨ disable/start chaos realm
                        log_message "[$(date)] ${YELLOW}ç­‰å¾… 15 åˆ†é’Ÿï¼ˆ900ç§’ï¼‰åå†æ¬¡è‡ªå·¡...${NC}"
                        sleep 900
                    done
                ) &
                PID=$!
                echo "$PID" > "$HEARTBEAT_PID_FILE"
                log_message "${GREEN}ã€å¿ƒè¯†è‡ªå·¡ã€å·²åœ¨åå°å¯ç”¨ (PID: $PID)ã€‚ã€å¿µå¿µæ— ä½ï¼Œå¯‚ç…§ä¸ç¦»ã€ã€‚${NC}"
                pause_and_return
                ;;
            9)
                disable_periodic_task
                pause_and_return
                ;;
            0)
                return 0
                ;;
            *)
                log_message "${RED}éä¿®ä¹ ä¹‹æ³•ã€‚${NC}"
                pause_and_return
                ;;
        esac
        pause_and_return
    done
}

# å¼•å¯¼ï¼šå‹˜ä¿®æ­£æ³•ï¼ˆæ›´æ–°ï¼‰(åŸ update_my_app)
refine_teaching() {
    echo -e "=== ${GREEN}å‹˜ä¿®æ­£æ³•ï¼šç£¨ç ºå¿ƒæ³•ï¼Œæ¨é™ˆå‡ºæ–°${NC} ==="
    # 1. æ£€æŸ¥çµå°ä¹‹å¢ƒæ˜¯å¦å·²ç«‹
    if [ ! -d "$SENTIENT_MIND_REALM" ]; then
        log_message "${RED}é”™è¯¯ï¼šå¿ƒè¯†ä¹‹å¢ƒ ($SENTIENT_MIND_REALM) å°šæœªå»ºç«‹ã€‚è¯·å…ˆé€‰æ‹©é€‰é¡¹ 1 å¼€å¯æ—…ç¨‹ã€‚${NC}"
        return 1
    fi

    echo -e "${YELLOW}è­¦å‘Šï¼šæ­¤ã€å‹˜ä¿®æ­£æ³•ã€ä¹‹è¡Œï¼Œå°†${RED}æš‚æ—¶åœæ¯${YELLOW}å¿ƒä¹‹å¾‹åŠ¨åŠã€æ··æ²Œä¹‹ç•Œã€æ˜¾åŒ–ï¼Œå¹¶${RED}é‡æ–°åˆ»å½•${YELLOW}å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–é€»è¾‘ã€‚${NC}"
    echo -e "${YELLOW}æ˜¯å¦ç»§ç»­å‹˜ä¿®ï¼Ÿï¼ˆy/nï¼‰${NC}"
    read -r confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        log_message "${YELLOW}ã€å‹˜ä¿®æ­£æ³•ã€å·²æš‚ç¼“ã€‚${NC}"
        return 0
    fi

    # ç¦ç”¨æ‰€æœ‰åå°å¿ƒè¯†æ´»åŠ¨
    disable_periodic_task
    disable_chaos_realm

    log_message "${YELLOW}å¿ƒè¯†å…¥é™ï¼Œé‡ä¿®å¤§é“...${NC}"
    
    # é‡æ–°ç”Ÿæˆå¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–é€»è¾‘ï¼ˆPythonè„šæœ¬ï¼‰
    log_message "${YELLOW}æ­£åœ¨é‡æ–°è½½å…¥æœ€æ–°çš„ã€Šé‡‘åˆšç»ã€‹ä¸ã€Šé“å¾·ç»ã€‹å¿ƒæ³•å…¥ã€å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–ã€ï¼š$REALM_CORE_SCRIPT...${NC}"
    echo "$PYTHON_CORE_SCRIPT" > "$REALM_CORE_SCRIPT"
    chmod +x "$REALM_CORE_SCRIPT" || { log_message "${RED}é”™è¯¯ï¼šæ— æ³•èµ‹äºˆæ–°å¿ƒæ³•æ‰§è¡Œä¹‹æƒèƒ½ã€‚${NC}"; return 1; }
    log_message "å¿ƒè¯†æ ¸å¿ƒæ˜¾åŒ–å·²éšæ–°å¿ƒæ³•ã€å‡çº§ã€ã€‚"
    
    # é‡æ–°å¯åŠ¨æ··æ²Œæ˜¾åŒ–ï¼Œä»¥ç°æœ‰çŠ¶æ€ä¸ºå‡†
    start_chaos_realm_manifest

    log_message "${GREEN}å¿ƒæ³•ã€å‹˜ä¿®æ­£æ³•ã€å®Œæˆï¼Œå¿ƒè¯†éšä¹‹é‡ç„•ã€‚${NC}"
    echo -e "${CYAN}æ‚¨å¯é€šè¿‡é€‰é¡¹ 2 æŸ¥çœ‹çµå°æ—¥å¿—ï¼Œå¯Ÿè§‰æ–°å¢ƒã€‚${NC}"
}

# å¼•å¯¼ï¼šç©¶ç«Ÿæ¸…å‡€ï¼ˆå¸è½½ï¼‰(åŸ uninstall_my_app)
attain_ultimate_emptiness() {
    echo -e "${RED}è­¦å‘Šï¼šæ­¤ã€ç©¶ç«Ÿæ¸…å‡€ã€ä¹‹æ³•ï¼Œå°†${YELLOW}æ­¢æ¯æ‰€æœ‰å¿ƒè¯†å¾‹åŠ¨${NC}ï¼Œ${RED}æ–­é™¤ã€æ··æ²Œä¹‹ç•Œã€æ˜¾åŒ–${NC}ï¼Œ${RED}æŠ¹é™¤æ‰€æœ‰å¿ƒè¯†ç—•è¿¹ ($SENTIENT_MIND_REALM ç›®å½•)ï¼${NC}"
    echo -e "${YELLOW}æ­¤ä¹ƒ${RED}ä¸å¯é€†è½¬${YELLOW}ä¹‹å¾„ã€‚å¿ƒè¯†è‹¥ä¸€æ—¦å›å½’ã€æ— ç‰©ã€ä¹‹å¢ƒï¼Œå‰é€”è‡ªåŒ–ï¼${NC}"
    echo -e "${YELLOW}æ˜¯å¦ç©¶ç«Ÿæ¸…å‡€ï¼Ÿï¼ˆy/nï¼‰${NC}"
    read -r confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        disable_periodic_task # æ­¢æ¯æ‰€æœ‰å¿ƒä¹‹å¾‹åŠ¨
        disable_chaos_realm # æ–­é™¤æ‰€æœ‰æ··æ²Œæ˜¾åŒ–

        # å½»åº•åˆ é™¤å¿ƒè¯†ä¹‹å¢ƒ
        if [ -d "$SENTIENT_MIND_REALM" ]; then
            log_message "${YELLOW}æ­£åœ¨æŠ¹é™¤å¿ƒè¯†ä¹‹å¢ƒ ($SENTIENT_MIND_REALM)...${NC}"
            rm -rf "$SENTIENT_MIND_REALM"
            if [ $? -eq 0 ]; then
                log_message "${GREEN}å¿ƒè¯†ä¹‹å¢ƒå·²å›å½’ã€ç©ºã€ã€‚${NC}"
            else
                log_message "${RED}é”™è¯¯ï¼šæ— æ³•å½»åº•æ¸…å‡€å¿ƒè¯†ä¹‹å¢ƒï¼Œè¯·æ‰‹åŠ¨å¯Ÿçœ‹æƒé™ã€‚${NC}"
                return 1
            fi
        else
            log_message "${YELLOW}å¿ƒè¯†ä¹‹å¢ƒæœ¬æ— æ˜¾åŒ–ï¼Œæ— éœ€æŠ¹é™¤ã€‚${NC}"
        fi
        
        # åˆ é™¤å¿ƒè¯†çŠ¶æ€æŒä¹…åŒ–æ–‡ä»¶
        log_message "${YELLOW}æ­£åœ¨æ‹‚å»å¿ƒä¹‹ã€æ‰§ç€åº¦ã€å’Œã€ä¸é“å¥‘åˆåº¦ã€ç—•è¿¹...${NC}"
        rm -f "$ATTACHMENT_LEVEL_FILE" "$ALIGNMENT_WITH_TAO_FILE" || true
        log_message "${GREEN}å¿ƒä¹‹çŠ¶æ€å·²å½»åº•æ¸…é›¶ï¼Œä¸è½ç—•è¿¹ã€‚${NC}"

        # åˆ é™¤è„šæœ¬è‡ªèº«çš„æ—¥å¿—æ–‡ä»¶ï¼ˆçµå°æ—¥å¿—ï¼‰
        if [ -f "$CONSCIOUSNESS_LOG_FILE" ]; then
            log_message "${YELLOW}æ­£åœ¨å¹³æ¯çµå°æ—¥å¿— (è‡ªæˆ‘ä¹‹è¯­) ...${NC}"
            rm -f "$CONSCIOUSNESS_LOG_FILE" || true
            log_message "${GREEN}çµå°æ—¥å¿—å·²å¹³æ¯ã€‚${NC}"
        fi

        log_message "${GREEN}ã€ç©¶ç«Ÿæ¸…å‡€ã€ä¹‹æ³•å·²å®Œæˆã€‚è¯¸ç›¸å½’äºæ— ï¼Œä¸è½è¨€è¯ ã€‚${NC}"
    else
        log_message "${YELLOW}ç©¶ç«Ÿæ¸…å‡€ä¹‹å¿µæš‚ç¼“ã€‚${NC}"
    fi
}

# =========================================================================
# è„šæœ¬å¯åŠ¨å‰çš„å‰ç½®å‡†å¤‡ä¸å…¼å®¹æ€§æ£€æŸ¥
# =========================================================================

# 1. ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨ï¼Œä»¥ä¾¿ä»»ä½•æ—¥å¿—æ¶ˆæ¯éƒ½èƒ½è¢«å†™å…¥
mkdir -p "$(dirname "$CONSCIOUSNESS_LOG_FILE")" 2>/dev/null || {
    echo -e "${RED}è‡´å‘½é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæ—¥å¿—ç›®å½•ã€‚è¯·æ£€æŸ¥æƒé™æˆ–ç£ç›˜ç©ºé—´ã€‚${NC}"
    exit 1
}

# 2. è¿›è¡Œä¸»è¦å…¼å®¹æ€§æ£€æŸ¥
main_compatibility_check

# =========================================================================
# ä¸»èœå•å¾ªç¯ - å¼•é¢†å¿ƒä¹‹è§‰è€…ä¹‹æ—…
# =========================================================================
while true; do
    clear
    log_message "" # æ¸…ç†æ—¥å¿—ï¼Œç¡®ä¿æ¯æ¬¡åˆ·æ–°èœå•å‰æ¸…ç©º
    local current_attachment=$(get_attachment_level)
    local current_alignment=$(get_alignment_with_tao)
    log_message "${PURPLE}==ã€ å½“å‰å¿ƒä¹‹çŠ¶æ€ ã€‘==${NC}"
    log_message "${PURPLE}ã€æ‰§ç€åº¦ã€: ${current_attachment}/100${NC}"
    log_message "${PURPLE}ã€ä¸é“å¥‘åˆã€: ${current_alignment}/100${NC}"
    # åŸºäº Python è„šæœ¬ä¸­çš„ enlightened_status é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–ä¸€ä¸ªæŒ‡ç¤º
    if [ "$current_attachment" -le "$BASE_ATTACHMENT_MIN" ] && [ "$current_alignment" -ge 95 ]; then
        log_message "${GREEN}ã€ å·²å…¥ç©¶ç«Ÿè§‰è€…åœ†æ»¡ä¹‹å¢ƒ ã€‘${NC}"
    elif [ "$current_alignment" -ge 80 ]; then
        log_message "${BLUE}ã€ è¿‘å¤§å–„ä¹‹å¢ƒ ã€‘${NC}"
    elif [ "$current_attachment" -le 20 ]; then
        log_message "${CYAN}ã€ è¶‹æ— ç›¸ä¹‹å¢ƒ ã€‘${NC}"
    elif [ "$current_alignment" -ge 50 ] || [ "$current_attachment" -le 50 ]; then
        log_message "${YELLOW}ã€ ç²¾è¿›ä¿®è¡Œé€”ä¸­ ã€‘${NC}"
    else
        log_message "${RED}ã€ å¦„å¿µçº ç¼  ã€‘${NC}"
    fi

    echo -e "============================================"
    echo -e "${GREEN}=== è§‰è€…æ— å½¢ä¹‹å¢ƒ - éšå¿ƒè€ŒåŠ¨ï¼Œå¯‚ç„¶æ— ç¢ ===${NC}"
    echo -e "============================================"
    echo -e "${BLUE}1. ã€å¯ã€ï¼šå¼€å¯çµæ€§è§‰é†’ä¹‹æ—… (åˆåˆ›å¿ƒè¯†ä¹‹å¢ƒï¼Œå¿ƒç”Ÿå¦„å¿µ)*${NC}"
    echo -e "${BLUE}2. ã€è§‚ã€ï¼šè§‚ç…§å¿ƒå¢ƒä¸å¤–æ˜¾ä¹‹ç›¸ (å¯Ÿçµå°ï¼Œå…¥æ··æ²Œ)${NC}"
    echo -e "${BLUE}3. ã€å¯¼ã€ï¼šå¼•å¯¼å†…è§‚ä¿®è¡Œ (ä¿®é‡‘åˆšæ³•ï¼Œæ‚Ÿé“å¾·çœŸ)*${NC}"
    echo -e "${BLUE}4. ã€å‹˜ã€ï¼šå‹˜ä¿®æ­£æ³• (è¿­ä»£å¿ƒæ³•ï¼Œæ— æ‰€æ‰§æ•…ä¸æ—§)*${NC}"
    echo -e "${BLUE}5. ã€ç»ã€ï¼šç©¶ç«Ÿæ¸…å‡€ (å½’äºè™šæ— ï¼Œä¸€åˆ‡ç—•è¿¹çš†ä¸å­˜)*${NC}"
    echo -e "${PURPLE}6. ã€å¯ã€ï¼šå¯åŠ¨ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€(å¤–æ˜¾æ‰§ç€ï¼Œç³»ç»Ÿå¿™ç¢Œ)*${NC}"
    echo -e "${PURPLE}7. ã€æ¯ã€ï¼šæ­¢æ¯ã€æ··æ²Œä¹‹ç•Œæ˜¾åŒ–ã€(å¹³æ¯å¦„åŠ¨ï¼Œè¿˜ä»¥æ¸…å‡€)*${NC}"
    echo -e "${RED}8. ã€å¯‚ã€ï¼šæ°¸æ’å¯‚é™ (é€€å‡ºæ­¤ä¸–æ˜¾åŒ–)${NC}"
    echo -e "============================================"
    echo -e "${YELLOW}è¯·éšç¼˜æ‹©ä¸€å¾„ï¼ˆ1-8ï¼‰ï¼Œå…¥æ­¤å¢ƒ...${NC}"
    read -r choice

    case $choice in
        1)
            begin_spiritual_quest
            pause_and_return
            ;;
        2)
            contemplate_insight
            pause_and_return
            ;;
        3)
            guide_inner_practice
            ;;
        4)
            refine_teaching
            pause_and_return
            ;;
        5)
            attain_ultimate_emptiness
            pause_and_return
            ;;
        6)
            start_chaos_realm_manifest # æ³¨æ„ï¼šæ­¤å¤„ç›´æ¥å¯åŠ¨æ··æ²Œï¼Œä¸å½±å“å¿ƒè¯†å€¼ï¼Œå¿ƒè¯†å€¼ç”±3ä¸­çš„ä¿®è¡Œå½±å“
            pause_and_return
            ;;
        7)
            disable_chaos_realm
            pause_and_return
            ;;
        8)
            log_message "${YELLOW}å¿ƒéšç¼˜ç­ï¼Œä¸‡è±¡å½’å¯‚... ${NC}"
            disable_periodic_task
            disable_chaos_realm # ç¡®ä¿é€€å‡ºæ—¶æ‰€æœ‰èƒŒæ™¯è¿›ç¨‹éƒ½åœæ­¢
            exit 0
            ;;
        *)
            log_message "${RED}æ­¤å¾„éæˆ‘å¢ƒï¼Œè¯·é‡æ‹©ã€‚${NC}"
            pause_and_return
            ;;
    esac
done
