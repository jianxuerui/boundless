#!/bin/bash

#================================================================================
# Nexus Network 魔改管理脚本 v5.0 - 节点中心版
#
# 功能:
#   - 菜单界面优化，突出“节点”概念。
#   - 新增“配置/上线节点”指引选项。
#   - 自动检测架构 (x86_64 / aarch64) 并下载对应程序。
#   - 提供完整的节点软件安装、卸载及服务管理功能。
#
# 作者: Your Name/AI Assistant
# 版本: 5.0
#================================================================================

# --- 全局变量定义 ---
readonly URL_ARM64="https://github.com/nexus-xyz/nexus-cli/releases/download/v0.10.8/nexus-network-linux-arm64"
readonly URL_X86_64="https://github.com/nexus-xyz/nexus-cli/releases/download/v0.10.8/nexus-network-linux-x86_64"

# 动态变量
URL=""
DETECTED_ARCH=""

# 固定变量
readonly BINARY_NAME="nexus-network"
readonly INSTALL_DIR="/usr/local/bin"
readonly CONFIG_DIR="/etc/nexus-network"
readonly SERVICE_NAME="nexus-network"
readonly SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
readonly RUN_USER="nexus-user"

# --- 颜色定义 ---
readonly C_RED='\033[0;31m'
readonly C_GREEN='\033[0;32m'
readonly C_YELLOW='\033[0;33m'
readonly C_BLUE='\033[0;34m'
readonly C_NC='\033[0m' # No Color

# --- 辅助函数 ---
_log() { local color="$1"; local message="$2"; echo -e "${color}${message}${C_NC}"; }
pause() { read -rp "按 [Enter] 键返回菜单..."; }
check_root() { if [[ "$(id -u)" -ne 0 ]]; then _log "$C_RED" "错误: 此脚本必须以 root 权限运行。"; exit 1; fi; }
is_installed() { if [[ -f "$SERVICE_FILE" ]]; then return 0; else return 1; fi; }

# 检查环境并设置URL
check_env() {
    if ! grep -q -i "centos stream release 8" /etc/centos-release; then
        _log "$C_YELLOW" "警告: 此脚本专为 CentOS 8 设计，您的系统可能不兼容。"
    fi
    DETECTED_ARCH=$(uname -m)
    case "$DETECTED_ARCH" in
        "aarch64") URL="$URL_ARM64" ;;
        "x86_64") URL="$URL_X86_64" ;;
        *) _log "$C_RED" "错误: 不支持的系统架构 '$DETECTED_ARCH'。"; exit 1 ;;
    esac
}

# --- 核心功能函数 ---

# 1. 安装节点软件
install_nexus() {
    _log "$C_BLUE" "--- 开始安装 Nexus Network 节点软件 ---"
    if is_installed; then _log "$C_YELLOW" "节点软件已安装。如需重装，请先卸载。"; return; fi
    _log "$C_BLUE" "[1/7] 检查并安装依赖 (wget)..."; dnf install -y wget > /dev/null 2>&1
    _log "$C_BLUE" "[2/7] 创建系统用户 '${RUN_USER}'..."; if ! id -u "${RUN_USER}" >/dev/null 2>&1; then useradd -r -m -s /bin/false "${RUN_USER}"; fi
    _log "$C_BLUE" "[3/7] 创建配置目录 '${CONFIG_DIR}'..."; mkdir -p "${CONFIG_DIR}"; chown -R "${RUN_USER}:${RUN_USER}" "${CONFIG_DIR}"
    _log "$C_BLUE" "[4/7] 下载节点程序 (架构: ${DETECTED_ARCH})..."; wget --no-check-certificate -O "${INSTALL_DIR}/${BINARY_NAME}" "$URL" || { _log "$C_RED" "下载失败！"; return; }
    _log "$C_BLUE" "[5/7] 设置文件权限..."; chmod +x "${INSTALL_DIR}/${BINARY_NAME}"
    _log "$C_BLUE" "[6/7] 创建 systemd 服务..."; create_systemd_service
    _log "$C_BLUE" "[7/7] 重载 systemd 并设置开机自启..."; systemctl daemon-reload; systemctl enable "${SERVICE_NAME}"
    _log "$C_GREEN" "--- 节点软件安装成功！ ---"
    _log "$C_YELLOW" "下一步：请使用菜单选项 '2' 查看配置指引，然后启动节点。"
}

# (新功能) 2. 配置/上线节点 指引
configure_node_guide() {
    _log "$C_BLUE" "--- 节点配置与上线指引 ---"
    if ! is_installed; then
        _log "$C_RED" "错误: 节点软件尚未安装。请先执行安装。"
        return
    fi
    echo
    _log "$C_GREEN" "节点软件安装后，通常需要您手动进行配置才能成功上线。"
    _log "$C_YELLOW" "1. 主要配置文件目录位于: ${CONFIG_DIR}"
    _log "$C_YELLOW" "2. 请根据官方文档，编辑该目录下的配置文件 (例如 config.toml, keys.json 等)。"
    _log "$C_YELLOW" "   - 您可能需要填入您的节点密钥、API令牌或其他身份信息。"
    _log "$C_YELLOW" "3. 如果项目提供了 'onboarder' 或类似的注册工具，请按文档说明使用。"
    echo
    _log "$C_BLUE" "配置完成后，请返回主菜单，使用 '启动节点/服务' 选项来运行您的节点。"
    echo
}


# 3. 卸载节点软件
uninstall_nexus() {
    _log "$C_BLUE" "--- 开始卸载 Nexus Network 节点软件 ---"
    if ! is_installed; then _log "$C_YELLOW" "节点软件未安装。"; return; fi
    read -rp "您确定要完全卸载吗？[y/N]: " confirm && [[ "${confirm,,}" != "y" ]] && { _log "$C_YELLOW" "操作已取消。"; return; }
    systemctl stop "${SERVICE_NAME}" >/dev/null 2>&1; systemctl disable "${SERVICE_NAME}" >/dev/null 2>&1
    rm -f "$SERVICE_FILE"; systemctl daemon-reload
    rm -f "${INSTALL_DIR}/${BINARY_NAME}"
    _log "$C_BLUE" "核心程序和服务已删除。"
    read -rp "是否删除配置文件 (${CONFIG_DIR}) 和用户 (${RUN_USER})？[y/N]: " confirm_data
    if [[ "${confirm_data,,}" == "y" ]]; then
        rm -rf "${CONFIG_DIR}"; userdel -r "${RUN_USER}" >/dev/null 2>&1
        _log "$C_BLUE" "配置文件和用户已一并删除。"
    fi
    _log "$C_GREEN" "--- 卸载完成 ---"
}

create_systemd_service() {
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Nexus Network Service
After=network.target
[Service]
Type=simple
User=${RUN_USER}
Group=${RUN_USER}
ExecStart=${INSTALL_DIR}/${BINARY_NAME} --config-dir=${CONFIG_DIR}
Restart=on-failure
RestartSec=10
LimitNOFILE=65535
[Install]
WantedBy=multi-user.target
EOF
}

# --- 服务管理函数 ---
start_service()   { if is_installed; then systemctl start "${SERVICE_NAME}";   _log "$C_GREEN" "启动命令已发送。"; else _log "$C_RED" "请先安装节点软件。"; fi; }
stop_service()    { if is_installed; then systemctl stop "${SERVICE_NAME}";    _log "$C_GREEN" "节点已停止。";     else _log "$C_RED" "请先安装节点软件。"; fi; }
restart_service() { if is_installed; then systemctl restart "${SERVICE_NAME}"; _log "$C_GREEN" "重启命令已发送。"; else _log "$C_RED" "请先安装节点软件。"; fi; }
status_service()  { if is_installed; then systemctl status "${SERVICE_NAME}";  else _log "$C_RED" "请先安装节点软件。"; fi; }
view_logs()       { if is_installed; then journalctl -u "${SERVICE_NAME}" -n 100 --no-pager -f; else _log "$C_RED" "请先安装节点软件。"; fi; }

# --- 菜单界面 ---
show_menu() {
    clear
    echo "========================================================"
    echo "          Nexus Network 节点管理脚本 (v5.0)"
    echo -e "        (当前架构: ${C_GREEN}${DETECTED_ARCH}${C_NC})"
    echo "========================================================"
    if is_installed; then
        _log "$C_GREEN" "      节点软件状态: 已安装"
        local status
        status=$(systemctl is-active "$SERVICE_NAME")
        if [[ "$status" == "active" ]]; then
             _log "$C_GREEN" "      节点运行状态: 运行中"
        else
             _log "$C_YELLOW" "      节点运行状态: 已停止"
        fi
    else
        _log "$C_YELLOW" "      节点软件状态: 未安装"
    fi
    echo "--------------------------------------------------------"
    echo " [节点部署]"
    echo "   1. 安装节点软件 (程序和服务)"
    echo "   2. 配置/上线节点 (提供指引)"
    echo "   3. 卸载节点软件"
    echo "--------------------------------------------------------"
    echo " [节点运维]"
    echo "   4. 启动节点/服务       7. 重启节点/服务"
    echo "   5. 停止节点/服务       8. 查看节点日志"
    echo "   6. 查看节点状态"
    echo "--------------------------------------------------------"
    echo "   0. 退出脚本"
    echo "========================================================"
}

# --- 主循环 ---
main() {
    check_root
    check_env
    
    while true; do
        show_menu
        read -rp "请输入选项 [0-8]: " choice

        case "$choice" in
            1) install_nexus; pause ;;
            2) configure_node_guide; pause ;;
            3) uninstall_nexus; pause ;;
            4) start_service; pause ;;
            5) stop_service; pause ;;
            6) status_service; pause ;;
            7) restart_service; pause ;;
            8 | l) view_logs ;; # l for logs
            0) _log "$C_BLUE" "感谢使用，脚本已退出。"; exit 0 ;;
            *) _log "$C_RED" "无效的选项，请输入 0-8 之间的数字。"; pause ;;
        esac
    done
}

# --- 脚本入口 ---
main
