#!/bin/bash

#================================================================================
# Nexus Network 魔改管理脚本 for CentOS 8 (ARM64)
#
# 功能:
#   - 自动下载、安装和配置 nexus-network
#   - 将其注册为 systemd 服务进行管理
#   - 提供启动、停止、重启、查看状态和日志的功能
#   - 支持一键卸载
#
# 作者: Your Name/AI Assistant
# 版本: 1.0
#================================================================================

# --- 全局变量定义 ---
# 下载链接
readonly URL="https://github.com/nexus-xyz/nexus-cli/releases/download/v0.10.8/nexus-network-linux-arm64"
# 二进制文件最终名称
readonly BINARY_NAME="nexus-network"
# 安装路径
readonly INSTALL_DIR="/usr/local/bin"
# 配置文件目录
readonly CONFIG_DIR="/etc/nexus-network"
# 服务名称
readonly SERVICE_NAME="nexus-network"
# systemd 服务文件路径
readonly SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
# 运行服务的用户
readonly RUN_USER="nexus-user"

# --- 颜色定义 ---
readonly C_RED='\033[0;31m'
readonly C_GREEN='\033[0;32m'
readonly C_YELLOW='\033[0;33m'
readonly C_BLUE='\033[0;34m'
readonly C_NC='\033[0m' # No Color

# --- 辅助函数 ---

# 打印信息
_log() {
    local color="$1"
    local message="$2"
    echo -e "${color}${message}${C_NC}"
}

# 暂停脚本，等待用户按回车键
pause() {
    read -rp "按 [Enter] 键返回菜单..."
}

# 检查是否以 root 用户身份运行
check_root() {
    if [[ "$(id -u)" -ne 0 ]]; then
        _log "$C_RED" "错误: 此脚本必须以 root 权限运行。请使用 'sudo'。"
        exit 1
    fi
}

# 检查操作系统和架构
check_os_arch() {
    # 检查操作系统
    if ! grep -q -i "centos stream release 8" /etc/centos-release; then
        _log "$C_RED" "警告: 此脚本专为 CentOS 8 设计。您的系统可能不兼容。"
        # exit 1 # 如果要强制限制，可以取消此行注释
    fi

    # 检查架构
    local arch
    arch=$(uname -m)
    if [[ "$arch" != "aarch64" ]]; then
        _log "$C_RED" "错误: 您的系统架构是 '$arch'，但所需程序是为 'aarch64' (ARM64) 构建的。"
        exit 1
    fi
}

# 检查服务是否已安装
is_installed() {
    if [[ -f "$SERVICE_FILE" ]] || [[ -f "${INSTALL_DIR}/${BINARY_NAME}" ]]; then
        return 0 # 已安装
    else
        return 1 # 未安装
    fi
}

# --- 核心功能函数 ---

# 1. 安装 Nexus Network
install_nexus() {
    _log "$C_BLUE" "--- 开始安装 Nexus Network ---"
    
    if is_installed; then
        _log "$C_YELLOW" "检测到 Nexus Network 已安装。如果需要重新安装，请先卸载。"
        return
    fi

    # 1. 安装依赖
    _log "$C_BLUE" "[1/7] 正在安装依赖 (wget)..."
    dnf install -y wget > /dev/null 2>&1
    if ! command -v wget &> /dev/null; then
        _log "$C_RED" "错误: wget 安装失败，请手动安装。"
        return
    fi
    
    # 2. 创建运行用户
    _log "$C_BLUE" "[2/7] 正在创建系统用户 '${RUN_USER}'..."
    if ! id -u "${RUN_USER}" >/dev/null 2>&1; then
        useradd -r -m -s /bin/false "${RUN_USER}"
    else
        _log "$C_YELLOW" "用户 '${RUN_USER}' 已存在，跳过创建。"
    fi

    # 3. 创建配置文件目录
    _log "$C_BLUE" "[3/7] 正在创建配置目录 '${CONFIG_DIR}'..."
    mkdir -p "${CONFIG_DIR}"
    chown -R "${RUN_USER}:${RUN_USER}" "${CONFIG_DIR}"

    # 4. 下载二进制文件
    _log "$C_BLUE" "[4/7] 正在从 GitHub 下载二进制文件..."
    wget -O "${INSTALL_DIR}/${BINARY_NAME}" "$URL"
    if [[ $? -ne 0 ]]; then
        _log "$C_RED" "错误: 文件下载失败。请检查网络或链接是否有效。"
        return
    fi
    
    # 5. 设置权限
    _log "$C_BLUE" "[5/7] 正在设置文件权限..."
    chmod +x "${INSTALL_DIR}/${BINARY_NAME}"

    # 6. 创建 systemd 服务文件
    _log "$C_BLUE" "[6/7] 正在创建 systemd 服务..."
    create_systemd_service

    # 7. 重载 systemd 并启用服务
    _log "$C_BLUE" "[7/7] 正在重载 systemd 并设置开机自启..."
    systemctl daemon-reload
    systemctl enable "${SERVICE_NAME}"

    _log "$C_GREEN" "--- Nexus Network 安装成功！ ---"
    _log "$C_YELLOW" "服务已设置为开机自启，但尚未运行。请使用菜单中的 '启动服务' 选项来启动它。"
}

# 创建 systemd 服务文件
create_systemd_service() {
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Nexus Network Service
After=network.target

[Service]
Type=simple
User=${RUN_USER}
Group=${RUN_USER}
ExecStart=${INSTALL_DIR}/${BINARY_NAME} --config-dir=${CONFIG_DIR}
Restart=on-failure
RestartSec=10
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
    _log "$C_GREEN" "systemd 服务文件已创建: ${SERVICE_FILE}"
}

# 2. 卸载 Nexus Network
uninstall_nexus() {
    _log "$C_BLUE" "--- 开始卸载 Nexus Network ---"
    
    if ! is_installed; then
        _log "$C_YELLOW" "Nexus Network 未安装。"
        return
    fi

    read -rp "您确定要完全卸载 Nexus Network 吗？[y/N]: " confirm
    if [[ "${confirm,,}" != "y" ]]; then
        _log "$C_YELLOW" "卸载操作已取消。"
        return
    fi

    # 停止并禁用服务
    systemctl stop "${SERVICE_NAME}" >/dev/null 2>&1
    systemctl disable "${SERVICE_NAME}" >/dev/null 2>&1
    _log "$C_BLUE" "[1/4] 服务已停止并禁用。"

    # 删除服务文件
    rm -f "$SERVICE_FILE"
    systemctl daemon-reload
    _log "$C_BLUE" "[2/4] systemd 服务文件已删除。"

    # 删除二进制文件
    rm -f "${INSTALL_DIR}/${BINARY_NAME}"
    _log "$C_BLUE" "[3/4] 二进制文件已删除。"

    # 询问是否删除配置文件和用户
    read -rp "是否删除配置文件目录 (${CONFIG_DIR}) 和用户 (${RUN_USER})？这是不可逆的！[y/N]: " confirm_data
    if [[ "${confirm_data,,}" == "y" ]]; then
        rm -rf "${CONFIG_DIR}"
        userdel -r "${RUN_USER}" >/dev/null 2>&1
        _log "$C_BLUE" "[4/4] 配置文件和用户已删除。"
    else
        _log "$C_YELLOW" "[4/4] 保留了配置文件和用户。"
    fi
    
    _log "$C_GREEN" "--- Nexus Network 卸载完成 ---"
}

# 3. 启动服务
start_service() {
    if ! is_installed; then _log "$C_RED" "错误: Nexus Network 未安装。"; return; fi
    _log "$C_BLUE" "正在启动 ${SERVICE_NAME} 服务..."
    systemctl start "${SERVICE_NAME}"
    _log "$C_GREEN" "启动命令已发送。请使用 '查看状态' 确认服务是否正常运行。"
}

# 4. 停止服务
stop_service() {
    if ! is_installed; then _log "$C_RED" "错误: Nexus Network 未安装。"; return; fi
    _log "$C_BLUE" "正在停止 ${SERVICE_NAME} 服务..."
    systemctl stop "${SERVICE_NAME}"
    _log "$C_GREEN" "服务已停止。"
}

# 5. 重启服务
restart_service() {
    if ! is_installed; then _log "$C_RED" "错误: Nexus Network 未安装。"; return; fi
    _log "$C_BLUE" "正在重启 ${SERVICE_NAME} 服务..."
    systemctl restart "${SERVICE_NAME}"
    _log "$C_GREEN" "重启命令已发送。"
}

# 6. 查看服务状态
status_service() {
    if ! is_installed; then _log "$C_RED" "错误: Nexus Network 未安装。"; return; fi
    _log "$C_BLUE" "--- ${SERVICE_NAME} 服务状态 ---"
    systemctl status "${SERVICE_NAME}"
}

# 7. 查看服务日志
view_logs() {
    if ! is_installed; then _log "$C_RED" "错误: Nexus Network 未安装。"; return; fi
    _log "$C_BLUE" "--- 显示最新的100条日志 (按 'q' 退出) ---"
    journalctl -u "${SERVICE_NAME}" -n 100 --no-pager -f
}


# --- 菜单界面 ---
show_menu() {
    clear
    echo "========================================================"
    echo "       Nexus Network 魔改管理脚本 (CentOS 8 ARM64)"
    echo "========================================================"
    if is_installed; then
        _log "$C_GREEN" "      状态: 已安装"
    else
        _log "$C_YELLOW" "      状态: 未安装"
    fi
    echo "--------------------------------------------------------"
    echo " 1. 安装 Nexus Network (自动配置为服务)"
    echo " 2. 卸载 Nexus Network"
    echo "--------------------------------------------------------"
    echo " 3. 启动服务"
    echo " 4. 停止服务"
    echo " 5. 重启服务"
    echo " 6. 查看服务状态"
    echo " 7. 查看实时日志"
    echo "--------------------------------------------------------"
    echo " 0. 退出脚本"
    echo "========================================================"
}

# --- 主循环 ---
main() {
    check_root
    check_os_arch
    
    while true; do
        show_menu
        read -rp "请输入选项 [0-7]: " choice

        case "$choice" in
            1) install_nexus; pause ;;
            2) uninstall_nexus; pause ;;
            3) start_service; pause ;;
            4) stop_service; pause ;;
            5) restart_service; pause ;;
            6) status_service; pause ;;
            7. | f) view_logs ;; # 添加 'f' 作为快捷键，因为日志是实时跟随的
            0) _log "$C_BLUE" "感谢使用，脚本已退出。"; exit 0 ;;
            *) _log "$C_RED" "无效的选项，请输入 0-7 之间的数字。"; pause ;;
        esac
    done
}

# --- 脚本入口 ---
main
