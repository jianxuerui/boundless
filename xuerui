#!/bin/bash
set -e

# === å…¨å±€é…ç½® ===
BASE_CONTAINER_NAME="nexus-node"
IMAGE_NAME="nexus-node:latest"
LOG_DIR="/root/nexus_logs" # æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°å®¿ä¸»æœºçš„ç›®å½•

# === è¾…åŠ©å‡½æ•° ===

# æ£€æŸ¥å¹¶å®‰è£… Node.js å’Œ pm2
function check_node_pm2() {
    echo "ğŸ” æ£€æŸ¥ Node.js å’Œ pm2 å®‰è£…æƒ…å†µ..."
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Node.js
    if ! command -v node >/dev/null 2>&1; then
        echo "âœ… Node.js æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - || { echo "ğŸ”´ é”™è¯¯ï¼šNode.js å®‰è£…è„šæœ¬å¤±è´¥ã€‚"; exit 1; }
        apt-get update && apt-get install -y nodejs || { echo "ğŸ”´ é”™è¯¯ï¼šNode.js åŒ…å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        echo "âœ… Node.js å®‰è£…æˆåŠŸã€‚"
    fi

    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† pm2
    if ! command -v pm2 >/dev/null 2>&1; then
        echo "âœ… pm2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        npm install -g pm2 || { echo "ğŸ”´ é”™è¯¯ï¼špm2 å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        # é…ç½® npm prefixï¼Œç¡®ä¿ pm2 å¯æ‰§è¡Œæ–‡ä»¶åœ¨ PATH ä¸­
        PM2_PATH=$(npm config get prefix)/bin
        if [[ ":$PATH:" != *":$PM2_PATH:"* ]]; then
            echo "ğŸ”§ å°† npm bin è·¯å¾„æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡..."
            echo "export PATH=\"$PM2_PATH:\$PATH\"" >> ~/.profile # ç¡®ä¿é‡å¯åä¹Ÿæœ‰æ•ˆ
            source ~/.profile
            # For current session if it was root
            export PATH="$PM2_PATH:$PATH"
        fi
        echo "âœ… pm2 å®‰è£…æˆåŠŸã€‚"
    fi
}

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
function check_docker() {
    echo "ğŸ” æ£€æŸ¥ Docker å®‰è£…æƒ…å†µ..."
    if ! command -v docker >/dev/null 2>&1; then
        echo "âœ… Docker æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        apt update || { echo "ğŸ”´ é”™è¯¯ï¼šapt update å¤±è´¥ã€‚"; exit 1; }
        # ä¿®æ­£ gpg å‘½ä»¤ä»¥é€‚é…æ›´æ–°çš„ apt
        apt install -y ca-certificates curl gnupg lsb-release || { echo "ğŸ”´ é”™è¯¯ï¼šDocker ä¾èµ–å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        mkdir -m 0755 -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg || { echo "ğŸ”´ é”™è¯¯ï¼šDocker GPG å¯†é’¥ä¸‹è½½å¤±è´¥ã€‚"; exit 1; }
        echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null || { echo "ğŸ”´ é”™è¯¯ï¼šDocker APT æºæ·»åŠ å¤±è´¥ã€‚"; exit 1; }
        apt update || { echo "ğŸ”´ é”™è¯¯ï¼šapt update å¤±è´¥ã€‚"; exit 1; }
        apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y || { echo "ğŸ”´ é”™è¯¯ï¼šDocker CE å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        systemctl enable docker || { echo "ğŸ”´ é”™è¯¯ï¼šå¯ç”¨ Docker å¤±è´¥ã€‚"; exit 1; }
        systemctl start docker || { echo "ğŸ”´ é”™è¯¯ï¼šå¯åŠ¨ Docker å¤±è´¥ã€‚"; exit 1; }
        # å¢åŠ å½“å‰ç”¨æˆ·åˆ° docker ç»„ï¼Œé¿å…æ¯æ¬¡éƒ½ç”¨ sudo
        if ! getent group docker | grep -q "\b$(whoami)\b"; then
            echo "ğŸ”§ å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç”¨æˆ·ç»„..."
            usermod -aG docker "$(whoami)" || { echo "âš ï¸ æ— æ³•å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ã€‚å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ–ä½¿ç”¨ sudoã€‚"; }
            echo "âœ… ç”¨æˆ·å·²æ·»åŠ åˆ° docker ç»„ã€‚è¯·é€€å‡ºå½“å‰ SSH ä¼šè¯å¹¶é‡æ–°ç™»å½•ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚"
            sleep 3 # ç­‰å¾…ç”¨æˆ·é˜…è¯»æ¶ˆæ¯
        fi
        echo "âœ… Docker å®‰è£…å¹¶å¯åŠ¨æˆåŠŸã€‚"
    fi
}

# è®¾ç½® pm2 å¯åŠ¨è„šæœ¬ä»¥ä¾¿é‡å¯åæ¢å¤
function setup_pm2_startup() {
    echo "âœ… è®¾ç½® PM2 å¯åŠ¨è„šæœ¬ä»¥ç¡®ä¿æœåŠ¡æŒä¹…åŒ–..."
    if command -v pm2 >/dev/null 2>&1; then
        # å°è¯•ä½¿ç”¨ systemdï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€åˆ°å…¶ä»–ç±»å‹
        pm2 startup systemd || pm2 startup || echo "âš ï¸ PM2 startup å‘½ä»¤å¯èƒ½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®ï¼špm2 startup"
        pm2 save || echo "âš ï¸ PM2 save å‘½ä»¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œï¼špm2 save"
        echo "âœ… PM2 æœåŠ¡æŒä¹…åŒ–è®¾ç½®å®Œæˆã€‚"
    else
        echo "ğŸ”´ é”™è¯¯ï¼špm2 æœªå®‰è£…ï¼Œæ— æ³•è®¾ç½®æœåŠ¡æŒä¹…åŒ–ã€‚è¯·å°è¯•æ‰§è¡Œé€‰é¡¹6å…ˆè¿›è¡Œå®‰è£…ã€‚"
    fi
}

# æ„å»º Docker é•œåƒå‡½æ•°
function build_image() {
    echo "âš™ï¸ æ­£åœ¨æ„å»º Docker é•œåƒ: $IMAGE_NAME ..."
    WORKDIR=$(mktemp -d)
    # ç¡®ä¿åœ¨è„šæœ¬é€€å‡ºæ—¶æ¸…ç†ä¸´æ—¶ç›®å½•
    trap "cd - >/dev/null 2>&1; rm -rf \"$WORKDIR\"" EXIT HUP INT TERM

    cd "$WORKDIR"

    # Dockerfile
    cat > Dockerfile <<EOF
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PROVER_ID_FILE=/root/.nexus/node-id
# å®¹å™¨å†…éƒ¨æ—¥å¿—è·¯å¾„ï¼Œç”¨äº tee
ENV NEXUS_LOG_FILE=/root/nexus.log 

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…æ‰€éœ€å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    bash \
    procps \
    locales \
    gawk \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½® locales ä»¥é¿å…æŸäº›å‘½ä»¤å‡ºç°è­¦å‘Š
RUN locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

# è‡ªåŠ¨ä¸‹è½½å®‰è£…æœ€æ–°ç‰ˆ nexus-network
# ä½¿ç”¨ NONINTERACTIVE=1 é¿å…äº¤äº’å¼å®‰è£…
RUN curl -sSL https://cli.nexus.xyz/ | NONINTERACTIVE=1 sh \
    && ln -sf /root/.nexus/bin/nexus-network /usr/local/bin/nexus-network \
    && rm -rf ~/.npm ~/.config

# Docker HEALTHCHECK ç”¨äºæ£€æŸ¥å®¹å™¨å†…æœåŠ¡æ˜¯å¦è¿è¡Œ
# æ£€æŸ¥ nexus-network è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å®¹å™¨ä¸å¥åº·
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 CMD pgrep -f nexus-network >/dev/null || exit 1

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
EOF

    # entrypoint.sh (å·²ä¿®å¤ï¼Œæ›´å¥å£®ä¸”ç¬¦åˆDockeræœ€ä½³å®è·µ)
    cat > entrypoint.sh <<EOF
#!/bin/bash
set -e

PROVER_ID_FILE="/root/.nexus/node-id"
NEXUS_LOG_FILE="/root/nexus.log" # å®¹å™¨å†…éƒ¨æ—¥å¿—è·¯å¾„ï¼Œä¸å®¿ä¸»æœºæŒ‚è½½ç‚¹ä¸€è‡´

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨ (å¯¹äº Dockerfile COPY åå¯èƒ½ä¸å®Œå…¨é€‚ç”¨ï¼Œä½†ä»æ˜¯å¥½ä¹ æƒ¯)
mkdir -p "\$(dirname "\$NEXUS_LOG_FILE")" || true

# æ£€æŸ¥ NODE_ID ç¯å¢ƒå˜é‡
if [ -z "\$NODE_ID" ]; then
    echo "é”™è¯¯ï¼šæœªè®¾ç½® NODE_ID ç¯å¢ƒå˜é‡"
    exit 1
fi

# å°† NODE_ID å†™å…¥æŒ‡å®šæ–‡ä»¶
echo "\$NODE_ID" > "\$PROVER_ID_FILE"
echo "âœ… æ­£åœ¨ä½¿ç”¨ node-id: \$NODE_ID"

# æ£€æŸ¥ nexus-network å‘½ä»¤æ˜¯å¦å¯ç”¨
if ! command -v nexus-network >/dev/null 2>&1; then
    echo "é”™è¯¯ï¼šnexus-network æœªå®‰è£…æˆ–ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥ Dockerfileã€‚"
    exit 1
fi

# ä½¿ç”¨ trap æ•è· SIGTERM (Docker stop ä¿¡å·) ä»¥å®ç°ä¼˜é›…å…³é—­
# ç”±äº nexus-network ç°åœ¨æ˜¯ä¸»è¦è¿›ç¨‹ï¼ŒDocker çš„ SIGTERM ä¼šç›´æ¥å‘é€ç»™å®ƒ
# å¦‚æœ nexus-network è‡ªèº«ä¸æ”¯æŒ SIGTERM ä¼˜é›…å…³é—­ï¼Œåˆ™éœ€è¦åœ¨å®ƒåœæ­¢å‰å‘é€ç‰¹æ®Šä¿¡å·æˆ–è¿›è¡Œç‰¹å®šæ“ä½œ
# å¯¹äºé€šå¸¸çš„è¿›ç¨‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç† SIGTERMã€‚è¿™é‡Œå¯ä»¥ç§»é™¤å…·ä½“çš„ graceful_shutdown å‡½æ•°
# å¦‚æœ nexus-network éœ€è¦ç‰¹åˆ«çš„å¤„ç†ï¼Œéœ€è¦æŸ¥çœ‹å…¶æ–‡æ¡£
function graceful_shutdown() {
    echo "ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å· (SIGTERM)ã€‚å°è¯•ç­‰å¾… nexus-network ä¼˜é›…é€€å‡º..."
    # å¯ä»¥å‘é€ SIGINT (Ctrl+C) æˆ– SIGTERM ç»™ PID 1 è¿›ç¨‹
    # è¿™é‡Œå¦‚æœ nexus-network æ˜¯ PID 1ï¼ŒDocker ä¼šç›´æ¥å¤„ç†å®ƒã€‚
    # å¦‚æœæ‚¨éœ€è¦é¢å¤–æ­¥éª¤ï¼ˆä¾‹å¦‚æ¸…ç†ï¼‰ï¼Œå¯ä»¥æ·»åŠ åœ¨æ­¤å¤„ã€‚
    # ç¤ºä¾‹: å¯ä»¥ç®€å•åœ°ç­‰å¾…ï¼Œè®© Docker è‡ªå·±å¤„ç† PID 1 æ”¶åˆ° SIGTERM åçš„é»˜è®¤è¡Œä¸º
    wait \$(pgrep -f nexus-network) 2>/dev/null || true # ç­‰å¾…è¿›ç¨‹ç»“æŸï¼Œä¸æŠ¥é”™
    echo "âœ… nexus-network è¿›ç¨‹å·²é€€å‡ºã€‚"
    exit 0
}

# Trap SIGTERM ä»…ä½œä¸ºåå¤‡ï¼ŒDocker ä¼šç›´æ¥å‘é€ SIGTERM åˆ° exec å¯åŠ¨çš„è¿›ç¨‹
# è¿™åœ¨ exec åå°±æ²¡æœ‰å¤ªå¤šä½œç”¨äº†ï¼Œå› ä¸º trap æ˜¯é’ˆå¯¹å½“å‰ shell çš„ã€‚
# é€šå¸¸ï¼Œè®©å®¹å™¨çš„ PID 1 è¿›ç¨‹ç›´æ¥æ¥æ”¶ Docker çš„ä¿¡å·å³å¯ã€‚
# å¦‚æœ nexus-network ä¼˜é›…å…³é—­ä¸å·¥ä½œï¼Œå¯èƒ½æ˜¯å®ƒè‡ªèº«ä¸å¤„ç†ä¿¡å·ã€‚
# æ›´å¥½çš„åšæ³•æ˜¯ç¡®ä¿ nexus-network èƒ½å¤Ÿå¤„ç† TERM ä¿¡å·ã€‚
# è¿™é‡Œå°† trap è®¾ç½®ä¸º exec *ä¹‹å‰*ï¼Œè¿™æ ·å®ƒä¼šå¤„ç†é€€å‡ºï¼Œ
# ä½†æ˜¯ exec åï¼Œè¿™ä¸ª trap ä»…å­˜åœ¨äºæ›¿æ¢çš„è¿›ç¨‹ä¸­ã€‚
trap 'graceful_shutdown' SIGTERM

echo "ğŸš€ å¯åŠ¨ nexus-network èŠ‚ç‚¹..."
# å°† nexus-network çš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šå‘åˆ° NEXUS_LOG_FILEï¼Œ
# åŒæ—¶é€šè¿‡ tee å‘½ä»¤å°†å®ƒä»¬ä¹Ÿå‘é€åˆ°å®¹å™¨çš„æ ‡å‡†è¾“å‡ºï¼ˆPID 1 çš„è¾“å‡ºï¼‰ï¼Œ
# è¿™æ · Docker logs å‘½ä»¤å¯ä»¥å®æ—¶æ˜¾ç¤ºæ—¥å¿—ã€‚
# å¦‚æœ nexus-network è¿›ç¨‹é€€å‡ºï¼Œç”±äº exec å‘½ä»¤ï¼Œæ•´ä¸ªå®¹å™¨ä¹Ÿä¼šé€€å‡ºï¼Œ
# è¿™æ‰æ˜¯ Docker å®¹å™¨åº”è¯¥æœ‰çš„è¡Œä¸ºã€‚
# tee -a è¡¨ç¤ºè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºã€‚
exec nexus-network start --node-id "\$NODE_ID" 2>&1 | tee -a "\$NEXUS_LOG_FILE"
EOF

    docker build -t "$IMAGE_NAME" . || { echo "ğŸ”´ é”™è¯¯ï¼šDocker é•œåƒæ„å»ºå¤±è´¥ã€‚"; exit 1; }
    echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ: $IMAGE_NAME"

    # The trap will handle cleaning up workdir and cd back to previous directory
}

# å¯åŠ¨å®¹å™¨ï¼ˆæŒ‚è½½å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶æ·»åŠ èµ„æºé™åˆ¶ï¼‰
# å¢åŠ  --restart unless-stopped ç­–ç•¥
function run_container() {
    local node_id=$1
    local memory_limit=$2 # ä¾‹å¦‚: 2g
    local cpu_limit=$3    # ä¾‹å¦‚: 0.5 æˆ– 1.0
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    local log_file="${LOG_DIR}/nexus-${node_id}.log" # å®¿ä¸»æœºä¸Šçš„æ—¥å¿—æ–‡ä»¶è·¯å¾„

    echo "âš™ï¸ å‡†å¤‡å¯åŠ¨å®¹å™¨ $container_name (å†…å­˜: ${memory_limit}, CPU: ${cpu_limit})..."

    if docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then
        echo "ğŸ” æ£€æµ‹åˆ°æ—§å®¹å™¨ $container_nameï¼Œæ­£åœ¨å°è¯•åœæ­¢å¹¶åˆ é™¤..."
        docker stop -t 30 "$container_name" >/dev/null 2>&1 || true # å°è¯•ä¼˜é›…åœæ­¢
        docker rm -f "$container_name" >/dev/null 2>&1 || echo "âš ï¸ æ— æ³•åˆ é™¤æ—§å®¹å™¨ $container_nameï¼Œå¯èƒ½å·²ç»åœæ­¢æˆ–ä¸å­˜åœ¨ã€‚"
    fi

    # ç¡®ä¿å®¿ä¸»æœºæ—¥å¿—ç›®å½•å­˜åœ¨
    mkdir -p "$LOG_DIR" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæ—¥å¿—ç›®å½• $LOG_DIRã€‚"; exit 1; }
    
    # ç¡®ä¿å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶å­˜åœ¨å¹¶æœ‰å†™æƒé™ï¼Œä¸”ä¸æ˜¯ä¸€ä¸ªç›®å½•
    if [ -d "$log_file" ]; then
        echo "âš ï¸ æ£€æµ‹åˆ°æ—¥å¿—è·¯å¾„ $log_file ä¸ºç›®å½•ï¼Œæ­£åœ¨åˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ–‡ä»¶..."
        rm -rf "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ é™¤ç›®å½• $log_fileã€‚"; exit 1; }
    fi
    # é‡æ–°æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦ä¸ºå¸¸è§„æ–‡ä»¶æˆ–å·²åˆ›å»º
    if [ ! -f "$log_file" ]; then
        touch "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæ—¥å¿—æ–‡ä»¶ $log_fileã€‚"; exit 1; }
        chmod 644 "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•è®¾ç½®æ—¥å¿—æ–‡ä»¶æƒé™ $log_fileã€‚"; exit 1; }
    fi


    echo "ğŸš€ å¯åŠ¨å®¹å™¨ $container_name ..."
    # å°†å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„ /root/nexus.logï¼Œä¸ entrypoint.sh ä¿æŒä¸€è‡´
    docker run -d --name "$container_name" \
        --restart unless-stopped \
        --memory "${memory_limit}" \
        --cpus "${cpu_limit}" \
        -v "$log_file":/root/nexus.log \
        -e NODE_ID="$node_id" \
        "$IMAGE_NAME" || { echo "ğŸ”´ é”™è¯¯ï¼šå®¹å™¨ $container_name å¯åŠ¨å¤±è´¥ã€‚"; exit 1; }
    echo "âœ… å®¹å™¨ $container_name å·²æˆåŠŸå¯åŠ¨ï¼"
    echo "ğŸ’¡ å¯ä»¥ä½¿ç”¨ 'docker logs -f $container_name' æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚"
}

# åœæ­¢å¹¶å¸è½½å®¹å™¨å’Œé•œåƒã€åˆ é™¤æ—¥å¿—
function uninstall_node() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    local log_file="${LOG_DIR}/nexus-${node_id}.log"

    echo "âš™ï¸ æ­£åœ¨åœæ­¢å¹¶åˆ é™¤å®¹å™¨ $container_name..."
    # ä½¿ç”¨ docker stop å°è¯•ä¼˜é›…å…³é—­ï¼Œå¦‚æœè¶…æ—¶åˆ™å¼ºåˆ¶åˆ é™¤
    docker stop -t 30 "$container_name" >/dev/null 2>&1 || true
    docker rm -f "$container_name" >/dev/null 2>&1 || echo "âš ï¸ å®¹å™¨ $container_name ä¸å­˜åœ¨æˆ–å·²åœæ­¢ï¼Œè·³è¿‡åˆ é™¤ã€‚"

    if [ -f "$log_file" ]; then
        echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤æ—¥å¿—æ–‡ä»¶ $log_file ..."
        rm -f "$log_file" || echo "âš ï¸ æ— æ³•åˆ é™¤æ—¥å¿—æ–‡ä»¶ $log_fileã€‚"
    elif [ -d "$log_file" ]; then # æ£€æŸ¥æ˜¯å¦æ˜¯ç›®å½•
        echo "ğŸ—‘ï¸ å‘ç° $log_file æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ­£åœ¨åˆ é™¤å®ƒ..."
        rm -rf "$log_file" || echo "âš ï¸ æ— æ³•åˆ é™¤ç›®å½• $log_fileã€‚"
    else
        echo "â„¹ï¸ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼š$log_file"
    fi

    echo "âœ… èŠ‚ç‚¹ $node_id å·²å¸è½½å®Œæˆã€‚"
}

# ä¿®å¤åçš„æ˜¾ç¤ºæ‰€æœ‰è¿è¡Œä¸­çš„èŠ‚ç‚¹
function list_nodes() {
    echo "ğŸ“œ å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼š"
    echo "------------------------------------------------------------------------------------------------------------------------"
    printf "%-4s %-20s %-12s %-15s %-15s %-15s %-20s\n" "åºå·" "èŠ‚ç‚¹ID" "CPU" "å†…å­˜ä½¿ç”¨" "å†…å­˜é™åˆ¶" "çŠ¶æ€" "å¯åŠ¨æ—¶é—´"
    echo "------------------------------------------------------------------------------------------------------------------------"
    
    # ç»Ÿä¸€è·å–æ‰€æœ‰ç¬¦åˆå‘½åè§„åˆ™çš„å®¹å™¨IDã€åç§°ã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´
    local all_container_data=$(docker ps -a --filter "name=${BASE_CONTAINER_NAME}-" --format '{{.ID}}|{{.Names}}|{{.Status}}|{{.CreatedAt}}' 2>/dev/null)

    if [ -z "$all_container_data" ]; then
        echo "                      æ²¡æœ‰å‘ç°ä»»ä½• Nexus èŠ‚ç‚¹å®¹å™¨ã€‚                  "
        echo "------------------------------------------------------------------------------------------------------------------------"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    local count=0
    # ä½¿ç”¨ Here String è§£æå¤šè¡Œæ•°æ®
    while IFS= read -r line; do
        local container_id=$(echo "$line" | cut -d'|' -f1)
        local container_name=$(echo "$line" | cut -d'|' -f2)
        local status=$(echo "$line" | cut -d'|' -f3)
        local created_time_raw=$(echo "$line" | cut -d'|' -f4)

        # æå– node_id
        local node_id=$(echo "$container_name" | sed "s/^${BASE_CONTAINER_NAME}-//")

        local cpu_usage="N/A"
        local current_mem="N/A"
        local limit_mem="N/A"

        # é¦–å…ˆå°è¯•è·å–å®¹å™¨çš„å†…å­˜é™åˆ¶ï¼Œå³ä½¿æ˜¯åœæ­¢çš„å®¹å™¨ä¹Ÿå¯ä»¥è·å–
        local inspect_mem_limit_bytes=$(docker inspect -f '{{.HostConfig.Memory}}' "$container_id" 2>/dev/null)
        if [ -n "$inspect_mem_limit_bytes" ] && [ "$inspect_mem_limit_bytes" -gt 0 ]; then
            # è½¬æ¢ä¸ºå¯è¯»æ€§æ›´å¥½çš„å†…å­˜å•ä½
            if (( inspect_mem_limit_bytes >= 1099511627776 )); then # TB
                limit_mem=$(awk "BEGIN {printf \"%.1fT\", $inspect_mem_limit_bytes/1099511627776}")
            elif (( inspect_mem_limit_bytes >= 1073741824 )); then # GB
                limit_mem=$(awk "BEGIN {printf \"%.1fG\", $inspect_mem_limit_bytes/1073741824}")
            elif (( inspect_mem_limit_bytes >= 1048576 )); then # MB
                limit_mem=$(awk "BEGIN {printf \"%.1fM\", $inspect_mem_limit_bytes/1048576}")
            elif (( inspect_mem_limit_bytes >= 1024 )); then # KB
                limit_mem=$(awk "BEGIN {printf \"%.1fK\", $inspect_mem_limit_bytes/1024}")
            else
                limit_mem="${inspect_mem_limit_bytes}B"
            fi
        else
             limit_mem="ä¸é™"
        fi

        # ä»…å½“å®¹å™¨çŠ¶æ€ä¸º 'Up' (è¿è¡Œä¸­) æ—¶ï¼Œæ‰å°è¯•è·å–å®æ—¶ CPU å’Œå†…å­˜ä½¿ç”¨ç‡
        if [[ "$status" == Up* ]]; then
            # æ³¨æ„: docker stats åœ¨ --no-stream æ¨¡å¼ä¸‹å¯ä»¥ç«‹å³è¿”å›å½“å‰å¿«ç…§
            # æ­£ç¡®é‡å®šå‘é”™è¯¯è¾“å‡ºåˆ° /dev/null
            local container_stats=$(docker stats --no-stream --format "{{.CPUPerc}}|{{.MemUsage}}" "$container_id" 2>/dev/null)
            
            if [ -n "$container_stats" ]; then
                cpu_usage=$(echo "$container_stats" | cut -d'|' -f1)
                # MemUsage æ ¼å¼æ˜¯ "current_usage / limit_usage"ï¼Œè¿™é‡Œåªéœ€è¦ current_usage
                current_mem=$(echo "$container_stats" | cut -d'|' -f2 | cut -d'/' -f1 | xargs)
            fi
        fi

        # æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´
        local formatted_created_time=$(date -d "$created_time_raw" +'%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "N/A")

        count=$((count+1))
        printf "%-4d %-20s %-12s %-15s %-15s %-15s %-20s\n" \
            "$count" \
            "$node_id" \
            "$cpu_usage" \
            "$current_mem" \
            "${limit_mem}" \
            "$(echo "$status" | cut -d' ' -f1)" \
            "$formatted_created_time"
    done <<< "$all_container_data"

    echo "------------------------------------------------------------------------------------------------------------------------"
    echo "æç¤ºï¼š"
    echo "- CPU: æ˜¾ç¤ºå®¹å™¨CPUä½¿ç”¨ç™¾åˆ†æ¯” (ä»…å¯¹è¿è¡Œä¸­å®¹å™¨)"
    echo "- å†…å­˜ä½¿ç”¨: æ˜¾ç¤ºå®¹å™¨å½“å‰ä½¿ç”¨çš„å†…å­˜ (ä»…å¯¹è¿è¡Œä¸­å®¹å™¨)"
    echo "- å†…å­˜é™åˆ¶: æ˜¾ç¤ºå®¹å™¨åˆ›å»ºæ—¶è®¾ç½®çš„å†…å­˜é™åˆ¶ (å³ä½¿å®¹å™¨å·²åœæ­¢, \"ä¸é™\" è¡¨ç¤ºæœªè®¾ç½®é™åˆ¶)"
    echo "- çŠ¶æ€: æ˜¾ç¤ºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€ (Up/Exited)"
    echo "- å¯åŠ¨æ—¶é—´: æ˜¾ç¤ºå®¹å™¨çš„åˆ›å»ºæ—¶é—´"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# è·å–æ‰€æœ‰èŠ‚ç‚¹IDï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
function get_all_nodes() {
    docker ps -a --filter "name=${BASE_CONTAINER_NAME}-" --format "{{.Names}}" | sed "s/${BASE_CONTAINER_NAME}-//"
}

# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
function view_node_logs() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    
    if ! docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then
        echo "ğŸ”´ é”™è¯¯ï¼šå®¹å™¨ $container_name ä¸å­˜åœ¨æˆ–å·²åœæ­¢ã€‚è¯·ç¡®è®¤ Node ID æˆ–å°è¯•å®‰è£…/å¯åŠ¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "è¯·é€‰æ‹©æ—¥å¿—æŸ¥çœ‹æ¨¡å¼ï¼š"
    echo "1. åŸå§‹æ—¥å¿—ï¼ˆå¯èƒ½åŒ…å«é¢œè‰²ä»£ç ï¼‰"
    echo "2. æ¸…ç†åçš„æ—¥å¿—ï¼ˆç§»é™¤é¢œè‰²ä»£ç ï¼‰"
    read -rp "è¯·é€‰æ‹©(1-2): " log_mode

    echo "â„¹ï¸ æ­£åœ¨æŸ¥çœ‹æ—¥å¿—ï¼ŒæŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹..."
    if [ "$log_mode" = "2" ]; then
        # ç§»é™¤ANSIè½¬ä¹‰åºåˆ—å’Œå…‰æ ‡æ§åˆ¶åºåˆ—
        docker logs -f "$container_name" 2>&1 | sed 's/\x1b\[[0-9;]*m//g' | sed 's/\x1b\[?25[hl]//g'
    else
        docker logs -f "$container_name"
    fi
}

# æ‰¹é‡åœæ­¢å¹¶å¸è½½èŠ‚ç‚¹
function batch_uninstall_nodes() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "ğŸ“œ å½“å‰èŠ‚ç‚¹åˆ—è¡¨ï¼š"
    echo "----------------------------------------"
    printf "%-4s %-20s %s\n" "åºå·" "èŠ‚ç‚¹ID" "çŠ¶æ€"
    echo "----------------------------------------"
    for i in "${!all_nodes[@]}"; do
        local node_id=${all_nodes[$i]}
        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local status=$(docker ps -a --filter "name=$container_name" --format "{{.Status}}" 2>/dev/null)
        if [[ $status == Up* ]]; then
            printf "%-4d %-20s [è¿è¡Œä¸­]\n" $((i+1)) "$node_id"
        else
            printf "%-4d %-20s [å·²åœæ­¢]\n" $((i+1)) "$node_id"
        fi
    done
    echo "----------------------------------------"

    echo "ğŸ—‘ï¸ è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼ˆå¯å¤šé€‰ï¼Œè¾“å…¥æ•°å­—ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š"
    echo "0. è¿”å›ä¸»èœå•"
    
    read -rp "è¯·è¾“å…¥é€‰é¡¹(0 æˆ– æ•°å­—ï¼Œç”¨ç©ºæ ¼åˆ†éš”): " choices

    if [ "$choices" = "0" ]; then
        echo "âŒ æ“ä½œå·²å–æ¶ˆã€‚"
        return
    fi

    # å°†è¾“å…¥çš„é€‰é¡¹è½¬æ¢ä¸ºæ•°ç»„
    read -ra selected_choices <<< "$choices"
    
    # éªŒè¯è¾“å…¥å¹¶æ‰§è¡Œå¸è½½
    for choice in "${selected_choices[@]}"; do
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#all_nodes[@]} ]; then
            local selected_node=${all_nodes[$((choice-1))]}
            echo "â¡ï¸ æ­£åœ¨å¸è½½èŠ‚ç‚¹ $selected_node ..."
            uninstall_node "$selected_node"
        else
            echo "âš ï¸ è·³è¿‡æ— æ•ˆé€‰é¡¹: $choice"
        fi
    done

    echo "âœ… æ‰¹é‡å¸è½½å®Œæˆï¼"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# é€‰æ‹©è¦æŸ¥çœ‹çš„èŠ‚ç‚¹
function select_node_to_view() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "è¯·é€‰æ‹©è¦æŸ¥çœ‹æ—¥å¿—çš„èŠ‚ç‚¹ï¼š"
    echo "0. è¿”å›ä¸»èœå•"
    for i in "${!all_nodes[@]}"; do
        local node_id=${all_nodes[$i]}
        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local status=$(docker ps -a --filter "name=$container_name" --format "{{.Status}}" 2>/dev/null)
        if [[ $status == Up* ]]; then
            echo "$((i+1)). èŠ‚ç‚¹ $node_id [è¿è¡Œä¸­]"
        else
            echo "$((i+1)). èŠ‚ç‚¹ $node_id [å·²åœæ­¢]"
        fi
    done

    read -rp "è¯·è¾“å…¥é€‰é¡¹(0-${#all_nodes[@]}): " choice

    if [ "$choice" = "0" ]; then
        return
    fi

    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#all_nodes[@]} ]; then
        local selected_node=${all_nodes[$((choice-1))]}
        view_node_logs "$selected_node"
    else
        echo "ğŸ”´ æ— æ•ˆçš„é€‰é¡¹ã€‚"
        read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
    fi
}


# åˆ é™¤å…¨éƒ¨èŠ‚ç‚¹
function uninstall_all_nodes() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "â€¼ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨åŠå…¶ç›¸å…³æ—¥å¿—ï¼"
    echo "å½“å‰å…±æœ‰ ${#all_nodes[@]} ä¸ªèŠ‚ç‚¹å¾…åˆ é™¤ï¼š"
    for node_id in "${all_nodes[@]}"; do
        echo "- $node_id"
    done
    
    read -rp "ç¡®å®šè¦åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼(y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "âŒ æ“ä½œå·²å–æ¶ˆã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹..."
    for node_id in "${all_nodes[@]}"; do
        echo "â¡ï¸ æ­£åœ¨å¸è½½èŠ‚ç‚¹ $node_id ..."
        uninstall_node "$node_id"
    done

    echo "âœ… æ‰€æœ‰èŠ‚ç‚¹å·²åˆ é™¤å®Œæˆï¼"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# è®¾ç½®é»˜è®¤çš„è‡ªåŠ¨æ¸…ç†ä»»åŠ¡ï¼ˆPM2 ç®¡ç†ï¼‰
function setup_default_auto_cleanup() {
    local days=7 # é»˜è®¤ä¿ç•™7å¤©çš„æ—¥å¿—
    
    read -rp "è¯·è¾“å…¥æ—¥å¿—ä¿ç•™å¤©æ•°ï¼ˆé»˜è®¤ ${days} å¤©ï¼Œè¾“å…¥ 0 ä¸ä¿ç•™ï¼‰ï¼š" user_days
    if [[ -n "$user_days" && "$user_days" =~ ^[0-9]+$ && "$user_days" -ge 0 ]]; then
        days="$user_days"
    elif [[ -n "$user_days" ]]; then
        echo "âš ï¸ æ— æ•ˆè¾“å…¥ï¼Œä½¿ç”¨é»˜è®¤ $days å¤©ã€‚"
    fi

    echo "âš™ï¸ æ­£åœ¨è®¾ç½®è‡ªåŠ¨æ—¥å¿—æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘ $days å¤©çš„æ—¥å¿—ï¼‰..."
    
    # ç¡®ä¿ pm2 å·²å®‰è£…
    check_node_pm2
    
    local script_dir="/root/nexus_scripts"
    mkdir -p "$script_dir" 2>/dev/null || true # å…è®¸ç›®å½•å·²å­˜åœ¨

    local cleanup_script_path="$script_dir/cleanup_logs.sh"
    cat > "$cleanup_script_path" <<EOF
#!/bin/bash
set -e

LOG_DIR="$LOG_DIR"
DAYS_TO_KEEP=$days

if [ -d "\$LOG_DIR" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] è¿è¡Œ Nexus æ—¥å¿—æ¸…ç†ç¨‹åº (ä¿ç•™ \$DAYS_TO_KEEP å¤©æ—¥å¿—)..."
    # æŸ¥æ‰¾å¹¶åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—¥å¿—æ–‡ä»¶
    # -print-delete æ˜¯ GNU find çš„æ‰©å±•ï¼Œå®ƒä¼šåœ¨æ‰¾åˆ°åç«‹å³åˆ é™¤ï¼Œå¹¶æ‰“å°è¢«åˆ é™¤æ–‡ä»¶çš„è·¯å¾„
    find "\$LOG_DIR" -name "nexus-*.log" -type f -mtime +\$DAYS_TO_KEEP -print -delete || true # å…è®¸æ‰¾ä¸åˆ°æ–‡ä»¶ä¸æŠ¥é”™
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Nexus æ—¥å¿—æ¸…ç†å®Œæˆã€‚"
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] æ—¥å¿—ç›®å½• \$LOG_DIR ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†ã€‚"
fi
EOF
    chmod +x "$cleanup_script_path"
    
    # åœæ­¢æ—§çš„æ¸…ç†ä»»åŠ¡
    pm2 delete nexus-cleanup 2>/dev/null || true
    
    # ä½¿ç”¨ pm2 å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡
    # ä½¿ç”¨ -- start -- çš„è¯­æ³•ç¡®ä¿åœ¨æ‰§è¡Œè„šæœ¬å‰åœæ­¢æ—§è¿›ç¨‹
    pm2 start --name "nexus-cleanup" --no-autorestart --cron-restart "0 0 * * *" "$cleanup_script_path"
    pm2 save
    
    echo "âœ… è‡ªåŠ¨æ—¥å¿—æ¸…ç†ä»»åŠ¡å·²æˆåŠŸè®¾ç½®ï¼å°†æ¯å¤©æ¸…ç†è¶…è¿‡ $days å¤©çš„æ—¥å¿—ã€‚"
    echo "   ä½¿ç”¨ 'pm2 status' æŸ¥çœ‹æ¸…ç†ä»»åŠ¡çŠ¶æ€ã€‚"
    echo "   ä½¿ç”¨ 'pm2 logs nexus-cleanup' æŸ¥çœ‹æ¸…ç†æ—¥å¿—ã€‚"
}


# æ‰¹é‡èŠ‚ç‚¹è½®æ¢å¯åŠ¨ (é€šè¿‡ PM2 è°ƒåº¦ï¼Œç¡®ä¿ç¨³å®šæ€§)
function batch_rotate_nodes() {
    echo "ğŸ”„ å¯åŠ¨æ‰¹é‡èŠ‚ç‚¹è½®æ¢æ¨¡å¼"
    echo "â„¹ï¸ è¯·è¾“å…¥æ‰€æœ‰è¦å‚ä¸è½®æ¢çš„ node-idï¼Œæ¯è¡Œä¸€ä¸ªï¼Œè¾“å…¥ç©ºè¡ŒåæŒ‰ Ctrl+D ç»“æŸè¾“å…¥ï¼š"
    
    local node_ids=()
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            node_ids+=("$line")
        fi
    done

    if [ ${#node_ids[@]} -eq 0 ]; then
        echo "âš ï¸ æœªè¾“å…¥ä»»ä½• node-idï¼Œè¿”å›ä¸»èœå•ã€‚"
        read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
        return
    fi

    # è·å–å†…å­˜å’ŒCPUé™åˆ¶
    local mem_per_node=""
    while true; do
        read -rp "è¯·è¾“å…¥æ¯ä¸ªèŠ‚ç‚¹å®¹å™¨å…è®¸çš„æœ€å¤§å†…å­˜ (ä¾‹å¦‚: 2g, 4g, æ”¯æŒm/gåç¼€): " mem_per_node
        if [[ "$mem_per_node" =~ ^[0-9]+[mgMG]$ ]]; then
            break
        else
            echo "ğŸ”´ æ— æ•ˆçš„å†…å­˜æ ¼å¼ã€‚è¯·è¾“å…¥ä¾‹å¦‚ '2g' æˆ– '512m'ã€‚"
        fi
    done

    local cpu_per_node=""
    while true; do
        read -rp "è¯·è¾“å…¥æ¯ä¸ªèŠ‚ç‚¹å®¹å™¨å…è®¸çš„æœ€å¤§CPUæ ¸å¿ƒæ•° (ä¾‹å¦‚: 0.5, 1, 2): " cpu_per_node
        if [[ "$cpu_per_node" =~ ^[0-9]+(\.[0-9]+)?$ ]] && (( $(echo "$cpu_per_node > 0" | bc -l) )); then
            break
        else
            echo "ğŸ”´ æ— æ•ˆçš„CPUæ ¼å¼ã€‚è¯·è¾“å…¥å¤§äº0çš„æ•°å­—ï¼Œä¾‹å¦‚ '0.5' æˆ– '1'ã€‚"
        fi
    done

    local default_nodes_per_round=$(( (${#node_ids[@]} < 5) ? ${#node_ids[@]} : 5 )) # é»˜è®¤æ¯è½®å¯åŠ¨æœ€å¤š5ä¸ªï¼Œå¦‚æœæ€»æ•°å°äº5ï¼Œåˆ™å¯åŠ¨æ€»æ•°
    read -rp "è¯·è¾“å…¥æ¯æ‰¹æ¬¡è¦åŒæ—¶è¿è¡Œçš„èŠ‚ç‚¹æ•°é‡ï¼ˆé»˜è®¤ï¼š${default_nodes_per_round}ï¼‰: " nodes_per_round_input
    if [ -z "$nodes_per_round_input" ]; then
        nodes_per_round="$default_nodes_per_round"
    elif [[ "$nodes_per_round_input" =~ ^[0-9]+$ ]] && [ "$nodes_per_round_input" -ge 1 ]; then
        nodes_per_round="$nodes_per_round_input"
    else
        echo "ğŸ”´ æ— æ•ˆçš„èŠ‚ç‚¹æ•°é‡ï¼Œè¯·è¾“å…¥æ­£æ•´æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ã€‚"
        nodes_per_round="$default_nodes_per_round"
    fi

    # éªŒè¯è¾“å…¥
    if [ "$nodes_per_round" -gt ${#node_ids[@]} ]; then
        echo "âš ï¸ è­¦å‘Šï¼šè®¾å®šçš„æ¯æ‰¹æ¬¡å¯åŠ¨æ•°é‡ ($nodes_per_round) è¶…è¿‡äº†æ€»èŠ‚ç‚¹æ•° (${#node_ids[@]})ã€‚æ‰€æœ‰èŠ‚ç‚¹å°†åŒæ—¶è¿è¡Œã€‚"
        nodes_per_round=${#node_ids[@]}
    fi

    local total_nodes=${#node_ids[@]}
    local num_groups=$(( (total_nodes + nodes_per_round - 1) / nodes_per_round ))
    
    echo "âœ… èŠ‚ç‚¹æ€»æ•°: $total_nodes ä¸ªï¼Œå°†åˆ†ä¸º $num_groups ç»„è¿›è¡Œè½®æ¢ã€‚"
    echo "   æ¯æ‰¹æ¬¡å°†è¿è¡Œ $nodes_per_round ä¸ªèŠ‚ç‚¹ï¼ˆæœ€åä¸€ç»„å¯èƒ½ä¸è¶³ï¼‰ã€‚"

    read -rp "è¯·è¾“å…¥æ¯æ‰¹æ¬¡è½®æ¢å‘¨æœŸï¼ˆå°æ—¶ï¼Œå»ºè®® 2-24 å°æ—¶ï¼Œä¾‹å¦‚ 2): " rotation_interval_hours
    if ! [[ "$rotation_interval_hours" =~ ^[0-9]+$ ]] || [ "$rotation_interval_hours" -lt 1 ]; then
        echo "ğŸ”´ æ— æ•ˆçš„è½®æ¢å‘¨æœŸï¼Œè¯·è¾“å…¥æ­£æ•´æ•°ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi
    local rotation_interval_seconds=$(( rotation_interval_hours * 3600 ))

    # æ£€æŸ¥å¹¶å®‰è£… Node.js å’Œ pm2
    check_node_pm2
    # ç¡®ä¿ pm2 æŒä¹…åŒ–è®¾ç½®
    setup_pm2_startup

    echo "âš™ï¸ å¼€å§‹æ„å»º Docker é•œåƒ (å¦‚æœå°šæœªæ„å»º)..."
    build_image

    # åˆ›å»ºå¯åŠ¨è„šæœ¬ç›®å½•
    local script_dir="/root/nexus_scripts"
    mkdir -p "$script_dir" 2>/dev/null || true

    # æ¸…ç†æ—§çš„ç»„å¯åŠ¨è„šæœ¬
    echo "æ¸…ç†æ—§çš„æ‰¹æ¬¡å¯åŠ¨è„šæœ¬..."
    rm -f "$script_dir/start_batch_group_*.sh"

    # å°†èŠ‚ç‚¹åˆ†ç»„å¹¶åˆ›å»ºå„è‡ªçš„å¯åŠ¨è„šæœ¬
    for ((i=0; i<num_groups; i++)); do
        local group_num=$((i+1))
        local start_script="$script_dir/start_batch_group_${group_num}.sh"
        
        cat > "$start_script" <<EOF
#!/bin/bash
set -e
# è¯¥è„šæœ¬ç”± nexus_manager.sh ç”Ÿæˆï¼Œç”¨äºå¯åŠ¨ç‰¹å®šæ‰¹æ¬¡çš„ Nexus å®¹å™¨ã€‚
# è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ã€‚

MEMORY_LIMIT="$mem_per_node"
CPU_LIMIT="$cpu_per_node"
BASE_CONTAINER_NAME="$BASE_CONTAINER_NAME"
IMAGE_NAME="$IMAGE_NAME"
LOG_DIR="$LOG_DIR"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸš€ æ­£åœ¨å¤„ç†ç¬¬${group_num}ç»„èŠ‚ç‚¹..."

# --- åœ¨æœ¬ç»„å†…å¾ªç¯ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œå¯åŠ¨/æ›´æ–°é€»è¾‘ ---
EOF
        chmod +x "$start_script"
    done

    # å¡«å……å„ä¸ªç»„çš„è„šæœ¬
    for i in "${!node_ids[@]}"; do
        local node_id=${node_ids[$i]}
        local group_idx=$(( i / nodes_per_round )) # 0-indexed group
        local group_num=$((group_idx + 1))       # 1-indexed group for script name
        local start_script="$script_dir/start_batch_group_${group_num}.sh"

        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local node_log_file="${LOG_DIR}/nexus-${node_id}.log"

        # æ·»åŠ æ¯ä¸ªèŠ‚ç‚¹çš„å¯åŠ¨é€»è¾‘åˆ°å¯¹åº”çš„ç»„è„šæœ¬
        cat >> "$start_script" <<EOF

echo "[$(date '+%Y-%m-%d %H:%M:%S')]   â¡ï¸ æ£€æŸ¥/å¯åŠ¨èŠ‚ç‚¹ $node_id (å†…å­˜: \$MEMORY_LIMIT, CPU: \$CPU_LIMIT)"
# ç¡®ä¿å®¿ä¸»æœºæ—¥å¿—ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨
mkdir -p "\$LOG_DIR" 2>/dev/null || true
if [ -d "$node_log_file" ]; then
    echo "âš ï¸ æ—¥å¿—è·¯å¾„ $node_log_file æ˜¯ç›®å½•ï¼Œå°è¯•åˆ é™¤å¹¶é‡æ–°åˆ›å»ºã€‚"
    rm -rf "$node_log_file" || echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ é™¤ç›®å½• $node_log_fileã€‚"
fi
# é‡æ–°æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦ä¸ºå¸¸è§„æ–‡ä»¶æˆ–å·²åˆ›å»º
if [ ! -f "$node_log_file" ]; then
    touch "$node_log_file" || echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæ—¥å¿—æ–‡ä»¶ $node_log_fileã€‚"
    chmod 644 "$node_log_file" || echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•è®¾ç½®æ—¥å¿—æ–‡ä»¶æƒé™ $node_log_fileã€‚"
fi

# å¦‚æœå®¹å™¨å·²å­˜åœ¨ï¼Œåœæ­¢å¹¶åˆ é™¤ï¼Œä»¥ä¾¿é‡æ–°åˆ›å»ºæ–°çš„ï¼ˆåŒ…å«èµ„æºé™åˆ¶æˆ–æ›´æ–°ï¼‰
# ä½¿ç”¨ filter æ›´ç²¾ç¡®åŒ¹é…ï¼Œç¡®ä¿æ˜¯ exact name è€Œä¸æ˜¯ prefix match
if docker ps -a --format '{{.Names}}' | grep -Eq "^${container_name}$"; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')]   ğŸ” å‘ç°æ—§å®¹å™¨ ${container_name}ï¼Œåœæ­¢å¹¶åˆ é™¤..."
    docker stop -t 30 "${container_name}" >/dev/null 2>&1 || true
    docker rm -f "${container_name}" >/dev/null 2>&1 || true
fi

# å¯åŠ¨å¸¦æœ‰èµ„æºé™åˆ¶çš„æ–°å®¹å™¨
docker run -d --name "${container_name}" \
    --restart unless-stopped \
    --memory "\$MEMORY_LIMIT" \
    --cpus "\$CPU_LIMIT" \
    -v "$node_log_file":/root/nexus.log \
    -e NODE_ID="$node_id" \
    "\$IMAGE_NAME" || { echo "ğŸ”´ é”™è¯¯ï¼šèŠ‚ç‚¹ $node_id å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"; }

sleep 5 # å¯åŠ¨ä¹‹é—´ç¨ä½œç­‰å¾…ï¼Œé˜²æ­¢ Docker å‘½ä»¤å †ç§¯
EOF
    done

    # åˆ›å»ºè½®æ¢ä¸»è°ƒåº¦è„šæœ¬
    local rotate_scheduler_path="$script_dir/rotate_scheduler.sh"
    cat > "$rotate_scheduler_path" <<EOF
#!/bin/bash
set -e

GROUPS_COUNT=$num_groups
CURRENT_GROUP=0 # ä»ç¬¬0ç»„å¼€å§‹ï¼ŒåŠ 1åæ˜¯1-indexed
ROTATION_INTERVAL_SECONDS=$rotation_interval_seconds # è½®æ¢å‘¨æœŸ

# æ‰€æœ‰å‚ä¸è½®æ¢çš„èŠ‚ç‚¹IDåˆ—è¡¨ï¼Œç”¨äºç¡®ä¿æ¯æ¬¡åªæ¿€æ´»å½“å‰ç»„çš„èŠ‚ç‚¹
# ä½¿ç”¨ readarray ç¡®ä¿ ALL_NODE_IDS æ˜¯ä¸€ä¸ªå®é™…çš„ bash æ•°ç»„
# é€šè¿‡ heredoc å’Œ printf æ„å»ºï¼Œé¿å…ä»»ä½• IFS é—®é¢˜
readarray -t ALL_NODE_IDS <<<"$(printf "%s\\n" "${node_ids[@]}")"

BASE_CONTAINER_NAME="$BASE_CONTAINER_NAME"
SCRIPT_DIR="$script_dir"
NODES_PER_ROUND=$nodes_per_round

# åœ¨æ¯æ¬¡è½®æ¢å¼€å§‹å‰ï¼Œåœæ­¢å¹¶æ¸…ç†æ‰€æœ‰éå½“å‰ç»„çš„èŠ‚ç‚¹
function stop_inactive_groups() {
    local active_group_num=\$1
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ§¹ æ¸…ç†éå½“å‰ç»„èŠ‚ç‚¹..."

    # è·å–æ‰€æœ‰ BASE_CONTAINER_NAME- å‰ç¼€çš„å®¹å™¨ï¼ˆä¸è®ºçŠ¶æ€ï¼‰
    local all_known_containers_raw=\$(docker ps -a --filter "name=\${BASE_CONTAINER_NAME}-" --format '{{.Names}}' 2>/dev/null)
    # readarray ç”¨äºå°†å¤šè¡Œå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„ï¼Œç¡®ä¿æ¯ä¸ªå®¹å™¨åä½œä¸ºä¸€ä¸ªå…ƒç´ 
    readarray -t ALL_KNOWN_CONTAINERS_ARRAY <<< "\$all_known_containers_raw"

    for container_name in "\${ALL_KNOWN_CONTAINERS_ARRAY[@]}"; do
        local current_node_id="\$(echo "\$container_name" | sed "s/^\\${BASE_CONTAINER_NAME}-//")"
        
        # æŸ¥æ‰¾ current_node_id åœ¨ ALL_NODE_IDS æ•°ç»„ä¸­çš„ç´¢å¼•
        local node_index=-1
        for idx in "\${!ALL_NODE_IDS[@]}"; do
            if [ "\${ALL_NODE_IDS[\$idx]}" == "\$current_node_id" ]; then
                node_index=\$idx
                break
            fi
        done

        if [ "\$node_index" -ne -1 ]; then # ç¡®ä¿è¿™ä¸ªnode_idç¡®å®åœ¨æˆ‘ä»¬ç®¡ç†çš„åˆ—è¡¨é‡Œ
            local node_group_num=\$(( (node_index / \$NODES_PER_ROUND) + 1 )) # è®¡ç®—å½“å‰èŠ‚ç‚¹æ‰€å±ç»„ (1-indexed)

            if [ "\$node_group_num" -ne "\$active_group_num" ]; then
                # å¦‚æœå®¹å™¨å­˜åœ¨ä¸”çŠ¶æ€ä¸æ˜¯Exited (å·²åœæ­¢), åœæ­¢å¹¶åˆ é™¤
                # è·å–å®¹å™¨IDä»¥ä¾¿æ›´ç²¾ç¡®æ“ä½œ
                local target_container_id=\$(docker ps -a -q -f "name=\$container_name" 2>/dev/null)
                if [ -n "\$target_container_id" ]; then
                    local status=\$(docker inspect -f '{{.State.Status}}' "\$target_container_id" 2>/dev/null || echo "N/A")
                    if [ "\$status" != "exited" ]; then
                        echo "[$(date '+%Y-%m-%d %H:%M:%S')]   - åœæ­¢/åˆ é™¤æ—§ç»„çš„èŠ‚ç‚¹: \${container_name} (ç»„: \$node_group_num, çŠ¶æ€: \$status)"
                        docker stop -t 10 "\$target_container_id" >/dev/null 2>&1 || true
                        docker rm -f "\$target_container_id" >/dev/null 2>&1 || true
                    else
                        echo "[$(date '+%Y-%m-%d %H:%M:%S')]   - èŠ‚ç‚¹ \${container_name} å·²åœæ­¢ä¸”å·²é€€å‡ºï¼Œæ— éœ€æ“ä½œã€‚(ç»„: \$node_group_num, çŠ¶æ€: \$status)"
                    fi
                fi
            fi
        else
            # å¤„ç†å‘½ååŒ¹é…ä½†ä¸åœ¨ç™½åå•å†…çš„å®¹å™¨ï¼Œå¯èƒ½æ˜¯æ—§çš„æˆ–æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œä¸å»ºè®®åˆ é™¤
            echo "[$(date '+%Y-%m-%d %H:%M:%S')]   - å‘ç°éè½®æ¢æ‰¹æ¬¡ç®¡ç†çš„å®¹å™¨: \$container_name (ä¸æ‰§è¡Œåœæ­¢æ“ä½œ)"
        fi
    done
}


while true; do
    # è®¡ç®—ä¸‹ä¸€ç»„ç´¢å¼• (å¾ªç¯è½®è½¬ 1 -> N -> 1)
    CURRENT_GROUP=\$(( (CURRENT_GROUP % GROUPS_COUNT) + 1 ))

    # åœæ­¢å¹¶æ¸…ç†å½“å‰è¦æ¿€æ´»ç»„ä¹‹å¤–çš„æ‰€æœ‰èŠ‚ç‚¹
    stop_inactive_groups "\$CURRENT_GROUP"

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸš€ æ­£åœ¨è½®æ¢è‡³ç¬¬\$CURRENT_GROUPç»„ (å…± \$GROUPS_COUNT ç»„)..."
    bash "\$SCRIPT_DIR/start_batch_group_\${CURRENT_GROUP}.sh"

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] âœ… ç¬¬\$CURRENT_GROUPç»„èŠ‚ç‚¹å¯åŠ¨/æ›´æ–°å®Œæˆã€‚ä¸‹ä¸€æ¬¡è½®æ¢å°†åœ¨ ${rotation_interval_hours} å°æ—¶åè¿›è¡Œã€‚"
    sleep \$ROTATION_INTERVAL_SECONDS
done
EOF
    chmod +x "$rotate_scheduler_path"

    # åˆ é™¤æ—§çš„è½®æ¢è¿›ç¨‹
    echo "ğŸ”„ åœæ­¢æ—§çš„è½®æ¢è¿›ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰..."
    pm2 delete nexus-rotate 2>/dev/null || true

    # ä½¿ç”¨ pm2 å¯åŠ¨è½®æ¢è„šæœ¬
    echo "ğŸš€ ä½¿ç”¨ PM2 å¯åŠ¨èŠ‚ç‚¹è½®æ¢è°ƒåº¦ç¨‹åº..."
    pm2 start --name "nexus-rotate" "$rotate_scheduler_path"
    pm2 save

    echo "âœ… èŠ‚ç‚¹è½®æ¢è°ƒåº¦ç¨‹åºå·²å¯åŠ¨ï¼"
    echo "   æ€»å…± $total_nodes ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸º $num_groups ç»„"
    echo "   æ¯æ‰¹æ¬¡åŒæ—¶è¿è¡Œ $nodes_per_round ä¸ªèŠ‚ç‚¹ï¼ˆæœ€åä¸€ç»„å¯èƒ½ä¸è¶³ï¼‰ã€‚"
    echo "   è½®æ¢å°†æ¯ $rotation_interval_hours å°æ—¶è¿›è¡Œä¸€æ¬¡ï¼Œæ¿€æ´»ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„èŠ‚ç‚¹å¹¶å…³é—­æ—§çš„ã€‚"
    echo "   ğŸ’¡ æ¯ä¸ªèŠ‚ç‚¹å®¹å™¨è¢«é™åˆ¶ä¸ºå†…å­˜: $mem_per_node, CPU: $cpu_per_nodeã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 status' æŸ¥çœ‹è½®æ¢è°ƒåº¦ç¨‹åºè¿è¡ŒçŠ¶æ€ã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 logs nexus-rotate' æŸ¥çœ‹è½®æ¢æ—¥å¿—ã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 stop nexus-rotate' åœæ­¢è½®æ¢è°ƒåº¦ç¨‹åºã€‚"

    # æ·»åŠ æˆ–æ›´æ–°è‡ªåŠ¨æ¸…ç†ä»»åŠ¡
    setup_default_auto_cleanup
    
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# === ä¸»èœå• ===
function main_menu() {
    while true; do
        clear
        echo "=========================================================="
        echo "               ç”± å“ˆå“ˆå“ˆå“ˆ ç¼–å†™ - @ferdie_jhovie          "
        echo "                  å…è´¹å¼€æºï¼Œè°¨é˜²æ”¶è´¹æ¬ºè¯ˆï¼                 "
        echo "=========================================================="
        echo "                 âœ¨ Nexus å¤šèŠ‚ç‚¹ç®¡ç†å·¥å…· âœ¨              "
        echo "----------------------------------------------------------"
        echo " 1. ğŸš€ æ‰¹é‡èŠ‚ç‚¹è½®æ¢å¯åŠ¨ (é€šè¿‡PM2å‘¨æœŸæ€§å¯åŠ¨æ‰¹æ¬¡ï¼Œå»ºè®®)"
        echo " 2. ğŸ“Š æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ (CPU/å†…å­˜/çŠ¶æ€ç­‰)"
        echo " 3. ğŸ—‘ï¸ æ‰¹é‡åœæ­¢å¹¶å¸è½½æŒ‡å®šèŠ‚ç‚¹"
        echo " 4. ğŸ“„ æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹æ—¥å¿—"
        echo " 5. ğŸš¨ åˆ é™¤å…¨éƒ¨èŠ‚ç‚¹ (å±é™©æ“ä½œï¼Œä¸å¯é€†)"
        echo " 6. ğŸ§¹ é…ç½®/æ£€æŸ¥è‡ªåŠ¨æ—¥å¿—æ¸…ç†"
        echo " 7. ğŸšª é€€å‡ºè„šæœ¬"
        echo "----------------------------------------------------------"

        read -rp "è¯·è¾“å…¥é€‰é¡¹(1-7): " choice

        case $choice in
            1)
                check_docker
                batch_rotate_nodes
                ;;
            2)
                list_nodes
                ;;
            3)
                batch_uninstall_nodes
                ;;
            4)
                select_node_to_view
                ;;
            5)
                uninstall_all_nodes
                ;;
            6)
                setup_default_auto_cleanup
                read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
                ;;
            7)
                echo "æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ ğŸ‘‹ã€‚"
                exit 0
                ;;
            *)
                echo "ğŸ”´ æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚"
                read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
                ;;
        esac
    done
}

# è¿è¡Œä¸»èœå•
main_menu
