#!/bin/bash
set -e

# === å…¨å±€é…ç½® ===
BASE_CONTAINER_NAME="nexus-node"
IMAGE_NAME="nexus-node:latest"
LOG_DIR="/root/nexus_logs"

# === è¾…åŠ©å‡½æ•° ===

# æ£€æŸ¥å¹¶å®‰è£… Node.js å’Œ pm2
function check_node_pm2() {
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Node.js
    if ! command -v node >/dev/null 2>&1; then
        echo "âœ… Node.js æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - || { echo "ğŸ”´ é”™è¯¯ï¼šNode.js å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        apt-get update && apt-get install -y nodejs || { echo "ğŸ”´ é”™è¯¯ï¼šNode.js åŒ…å®‰è£…å¤±è´¥ã€‚"; exit 1; }
    fi

    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† pm2
    if ! command -v pm2 >/dev/null 2>&1; then
        echo "âœ… pm2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        npm install -g pm2 || { echo "ğŸ”´ é”™è¯¯ï¼špm2 å®‰è£…å¤±è´¥ã€‚"; exit 1; }
    fi
}

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
function check_docker() {
    if ! command -v docker >/dev/null 2>&1; then
        echo "âœ… Docker æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        apt update || { echo "ğŸ”´ é”™è¯¯ï¼šapt update å¤±è´¥ã€‚"; exit 1; }
        apt install -y apt-transport-https ca-certificates curl software-properties-common || { echo "ğŸ”´ é”™è¯¯ï¼šDocker ä¾èµ–å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg || { echo "ğŸ”´ é”™è¯¯ï¼šDocker GPG å¯†é’¥ä¸‹è½½å¤±è´¥ã€‚"; exit 1; }
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null || { echo "ğŸ”´ é”™è¯¯ï¼šDocker APT æºæ·»åŠ å¤±è´¥ã€‚"; exit 1; }
        apt update || { echo "ğŸ”´ é”™è¯¯ï¼šapt update å¤±è´¥ã€‚"; exit 1; }
        apt install -y docker-ce docker-ce-cli containerd.io || { echo "ğŸ”´ é”™è¯¯ï¼šDocker CE å®‰è£…å¤±è´¥ã€‚"; exit 1; }
        systemctl enable docker || { echo "ğŸ”´ é”™è¯¯ï¼šå¯ç”¨ Docker å¤±è´¥ã€‚"; exit 1; }
        systemctl start docker || { echo "ğŸ”´ é”™è¯¯ï¼šå¯åŠ¨ Docker å¤±è´¥ã€‚"; exit 1; }
        echo "âœ… Docker å®‰è£…å¹¶å¯åŠ¨æˆåŠŸã€‚"
    fi
}

# è®¾ç½® pm2 å¯åŠ¨è„šæœ¬ä»¥ä¾¿é‡å¯åæ¢å¤
function setup_pm2_startup() {
    echo "âœ… è®¾ç½® PM2 å¯åŠ¨è„šæœ¬ä»¥ç¡®ä¿æœåŠ¡æŒä¹…åŒ–..."
    if command -v pm2 >/dev/null 2>&1; then
        pm2 startup systemd || pm2 startup || echo "âš ï¸ PM2 startup å‘½ä»¤å¯èƒ½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®ï¼špm2 startup"
        pm2 save || echo "âš ï¸ PM2 save å‘½ä»¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œï¼špm2 save"
        echo "âœ… PM2 æœåŠ¡æŒä¹…åŒ–è®¾ç½®å®Œæˆã€‚"
    else
        echo "ğŸ”´ é”™è¯¯ï¼špm2 æœªå®‰è£…ï¼Œæ— æ³•è®¾ç½®æœåŠ¡æŒä¹…åŒ–ã€‚"
    fi
}

# æ„å»º Docker é•œåƒå‡½æ•°
function build_image() {
    echo "âš™ï¸ æ­£åœ¨æ„å»º Docker é•œåƒ: $IMAGE_NAME ..."
    WORKDIR=$(mktemp -d)
    trap "rm -rf \"$WORKDIR\"; cd -" EXIT # ç¡®ä¿é€€å‡ºæ—¶æ¸…ç†ä¸´æ—¶ç›®å½•
    cd "$WORKDIR"

    # Dockerfile
    cat > Dockerfile <<EOF
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PROVER_ID_FILE=/root/.nexus/node-id

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…æ‰€éœ€å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    screen \
    bash \
    procps \
    && rm -rf /var/lib/apt/lists/*

# è‡ªåŠ¨ä¸‹è½½å®‰è£…æœ€æ–°ç‰ˆ nexus-network
# ä½¿ç”¨ NONINTERACTIVE=1 é¿å…äº¤äº’å¼å®‰è£…
RUN curl -sSL https://cli.nexus.xyz/ | NONINTERACTIVE=1 sh \
    && ln -sf /root/.nexus/bin/nexus-network /usr/local/bin/nexus-network

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Docker HEALTHCHECK ç”¨äºæ£€æŸ¥å®¹å™¨å†…æœåŠ¡æ˜¯å¦è¿è¡Œ
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 CMD pgrep nexus-network >/dev/null || exit 1

ENTRYPOINT ["/entrypoint.sh"]
EOF

    # entrypoint.sh
    # å¼ºåŒ– entrypoint.shï¼Œå¤„ç†ä¼˜é›…é€€å‡ºï¼Œå¹¶ç¡®ä¿åå°è¿›ç¨‹
    cat > entrypoint.sh <<EOF
#!/bin/bash
set -e

PROVER_ID_FILE="/root/.nexus/node-id"
NEXUS_LOG_FILE="/root/nexus.log"

# æ¸…ç†å¯èƒ½çš„æ—§ screen ä¼šè¯
screen -S nexus -X quit >/dev/null 2>&1 || true

# æ£€æŸ¥ NODE_ID ç¯å¢ƒå˜é‡
if [ -z "\$NODE_ID" ]; then
    echo "é”™è¯¯ï¼šæœªè®¾ç½® NODE_ID ç¯å¢ƒå˜é‡"
    exit 1
fi

echo "\$NODE_ID" > "\$PROVER_ID_FILE"
echo "âœ… æ­£åœ¨ä½¿ç”¨ node-id: \$NODE_ID"

# æ£€æŸ¥ nexus-network å‘½ä»¤æ˜¯å¦å¯ç”¨
if ! command -v nexus-network >/dev/null 2>&1; then
    echo "é”™è¯¯ï¼šnexus-network æœªå®‰è£…æˆ–ä¸å¯ç”¨"
    exit 1
fi

# ä½¿ç”¨ trap æ•è· SIGTERM (Docker stop ä¿¡å·) ä»¥å®ç°ä¼˜é›…å…³é—­
function graceful_shutdown() {
    echo "ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å· (SIGTERM)ï¼Œå°è¯•ä¼˜é›…å…³é—­ nexus-network..."
    screen -S nexus -X stuff \$'\\x03' # å‘é€ Ctrl+C ç»™ screen ä¸­çš„è¿›ç¨‹
    sleep 5 # ç•™å‡ºæ—¶é—´è®©è¿›ç¨‹å“åº”
    screen -S nexus -X quit >/dev/null 2>&1 || true # å¼ºåˆ¶å…³é—­ screen ä¼šè¯
    echo "âœ… nexus-network è¿›ç¨‹å·²å°è¯•å…³é—­ã€‚"
    exit 0
}

trap graceful_shutdown SIGTERM

echo "ğŸš€ å¯åŠ¨ nexus-network èŠ‚ç‚¹..."
# screen -dmS nexus æ˜¯åœ¨åå°è¿è¡Œ screen ä¼šè¯ï¼Œè€Œä¸æ˜¯åœ¨ç»ˆç«¯ä¸­ï¼Œ
# Docker å®¹å™¨çš„ENTRYPOINTåº”åœ¨å‰ç«¯è¿è¡Œä»¥ä¿æŒå®¹å™¨æ´»åŠ¨ã€‚
# æˆ‘ä»¬éœ€è¦ç¡®ä¿nexus-networkè¿›ç¨‹ä¿æŒåœ¨â€œå‰å°â€ï¼Œæˆ–è€…é€šè¿‡tail -Fæ¥ç»´æŒã€‚
# nexus-network startå‘½ä»¤å¯èƒ½å·²ç»å°†è‡ªå·±ä½œä¸ºå­è¿›ç¨‹è¿è¡Œï¼Œå¹¶è¾“å‡ºåˆ°æ—¥å¿—ã€‚
# ä¸ºäº†ä¿æŒå®¹å™¨æ´»åŠ¨ï¼Œå¹¶æ”¶é›†å…¶æ—¥å¿—ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨tail -Fã€‚
# æ—¥å¿—é‡å®šå‘ç¡®ä¿æ‰€æœ‰è¾“å‡ºéƒ½è¿›å…¥nexus.logï¼Œä»¥ä¾¿é€šè¿‡ Docker æ—¥å¿—è¿›è¡Œç®¡ç†ã€‚
screen -dmS nexus bash -c "exec nexus-network start --node-id \$NODE_ID &>> \$NEXUS_LOG_FILE"

sleep 3 # ç¡®ä¿ nexus è¿›ç¨‹æœ‰è¶³å¤Ÿæ—¶é—´å¯åŠ¨

if screen -list | grep -q "nexus"; then
    echo "âœ… èŠ‚ç‚¹å·²åœ¨åå°å¯åŠ¨ (screenä¼šè¯)ã€‚"
    echo "ğŸ’¡ æ—¥å¿—æ–‡ä»¶ï¼š\$NEXUS_LOG_FILE"
    echo "ğŸ’¡ å¯ä»¥ä½¿ç”¨ 'docker logs <CONTAINER_NAME>' æŸ¥çœ‹æ—¥å¿—"
else
    echo "ğŸ”´ èŠ‚ç‚¹å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æˆ– entrypoint.shã€‚"
    cat "\$NEXUS_LOG_FILE"
    exit 1
fi

# ä¿æŒå®¹å™¨æ´»è·ƒï¼Œå¹¶ç¡®ä¿æ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬screenè¿›ç¨‹çš„ï¼‰éƒ½è¢«æ­£ç¡®æ•è·
# tail -F å¯ä»¥è·Ÿè¸ªæ—¥å¿—æ–‡ä»¶çš„è½®æ¢ (re-create/rename)
exec tail -F \$NEXUS_LOG_FILE
EOF

    docker build -t "$IMAGE_NAME" . || { echo "ğŸ”´ é”™è¯¯ï¼šDocker é•œåƒæ„å»ºå¤±è´¥ã€‚"; cd -; rm -rf "$WORKDIR"; exit 1; }
    echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ: $IMAGE_NAME"

    cd - >/dev/null
    rm -rf "$WORKDIR"
}

# å¯åŠ¨å®¹å™¨ï¼ˆæŒ‚è½½å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶ï¼‰
# å¢åŠ  --restart unless-stopped ç­–ç•¥
function run_container() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    local log_file="${LOG_DIR}/nexus-${node_id}.log"

    echo "âš™ï¸ å‡†å¤‡å¯åŠ¨å®¹å™¨ $container_name ..."

    if docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then
        echo "ğŸ” æ£€æµ‹åˆ°æ—§å®¹å™¨ $container_nameï¼Œæ­£åœ¨å°è¯•åœæ­¢å¹¶åˆ é™¤..."
        docker rm -f "$container_name" || echo "âš ï¸ æ— æ³•åˆ é™¤æ—§å®¹å™¨ $container_nameï¼Œä½†å¯èƒ½å·²ç»åœæ­¢æˆ–ä¸å­˜åœ¨ã€‚"
    fi

    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    mkdir -p "$LOG_DIR"
    
    # ç¡®ä¿å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶å­˜åœ¨å¹¶æœ‰å†™æƒé™ï¼Œä¸”ä¸æ˜¯ä¸€ä¸ªç›®å½•
    if [ -d "$log_file" ]; then
        echo "âš ï¸ æ£€æµ‹åˆ°æ—¥å¿—è·¯å¾„ $log_file ä¸ºç›®å½•ï¼Œæ­£åœ¨åˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ–‡ä»¶..."
        rm -rf "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ é™¤ç›®å½• $log_fileã€‚"; exit 1; }
    fi
    if [ ! -f "$log_file" ]; then
        touch "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæ—¥å¿—æ–‡ä»¶ $log_fileã€‚"; exit 1; }
        chmod 644 "$log_file" || { echo "ğŸ”´ é”™è¯¯ï¼šæ— æ³•è®¾ç½®æ—¥å¿—æ–‡ä»¶æƒé™ $log_fileã€‚"; exit 1; }
    fi

    echo "ğŸš€ å¯åŠ¨å®¹å™¨ $container_name ..."
    docker run -d --name "$container_name" \
        --restart unless-stopped \
        -v "$log_file":/root/nexus.log \
        -e NODE_ID="$node_id" \
        "$IMAGE_NAME" || { echo "ğŸ”´ é”™è¯¯ï¼šå®¹å™¨ $container_name å¯åŠ¨å¤±è´¥ã€‚"; exit 1; }
    echo "âœ… å®¹å™¨ $container_name å·²æˆåŠŸå¯åŠ¨ï¼"
}

# åœæ­¢å¹¶å¸è½½å®¹å™¨å’Œé•œåƒã€åˆ é™¤æ—¥å¿—
function uninstall_node() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    local log_file="${LOG_DIR}/nexus-${node_id}.log"

    echo "âš™ï¸ æ­£åœ¨åœæ­¢å¹¶åˆ é™¤å®¹å™¨ $container_name..."
    # ä½¿ç”¨ docker stop å°è¯•ä¼˜é›…å…³é—­ï¼Œå¦‚æœè¶…æ—¶åˆ™å¼ºåˆ¶åˆ é™¤
    docker stop -t 30 "$container_name" >/dev/null 2>&1 || true
    docker rm -f "$container_name" >/dev/null 2>&1 || echo "âš ï¸ å®¹å™¨ $container_name ä¸å­˜åœ¨æˆ–å·²åœæ­¢ï¼Œè·³è¿‡åˆ é™¤ã€‚"

    if [ -f "$log_file" ]; then
        echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤æ—¥å¿—æ–‡ä»¶ $log_file ..."
        rm -f "$log_file" || echo "âš ï¸ æ— æ³•åˆ é™¤æ—¥å¿—æ–‡ä»¶ $log_fileã€‚"
    else
        echo "â„¹ï¸ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼š$log_file"
    fi

    echo "âœ… èŠ‚ç‚¹ $node_id å·²å¸è½½å®Œæˆã€‚"
}

# æ˜¾ç¤ºæ‰€æœ‰è¿è¡Œä¸­çš„èŠ‚ç‚¹
function list_nodes() {
    echo "ğŸ“œ å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼š"
    echo "------------------------------------------------------------------------------------------------------------------------"
    printf "%-4s %-20s %-12s %-15s %-15s %-15s %-20s\n" "åºå·" "èŠ‚ç‚¹ID" "CPU" "å†…å­˜ä½¿ç”¨" "å†…å­˜é™åˆ¶" "çŠ¶æ€" "å¯åŠ¨æ—¶é—´"
    echo "------------------------------------------------------------------------------------------------------------------------"
    
    local all_nodes=($(get_all_nodes))
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "                      æ²¡æœ‰å‘ç°ä»»ä½• Nexus èŠ‚ç‚¹å®¹å™¨ã€‚                  "
        echo "------------------------------------------------------------------------------------------------------------------------"
    else
        for i in "${!all_nodes[@]}"; do
            local node_id=${all_nodes[$i]}
            local container_name="${BASE_CONTAINER_NAME}-${node_id}"
            local container_id=$(docker ps -a --filter "name=$container_name" --format "{{.ID}}" 2>/dev/null)
            
            if [ -n "$container_id" ]; then
                local container_info=$(docker stats --no-stream --format "{{.CPUPerc}},{{.MemUsage}},{{.MemPerc}},{{.Status}},{{.CreatedAt}}" "$container_id" 2>/dev/null)
                
                if [ -n "$container_info" ]; then
                    IFS=',' read -r cpu_usage mem_usage mem_perc status created_time <<< "$container_info"
                    
                    # mem_usage might include /mem_limit in the output already, split them if necessary
                    # docker stats format is "{{.MemUsage}}" e.g., "5.02MiB / 7.794GiB"
                    # mem_usage: 5.02MiB
                    # mem_limit: 7.794GiB
                    local current_mem=$(echo "$mem_usage" | cut -d' ' -f1)
                    local limit_mem=$(echo "$mem_usage" | cut -d' ' -f3)

                    printf "%-4d %-20s %-12s %-15s %-15s %-15s %-20s\n" \
                        $((i+1)) \
                        "$node_id" \
                        "$cpu_usage" \
                        "$current_mem" \
                        "$limit_mem" \
                        "$(echo "$status" | cut -d' ' -f1)" \
                        "$(date -d "$created_time" +'%Y-%m-%d %H:%M:%S')" # æ ¼å¼åŒ–æ—¶é—´
                else
                    # Docker stats command might fail for stopped containers or if docker daemon is busy
                    local status=$(docker inspect -f '{{.State.Status}}' "$container_id" 2>/dev/null || echo "N/A")
                    local created_time=$(docker inspect -f '{{.Created}}' "$container_id" 2>/dev/null || echo "N/A")
                    printf "%-4d %-20s %-12s %-15s %-15s %-15s %-20s\n" \
                        $((i+1)) \
                        "$node_id" \
                        "N/A" \
                        "N/A" \
                        "N/A" \
                        "$(echo "$status" | cut -d' ' -f1)" \
                        "$(date -d "$created_time" +'%Y-%m-%d %H:%M:%S')"
                fi
            else
                echo "â„¹ï¸ å®¹å™¨ $container_name ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å¼‚å¸¸çŠ¶æ€ã€‚"
            fi
        done
    fi
    echo "------------------------------------------------------------------------------------------------------------------------"
    echo "æç¤ºï¼š"
    echo "- CPU: æ˜¾ç¤ºå®¹å™¨CPUä½¿ç”¨ç™¾åˆ†æ¯”"
    echo "- å†…å­˜ä½¿ç”¨: æ˜¾ç¤ºå®¹å™¨å½“å‰ä½¿ç”¨çš„å†…å­˜"
    echo "- å†…å­˜é™åˆ¶: æ˜¾ç¤ºå®¹å™¨å†…å­˜ä½¿ç”¨é™åˆ¶"
    echo "- çŠ¶æ€: æ˜¾ç¤ºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€ (Up/Exited)"
    echo "- å¯åŠ¨æ—¶é—´: æ˜¾ç¤ºå®¹å™¨çš„åˆ›å»ºæ—¶é—´"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# è·å–æ‰€æœ‰è¿è¡Œä¸­çš„èŠ‚ç‚¹ID
function get_running_nodes() {
    docker ps --filter "name=${BASE_CONTAINER_NAME}" --filter "status=running" --format "{{.Names}}" | sed "s/${BASE_CONTAINER_NAME}-//"
}

# è·å–æ‰€æœ‰èŠ‚ç‚¹IDï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
function get_all_nodes() {
    docker ps -a --filter "name=${BASE_CONTAINER_NAME}" --format "{{.Names}}" | sed "s/${BASE_CONTAINER_NAME}-//"
}

# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
function view_node_logs() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"
    
    if ! docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then
        echo "ğŸ”´ é”™è¯¯ï¼šå®¹å™¨ $container_name ä¸å­˜åœ¨æˆ–å·²åœæ­¢ã€‚è¯·ç¡®è®¤ Node ID æˆ–å°è¯•å®‰è£…/å¯åŠ¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "è¯·é€‰æ‹©æ—¥å¿—æŸ¥çœ‹æ¨¡å¼ï¼š"
    echo "1. åŸå§‹æ—¥å¿—ï¼ˆå¯èƒ½åŒ…å«é¢œè‰²ä»£ç ï¼‰"
    echo "2. æ¸…ç†åçš„æ—¥å¿—ï¼ˆç§»é™¤é¢œè‰²ä»£ç ï¼‰"
    read -rp "è¯·é€‰æ‹©(1-2): " log_mode

    echo "â„¹ï¸ æŸ¥çœ‹æ—¥å¿—ä¸­ï¼ŒæŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹..."
    if [ "$log_mode" = "2" ]; then
        docker logs -f "$container_name" 2>&1 | sed 's/\x1b\[[0-9;]*m//g' | sed 's/\x1b\[?25l//g' | sed 's/\x1b\[?25h//g'
    else
        docker logs -f "$container_name"
    fi
}

# æ‰¹é‡å¯åŠ¨å¤šä¸ªèŠ‚ç‚¹ (å•æ¬¡å¯åŠ¨ï¼Œéè½®æ¢)
function batch_start_nodes() {
    echo "è¯·æ‰‹åŠ¨è¾“å…¥è¦å¯åŠ¨çš„ node-idï¼Œæ¯è¡Œä¸€ä¸ªï¼Œè¾“å…¥ç©ºè¡ŒåæŒ‰ Ctrl+D ç»“æŸè¾“å…¥ï¼š"
    
    local node_ids=()
    while read -r line; do
        if [ -n "$line" ]; then
            node_ids+=("$line")
        fi
    done

    if [ ${#node_ids[@]} -eq 0 ]; then
        echo "âš ï¸ æœªè¾“å…¥ä»»ä½• node-idï¼Œè¿”å›ä¸»èœå•ã€‚"
        read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
        return
    fi

    echo "âš™ï¸ å¼€å§‹æ„å»ºé•œåƒ..."
    build_image

    echo "ğŸš€ å¼€å§‹æ‰¹é‡å¯åŠ¨èŠ‚ç‚¹..."
    for node_id in "${node_ids[@]}"; do
        echo "â¡ï¸ æ­£åœ¨å¯åŠ¨èŠ‚ç‚¹ $node_id ..."
        run_container "$node_id"
        sleep 5  # æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å¯åŠ¨å¤ªå¤šå®¹å™¨å¯¼è‡´èµ„æºç¬æ—¶ç´§å¼ 
    done

    echo "âœ… æ‰€æœ‰æŒ‡å®šèŠ‚ç‚¹å¯åŠ¨å®Œæˆï¼"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# é€‰æ‹©è¦æŸ¥çœ‹çš„èŠ‚ç‚¹
function select_node_to_view() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "è¯·é€‰æ‹©è¦æŸ¥çœ‹æ—¥å¿—çš„èŠ‚ç‚¹ï¼š"
    echo "0. è¿”å›ä¸»èœå•"
    for i in "${!all_nodes[@]}"; do
        local node_id=${all_nodes[$i]}
        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local status=$(docker ps -a --filter "name=$container_name" --format "{{.Status}}" 2>/dev/null)
        if [[ $status == Up* ]]; then
            echo "$((i+1)). èŠ‚ç‚¹ $node_id [è¿è¡Œä¸­]"
        else
            echo "$((i+1)). èŠ‚ç‚¹ $node_id [å·²åœæ­¢]"
        fi
    done

    read -rp "è¯·è¾“å…¥é€‰é¡¹(0-${#all_nodes[@]}): " choice

    if [ "$choice" = "0" ]; then
        return
    fi

    if [ "$choice" -ge 1 ] && [ "$choice" -le ${#all_nodes[@]} ]; then
        local selected_node=${all_nodes[$((choice-1))]}
        view_node_logs "$selected_node"
    else
        echo "ğŸ”´ æ— æ•ˆçš„é€‰é¡¹ã€‚"
        read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
    fi
}

# æ‰¹é‡åœæ­¢å¹¶å¸è½½èŠ‚ç‚¹
function batch_uninstall_nodes() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "ğŸ“œ å½“å‰èŠ‚ç‚¹åˆ—è¡¨ï¼š"
    echo "----------------------------------------"
    printf "%-4s %-20s %s\n" "åºå·" "èŠ‚ç‚¹ID" "çŠ¶æ€"
    echo "----------------------------------------"
    for i in "${!all_nodes[@]}"; do
        local node_id=${all_nodes[$i]}
        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local status=$(docker ps -a --filter "name=$container_name" --format "{{.Status}}" 2>/dev/null)
        if [[ $status == Up* ]]; then
            printf "%-4d %-20s [è¿è¡Œä¸­]\n" $((i+1)) "$node_id"
        else
            printf "%-4d %-20s [å·²åœæ­¢]\n" $((i+1)) "$node_id"
        fi
    done
    echo "----------------------------------------"

    echo "ğŸ—‘ï¸ è¯·é€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼ˆå¯å¤šé€‰ï¼Œè¾“å…¥æ•°å­—ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š"
    echo "0. è¿”å›ä¸»èœå•"
    
    read -rp "è¯·è¾“å…¥é€‰é¡¹(0 æˆ– æ•°å­—ï¼Œç”¨ç©ºæ ¼åˆ†éš”): " choices

    if [ "$choices" = "0" ]; then
        echo "âŒ æ“ä½œå·²å–æ¶ˆã€‚"
        return
    fi

    # å°†è¾“å…¥çš„é€‰é¡¹è½¬æ¢ä¸ºæ•°ç»„
    read -ra selected_choices <<< "$choices"
    
    # éªŒè¯è¾“å…¥å¹¶æ‰§è¡Œå¸è½½
    for choice in "${selected_choices[@]}"; do
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#all_nodes[@]} ]; then
            local selected_node=${all_nodes[$((choice-1))]}
            echo "â¡ï¸ æ­£åœ¨å¸è½½èŠ‚ç‚¹ $selected_node ..."
            uninstall_node "$selected_node"
        else
            echo "âš ï¸ è·³è¿‡æ— æ•ˆé€‰é¡¹: $choice"
        fi
    done

    echo "âœ… æ‰¹é‡å¸è½½å®Œæˆï¼"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# åˆ é™¤å…¨éƒ¨èŠ‚ç‚¹
function uninstall_all_nodes() {
    local all_nodes=($(get_all_nodes))
    
    if [ ${#all_nodes[@]} -eq 0 ]; then
        echo "âš ï¸ å½“å‰æ²¡æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "â€¼ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ Nexus èŠ‚ç‚¹å®¹å™¨åŠå…¶ç›¸å…³æ—¥å¿—ï¼"
    echo "å½“å‰å…±æœ‰ ${#all_nodes[@]} ä¸ªèŠ‚ç‚¹å¾…åˆ é™¤ï¼š"
    for node_id in "${all_nodes[@]}"; do
        echo "- $node_id"
    done
    
    read -rp "ç¡®å®šè¦åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼(y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "âŒ æ“ä½œå·²å–æ¶ˆã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi

    echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹..."
    for node_id in "${all_nodes[@]}"; do
        echo "â¡ï¸ æ­£åœ¨å¸è½½èŠ‚ç‚¹ $node_id ..."
        uninstall_node "$node_id"
    done

    echo "âœ… æ‰€æœ‰èŠ‚ç‚¹å·²åˆ é™¤å®Œæˆï¼"
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# è®¾ç½®é»˜è®¤çš„è‡ªåŠ¨æ¸…ç†ä»»åŠ¡ï¼ˆPM2 ç®¡ç†ï¼‰
function setup_default_auto_cleanup() {
    local days=7 # é»˜è®¤ä¿ç•™7å¤©çš„æ—¥å¿—
    
    echo "âš™ï¸ æ­£åœ¨è®¾ç½®è‡ªåŠ¨æ—¥å¿—æ¸…ç†ï¼ˆä¿ç•™æœ€è¿‘ $days å¤©çš„æ—¥å¿—ï¼‰..."
    
    # ç¡®ä¿ pm2 å·²å®‰è£…
    check_node_pm2
    
    local script_dir="/root/nexus_scripts"
    mkdir -p "$script_dir" 2>/dev/null || true # å…è®¸ç›®å½•å·²å­˜åœ¨

    local cleanup_script_path="$script_dir/cleanup_logs.sh"
    cat > "$cleanup_script_path" <<EOF
#!/bin/bash
set -e

LOG_DIR="$LOG_DIR"
DAYS_TO_KEEP=$days

if [ -d "\$LOG_DIR" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] è¿è¡Œ Nexus æ—¥å¿—æ¸…ç†ç¨‹åº..."
    # æŸ¥æ‰¾å¹¶åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—¥å¿—æ–‡ä»¶
    find "\$LOG_DIR" -name "*.log" -type f -mtime +\$DAYS_TO_KEEP -print -delete
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Nexus æ—¥å¿—æ¸…ç†å®Œæˆã€‚"
fi
EOF
    chmod +x "$cleanup_script_path"
    
    # åœæ­¢æ—§çš„æ¸…ç†ä»»åŠ¡
    pm2 delete nexus-cleanup 2>/dev/null || true
    
    # ä½¿ç”¨ pm2 å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡
    pm2 start "$cleanup_script_path" --name "nexus-cleanup" --no-autorestart --cron-restart "0 0 * * *" -- "$LOG_DIR" "$days" # æ¯å¤©0ç‚¹æ‰§è¡Œ
    pm2 save
    
    echo "âœ… è‡ªåŠ¨æ—¥å¿—æ¸…ç†ä»»åŠ¡å·²æˆåŠŸè®¾ç½®ï¼å°†æ¯å¤©æ¸…ç†è¶…è¿‡ $days å¤©çš„æ—¥å¿—ã€‚"
    echo "   ä½¿ç”¨ 'pm2 status' æŸ¥çœ‹æ¸…ç†ä»»åŠ¡çŠ¶æ€ã€‚"
    echo "   ä½¿ç”¨ 'pm2 logs nexus-cleanup' æŸ¥çœ‹æ¸…ç†æ—¥å¿—ã€‚"
}

# æ‰¹é‡èŠ‚ç‚¹è½®æ¢å¯åŠ¨ (é€šè¿‡ PM2 è°ƒåº¦ï¼Œç¡®ä¿ç¨³å®šæ€§)
function batch_rotate_nodes() {
    echo "ğŸ”„ å¯åŠ¨æ‰¹é‡èŠ‚ç‚¹è½®æ¢æ¨¡å¼"
    echo "â„¹ï¸ è¾“å…¥å¤šä¸ª node-idï¼Œæ¯è¡Œä¸€ä¸ªï¼Œè¾“å…¥ç©ºè¡ŒåæŒ‰ Ctrl+D ç»“æŸè¾“å…¥ï¼š"
    
    local node_ids=()
    while read -r line; do
        if [ -n "$line" ]; then
            node_ids+=("$line")
        fi
    done

    if [ ${#node_ids[@]} -eq 0 ]; then
        echo "âš ï¸ æœªè¾“å…¥ä»»ä½• node-idï¼Œè¿”å›ä¸»èœå•ã€‚"
        read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
        return
    fi

    # è®¾ç½®æ¯ä¸¤å°æ—¶å¯åŠ¨çš„èŠ‚ç‚¹æ•°é‡
    local default_nodes_per_round=$(( (${#node_ids[@]} + 1) / 2 )) # é»˜è®¤ä¸€åŠï¼Œå‘ä¸Šå–æ•´
    read -rp "è¯·è¾“å…¥æ¯ä¸¤å°æ—¶è¦å¯åŠ¨çš„èŠ‚ç‚¹æ•°é‡ï¼ˆé»˜è®¤ï¼š${default_nodes_per_round}ï¼‰: " nodes_per_round
    if [ -z "$nodes_per_round" ]; then
        nodes_per_round="$default_nodes_per_round"
    fi

    # éªŒè¯è¾“å…¥
    if ! [[ "$nodes_per_round" =~ ^[0-9]+$ ]] || [ "$nodes_per_round" -lt 1 ]; then
        echo "ğŸ”´ æ— æ•ˆçš„èŠ‚ç‚¹æ•°é‡ï¼Œè¯·è¾“å…¥æ­£æ•´æ•°ã€‚"
        read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
        return
    fi
    if [ "$nodes_per_round" -gt ${#node_ids[@]} ]; then
        echo "âš ï¸ è­¦å‘Šï¼šè®¾å®šçš„æ¯æ‰¹å¯åŠ¨æ•°é‡ ($nodes_per_round) è¶…è¿‡äº†æ€»èŠ‚ç‚¹æ•° (${#node_ids[@]})ã€‚å°†æŒ‰æ€»èŠ‚ç‚¹æ•°å¤„ç†ã€‚"
        nodes_per_round=${#node_ids[@]}
    fi

    # è®¡ç®—éœ€è¦å¤šå°‘ç»„
    local total_nodes=${#node_ids[@]}
    local num_groups=$(( (total_nodes + nodes_per_round - 1) / nodes_per_round ))
    echo "âœ… èŠ‚ç‚¹æ€»æ•°: $total_nodes ä¸ªï¼Œå°†åˆ†ä¸º $num_groups ç»„è¿›è¡Œè½®æ¢ã€‚"
    echo "   æ¯ç»„å°†å¯åŠ¨ $nodes_per_round ä¸ªèŠ‚ç‚¹ï¼ˆæœ€åä¸€ç»„å¯èƒ½ä¸è¶³ï¼‰ã€‚"

    # æ£€æŸ¥å¹¶å®‰è£… Node.js å’Œ pm2
    check_node_pm2
    # ç¡®ä¿ pm2 æŒä¹…åŒ–è®¾ç½®
    setup_pm2_startup

    echo "âš™ï¸ å¼€å§‹æ„å»ºé•œåƒ..."
    build_image

    # åˆ›å»ºå¯åŠ¨è„šæœ¬ç›®å½•
    local script_dir="/root/nexus_scripts"
    mkdir -p "$script_dir" 2>/dev/null || true # å…è®¸ç›®å½•å·²å­˜åœ¨

    # æ¸…ç†æ—§çš„ç»„å¯åŠ¨è„šæœ¬
    rm -f "$script_dir/start_group_batch_*.sh"

    # ä¸ºæ¯ç»„åˆ›å»ºå¯åŠ¨è„šæœ¬
    for ((group=1; group<=num_groups; group++)); do
        local start_script="$script_dir/start_group_batch_${group}.sh"
        cat > "$start_script" <<EOF
#!/bin/bash
set -e

echo "[$(date '+%Y-%m-%d %H:%M:%S')] â¡ï¸ å¼€å§‹å¤„ç†ç¬¬${group}ç»„èŠ‚ç‚¹..."
# IMPORTANT: è¿™é‡Œä¸å†æ˜¯ 'åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰ç°æœ‰å®¹å™¨'
# è€Œæ˜¯é’ˆå¯¹æœ¬æ‰¹æ¬¡è¦å¯åŠ¨çš„ç‰¹å®š NODE_ID è¿›è¡Œå¤„ç†
EOF
        # è®¾ç½®æƒé™
        chmod +x "$start_script"
    done

    # æ·»åŠ èŠ‚ç‚¹åˆ°å¯¹åº”çš„å¯åŠ¨è„šæœ¬
    for i in "${!node_ids[@]}"; do
        local node_id=${node_ids[$i]}
        local container_name="${BASE_CONTAINER_NAME}-${node_id}"
        local log_file="${LOG_DIR}/nexus-${node_id}.log"
        
        # è®¡ç®—èŠ‚ç‚¹å±äºå“ªä¸€ç»„
        local group_num=$(( i / nodes_per_round + 1 ))
        if [ "$group_num" -gt "$num_groups" ]; then
            group_num=$num_groups
        fi
        
        # ç¡®ä¿æ—¥å¿—ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨ä¸”æ˜¯æ–‡ä»¶
        mkdir -p "$LOG_DIR" 2>/dev/null || true # å…è®¸ç›®å½•å·²å­˜åœ¨
        if [ -d "$log_file" ]; then
            rm -rf "$log_file" || echo "âš ï¸ æ— æ³•åˆ é™¤ç›®å½• $log_fileã€‚"
        fi
        if [ ! -f "$log_file" ]; then
            touch "$log_file" || echo "ğŸ”´ æ— æ³•åˆ›å»ºæ—¥å¿—æ–‡ä»¶ $log_fileã€‚"
            chmod 644 "$log_file" || echo "ğŸ”´ æ— æ³•è®¾ç½®æ—¥å¿—æ–‡ä»¶æƒé™ $log_fileã€‚"
        fi

        # å°†å¯åŠ¨é€»è¾‘å†™å…¥å¯¹åº”çš„ç»„è„šæœ¬
        local start_script="$script_dir/start_group_batch_${group_num}.sh"
        cat >> "$start_script" <<EOF
echo "[$(date '+%Y-%m-%d %H:%M:%S')] å‡†å¤‡å¯åŠ¨æˆ–æ›´æ–°èŠ‚ç‚¹ $node_id ..."
# å¦‚æœå®¹å™¨å­˜åœ¨ï¼Œåˆ™åœæ­¢å¹¶åˆ é™¤ï¼Œç¡®ä¿æ˜¯å¹²å‡€å¯åŠ¨
docker stop -t 30 "${container_name}" >/dev/null 2>&1 || true
docker rm -f "${container_name}" >/dev/null 2>&1 || true

docker run -d --name "${container_name}" \
    --restart unless-stopped \
    -v "$log_file":/root/nexus.log \
    -e NODE_ID="$node_id" \
    "$IMAGE_NAME"

# ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿Dockerå‘½ä»¤å®Œæˆ
sleep 5
EOF
    done

    # åˆ›å»ºè½®æ¢ä¸»è°ƒåº¦è„šæœ¬
    local rotate_scheduler_path="$script_dir/rotate_scheduler.sh"
    cat > "$rotate_scheduler_path" <<EOF
#!/bin/bash
set -e

GROUPS_COUNT=$num_groups
CURRENT_GROUP=0
TWO_HOURS_IN_SECONDS=7200 # 2å°æ—¶

while true; do
    CURRENT_GROUP=\$(( (CURRENT_GROUP % GROUPS_COUNT) + 1 ))
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸš€ æ­£åœ¨è½®æ¢è‡³ç¬¬\$CURRENT_GROUPç»„ (å…± \$GROUPS_COUNT ç»„)..."
    bash "$script_dir/start_group_batch_\${CURRENT_GROUP}.sh"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] âœ… ç¬¬\$CURRENT_GROUPç»„èŠ‚ç‚¹å¯åŠ¨/æ›´æ–°å®Œæˆã€‚ä¸‹ä¸€æ¬¡è½®æ¢å°†åœ¨ ${TWO_HOURS_IN_SECONDS} ç§’åè¿›è¡Œã€‚"
    sleep \$TWO_HOURS_IN_SECONDS
done
EOF
    chmod +x "$rotate_scheduler_path"

    # åˆ é™¤æ—§çš„è½®æ¢è¿›ç¨‹
    echo "ğŸ”„ åœæ­¢æ—§çš„è½®æ¢è¿›ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰..."
    pm2 delete nexus-rotate 2>/dev/null || true

    # ä½¿ç”¨ pm2 å¯åŠ¨è½®æ¢è„šæœ¬
    echo "ğŸš€ ä½¿ç”¨ PM2 å¯åŠ¨èŠ‚ç‚¹è½®æ¢è°ƒåº¦ç¨‹åº..."
    pm2 start "$rotate_scheduler_path" --name "nexus-rotate"
    pm2 save

    echo "âœ… èŠ‚ç‚¹è½®æ¢è°ƒåº¦ç¨‹åºå·²å¯åŠ¨ï¼"
    echo "   æ€»å…± $total_nodes ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸º $num_groups ç»„"
    echo "   æ¯æ‰¹æ¬¡å¤„ç† $nodes_per_round ä¸ªèŠ‚ç‚¹ï¼ˆæœ€åä¸€ç»„å¯èƒ½ä¸è¶³ï¼‰ã€‚"
    echo "   è½®æ¢å°†æ¯2å°æ—¶è¿›è¡Œä¸€æ¬¡ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„èŠ‚ç‚¹ã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 status' æŸ¥çœ‹è½®æ¢è°ƒåº¦ç¨‹åºè¿è¡ŒçŠ¶æ€ã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 logs nexus-rotate' æŸ¥çœ‹è½®æ¢æ—¥å¿—ã€‚"
    echo "   ğŸ’¡ ä½¿ç”¨ 'pm2 stop nexus-rotate' åœæ­¢è½®æ¢è°ƒåº¦ç¨‹åºã€‚"

    # æ·»åŠ è‡ªåŠ¨æ¸…ç†ä»»åŠ¡
    setup_default_auto_cleanup
    
    read -rp "æŒ‰ä»»æ„é”®è¿”å›èœå•"
}

# === ä¸»èœå• ===
function main_menu() {
    while true; do
        clear
        echo "=========================================================="
        echo "               ç”± å“ˆå“ˆå“ˆå“ˆ ç¼–å†™ - @ferdie_jhovie          "
        echo "                  å…è´¹å¼€æºï¼Œè°¨é˜²æ”¶è´¹æ¬ºè¯ˆï¼                 "
        echo "=========================================================="
        echo "                 âœ¨ Nexus å¤šèŠ‚ç‚¹ç®¡ç†å·¥å…· âœ¨              "
        echo "----------------------------------------------------------"
        echo " 1. ğŸš€ æ‰¹é‡èŠ‚ç‚¹è½®æ¢å¯åŠ¨ (é€šè¿‡PM2å‘¨æœŸæ€§å¯åŠ¨æ‰¹æ¬¡)"
        echo " 2. ğŸ“Š æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ (CPU/å†…å­˜/çŠ¶æ€ç­‰)"
        echo " 3. ğŸ—‘ï¸ æ‰¹é‡åœæ­¢å¹¶å¸è½½æŒ‡å®šèŠ‚ç‚¹"
        echo " 4. ğŸ“„ æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹æ—¥å¿—"
        echo " 5. ğŸš¨ åˆ é™¤å…¨éƒ¨èŠ‚ç‚¹ (å±é™©æ“ä½œï¼Œä¸å¯é€†)"
        echo " 6. ğŸšª é€€å‡ºè„šæœ¬"
        echo "----------------------------------------------------------"

        read -rp "è¯·è¾“å…¥é€‰é¡¹(1-6): " choice

        case $choice in
            1)
                check_docker
                batch_rotate_nodes
                ;;
            2)
                list_nodes
                ;;
            3)
                batch_uninstall_nodes
                ;;
            4)
                select_node_to_view
                ;;
            5)
                uninstall_all_nodes
                ;;
            6)
                echo "æ„Ÿè°¢ä½¿ç”¨ï¼å†è§ ğŸ‘‹ã€‚"
                exit 0
                ;;
            *)
                echo "ğŸ”´ æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚"
                read -rp "æŒ‰ä»»æ„é”®ç»§ç»­"
                ;;
        esac
    done
}

# è¿è¡Œä¸»èœå•
main_menu
