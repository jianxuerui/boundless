#!/bin/bash
set -e

# =========================================================================================
# Nexus å¤šèŠ‚ç‚¹ç®¡ç†è„šæœ¬ (ARM64 Dockerç‰ˆ) - 8æ ¸16G æé™ä¼˜åŒ–ç‰ˆ
# ä½œè€…: å“ˆå“ˆå“ˆå“ˆ (æ¨ç‰¹ @ferdie_jhovie)
# ä¼˜åŒ–: AI Assistant
# æè¿°: æ­¤è„šæœ¬ä¸º 8æ ¸/16G RAM æœåŠ¡å™¨è¿è¡Œ 3ä¸ª Nexus èŠ‚ç‚¹æä¾›æè‡´æ€§èƒ½ä¼˜åŒ–ã€‚
#       ã€V5 ç»ˆæä¼˜åŒ–ã€‘:
#       1. ã€ä¸€é”®éƒ¨ç½²ã€‘: æ–°å¢æ¨èæ–¹æ¡ˆï¼Œä¸€é”®éƒ¨ç½²ä¸º 8C/16G ä¼˜åŒ–çš„3ä¸ªèŠ‚ç‚¹ã€‚
#       2. ã€èµ„æºå‹æ¦¨ã€‘: é¢„è®¾æ¿€è¿›çš„CPU(2.5æ ¸)ä¸å†…å­˜(4G)é™åˆ¶ï¼Œå……åˆ†åˆ©ç”¨ç¡¬ä»¶æ€§èƒ½ã€‚
#       3. ã€ç²¾ç®€æ„å»ºã€‘: ä½¿ç”¨ 'docker build -f -' æŠ€æœ¯ï¼Œæ„å»ºè¿‡ç¨‹æ— éœ€æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ã€‚
#       4. ã€å¢å¼ºç›‘æ§ã€‘: èŠ‚ç‚¹åˆ—è¡¨ç›´æ¥æ˜¾ç¤ºå†…å­˜ä½¿ç”¨é‡å’Œåˆ†é…ä¸Šé™ï¼Œæ¸…æ™°æ˜äº†ã€‚
# =========================================================================================

# --- é…ç½®é¡¹ ---
BASE_CONTAINER_NAME="nexus-node-pro"
IMAGE_NAME="nexus-node:latest-arm64-pro-optimized"
BUILDER_NAME="nexus_builder"

# --- 8æ ¸16GæœåŠ¡å™¨ï¼Œ3èŠ‚ç‚¹ä¼˜åŒ–é…ç½® ---
# CPU: (8æ ¸ - 0.5æ ¸ç•™ç»™ç³»ç»Ÿ) / 3èŠ‚ç‚¹ = 2.5æ ¸/èŠ‚ç‚¹
CPU_LIMIT="2.5"
# å†…å­˜: (16G - 2Gç•™ç»™ç³»ç»Ÿ) / 3èŠ‚ç‚¹ â‰ˆ 4.6G/èŠ‚ç‚¹ã€‚æˆ‘ä»¬è®¾ç½®ä¸º4Gï¼Œç•™æœ‰ä½™é‡ã€‚
MEMORY_LIMIT="4g"
# æ¨èçš„ä¸€é”®éƒ¨ç½²èŠ‚ç‚¹IDåˆ—è¡¨
RECOMMENDED_NODE_IDS=("nexus-jupiter" "nexus-saturn" "nexus-neptune")

# --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

# check_docker å’Œ setup_buildx å‡½æ•°ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œä¿æŒä¸å˜
function check_docker() { if ! command -v docker >/dev/null 2>&1; then echo "æ£€æµ‹åˆ°æœªå®‰è£… Dockerï¼Œæ­£åœ¨ä¸ºæ‚¨å®‰è£…..." >&2; sudo apt-get update && sudo apt-get install -y ca-certificates curl && sudo install -m 0755 -d /etc/apt/keyrings && sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc && sudo chmod a+r /etc/apt/keyrings/docker.asc && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin && sudo systemctl enable docker && sudo systemctl start docker && echo "Docker å®‰è£…å®Œæˆï¼"; fi; if ! docker buildx version >/dev/null 2>&1; then echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Docker buildx æ’ä»¶ã€‚è¯·ç¡®ä¿æ‚¨çš„ Docker ç‰ˆæœ¬åŒ…å« buildxã€‚" >&2; exit 1; fi; }
function setup_buildx() { if docker buildx ls | grep -q "${BUILDER_NAME}.*running"; then docker buildx use $BUILDER_NAME; return; fi; echo "æ£€æµ‹åˆ°éœ€è¦è®¾ç½®è·¨å¹³å°æ„å»ºç¯å¢ƒ (QEMU)..."; if docker buildx ls | grep -q "$BUILDER_NAME"; then docker buildx inspect $BUILDER_NAME --bootstrap; else docker buildx create --name $BUILDER_NAME --driver docker-container --use; fi; if ! docker run --rm --privileged tonistiigi/binfmt | grep -q "setting up"; then docker run --rm --privileged tonistiigi/binfmt --install all; fi; echo "Buildx ç¯å¢ƒè®¾ç½®å®Œæˆã€‚"; }

# ã€V5 ä¼˜åŒ–ã€‘æ„å»º Docker é•œåƒï¼Œæ— éœ€ä¸´æ—¶æ–‡ä»¶
function build_image() {
    if docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
        echo "é•œåƒ $IMAGE_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»ºã€‚"
        return
    fi
    
    setup_buildx
    echo "æ­£åœ¨å‡†å¤‡æ„å»ºç¯å¢ƒ (æ— ä¸´æ—¶æ–‡ä»¶æ¨¡å¼)..."

    # å°† entrypoint.sh çš„å†…å®¹å­˜å‚¨åœ¨å˜é‡ä¸­
    local entrypoint_script
    read -r -d '' entrypoint_script <<'EOF'
#!/bin/sh
set -e
if [ -z "$NODE_ID" ]; then echo "é”™è¯¯ï¼šç¼ºå°‘ NODE_ID ç¯å¢ƒå˜é‡ï¼" >&2; exit 1; fi
mkdir -p /root/.nexus && echo "$NODE_ID" > /root/.nexus/node-id
echo "èŠ‚ç‚¹ [ $NODE_ID ] é…ç½®å®Œæˆï¼Œå¯åŠ¨ä¸»è¿›ç¨‹..."
echo "æ—¥å¿—å°†ç”± Docker æ•è·, ä½¿ç”¨ 'docker logs <å®¹å™¨å>' æŸ¥çœ‹ã€‚"
exec nexus-network start --node-id "$NODE_ID"
EOF

    echo "æ­£åœ¨ä½¿ç”¨ builder '$BUILDER_NAME' æ„å»ºé•œåƒ $IMAGE_NAME..."
    # ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ here-document ç›´æ¥å°† Dockerfile å†…å®¹ä¼ ç»™ build å‘½ä»¤
    # åŒæ—¶ï¼Œå°† entrypoint è„šæœ¬å†…å®¹é€šè¿‡ build context ä¼ é€’è¿›å»
    docker buildx build --builder $BUILDER_NAME --platform linux/arm64 -t "$IMAGE_NAME" --load -f- . <<EOF
ARG TARGETPLATFORM=linux/arm64
FROM --platform=\$TARGETPLATFORM alpine:latest

# å®‰è£…ä¾èµ–å¹¶ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
RUN apk add --no-cache curl bash ca-certificates \
    && curl -L -o /usr/local/bin/nexus-network https://github.com/nexus-xyz/nexus-cli/releases/download/v0.10.1/nexus-network-linux-arm64 \
    && chmod +x /usr/local/bin/nexus-network

# å¤åˆ¶ entrypoint.sh
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
EOF
    echo "é•œåƒ $IMAGE_NAME æ„å»ºå®Œæˆï¼"
}

# run_container å‡½æ•°ä¸ä¹‹å‰ç‰ˆæœ¬ç±»ä¼¼ï¼Œä½†å¼ºè°ƒäº†èµ„æºé…ç½®
function run_container() {
    local node_id=$1
    local container_name="${BASE_CONTAINER_NAME}-${node_id}"

    if docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then
        echo "èŠ‚ç‚¹ $node_id (å®¹å™¨ $container_name) å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤æ—§å®¹å™¨..."
        docker rm -f "$container_name"
    fi
    
    echo "æ­£åœ¨å¯åŠ¨å®¹å™¨ $container_name..."
    echo "  -> åˆ†é…èµ„æº: ${CPU_LIMIT} CPU æ ¸å¿ƒ, ${MEMORY_LIMIT} å†…å­˜"
    
    docker run -d --name "$container_name" \
        -e NODE_ID="$node_id" \
        --cpus="$CPU_LIMIT" \
        --memory="$MEMORY_LIMIT" \
        --restart unless-stopped \
        "$IMAGE_NAME"
    
    echo "å®¹å™¨ $container_name å·²å¯åŠ¨ï¼ä½¿ç”¨ 'docker logs -f $container_name' æŸ¥çœ‹ã€‚"
}


# ã€V5 ä¼˜åŒ–ã€‘ä¸€é”®éƒ¨ç½²æ¨èæ–¹æ¡ˆ
function deploy_recommended_setup() {
    echo "å³å°†ä¸ºæ‚¨ä¸€é”®éƒ¨ç½²ä¸º 8æ ¸/16G ä¼˜åŒ–çš„ 3 èŠ‚ç‚¹æ–¹æ¡ˆ..."
    echo "å°†åˆ›å»ºä»¥ä¸‹èŠ‚ç‚¹ï¼š"
    printf " - %s\n" "${RECOMMENDED_NODE_IDS[@]}"
    echo "æ¯ä¸ªèŠ‚ç‚¹å°†è¢«åˆ†é… ${CPU_LIMIT} ä¸ªCPUæ ¸å¿ƒ å’Œ ${MEMORY_LIMIT} çš„å†…å­˜ã€‚"
    read -rp "æ˜¯å¦ç»§ç»­ï¼Ÿ [y/N]: " confirmation
    if [[ "$confirmation" != "y" && "$confirmation" != "Y" ]]; then
        echo "æ“ä½œå·²å–æ¶ˆã€‚"
        return
    fi

    # 1. ç¡®ä¿é•œåƒå·²æ„å»º
    build_image
    
    # 2. å¾ªç¯å¯åŠ¨æ‰€æœ‰æ¨èèŠ‚ç‚¹
    echo "å¼€å§‹æ‰¹é‡å¯åŠ¨å®¹å™¨..."
    for node_id in "${RECOMMENDED_NODE_IDS[@]}"; do
        run_container "$node_id"
        sleep 1 # çŸ­æš‚é—´éš”ï¼Œé¿å…åŒæ—¶è¯·æ±‚ Docker API
    done
    
    echo "=========================================="
    echo "ğŸš€ æ‰€æœ‰æ¨èèŠ‚ç‚¹å·²éƒ¨ç½²å¹¶å¯åŠ¨ï¼"
    echo "=========================================="
}


# ã€V5 ä¼˜åŒ–ã€‘å¢å¼ºçš„èŠ‚ç‚¹åˆ—è¡¨æ˜¾ç¤º
function list_nodes() {
    echo "------------------------------------- å½“å‰ Nexus èŠ‚ç‚¹çŠ¶æ€ --------------------------------------"
    printf "%-28s %-15s %-15s %-25s\n" "èŠ‚ç‚¹ ID (å®¹å™¨å)" "çŠ¶æ€" "CPU % (ä¸»æœº)" "å†…å­˜ä½¿ç”¨ / ä¸Šé™"
    echo "------------------------------------------------------------------------------------------------"
    
    containers=$(docker ps -a --filter "name=${BASE_CONTAINER_NAME}-*" --format "{{.Names}}")

    if [ -z "$containers" ]; then
        echo "æœªæ‰¾åˆ°ä»»ä½• Nexus èŠ‚ç‚¹å®¹å™¨ã€‚"
    else
        # ä¼˜åŒ–æ˜¾ç¤ºï¼Œä¸€æ¬¡æ€§è·å–æ‰€æœ‰è¿è¡Œä¸­å®¹å™¨çš„stats
        stats_output=$(docker stats --no-stream --filter "name=${BASE_CONTAINER_NAME}-*" --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemLimit}}")
        
        for name in $containers; do
            status=$(docker ps -a --filter "name=$name" --format "{{.Status}}")
            node_id=$(echo "$name" | sed "s/^${BASE_CONTAINER_NAME}-//")
            
            stats_line=$(echo "$stats_output" | grep -w "$name")
            if [[ -n "$stats_line" && "$status" == Up* ]]; then
                cpu_perc=$(echo "$stats_line" | awk '{print $2}')
                mem_usage=$(echo "$stats_line" | awk '{print $3 " " $4 " " $5}')
                mem_limit=$(echo "$stats_line" | awk '{print $6 " " $7}')
                
                printf "%-28s %-15s %-15s %-25s\n" "$node_id ($name)" "$status" "$cpu_perc" "${mem_usage} / ${mem_limit}"
            else
                printf "%-28s %-15s %-15s %-25s\n" "$node_id ($name)" "$status" "N/A" "N/A"
            fi
        done
    fi
    echo "------------------------------------------------------------------------------------------------"
}

# å…¶ä»–è¾…åŠ©å‡½æ•°åŸºæœ¬ä¿æŒä¸å˜ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´çœç•¥äº†ä»£ç ï¼Œå®ƒä»¬ä¸V4ç‰ˆæœ¬ç›¸åŒã€‚
# æ‚¨å¯ä»¥ä»V4ç‰ˆæœ¬æ‹·è´è¿‡æ¥ï¼Œæˆ–è€…ä½¿ç”¨ä¸‹é¢çš„ç®€åŒ–ç‰ˆ
function get_all_node_ids() { docker ps -a --filter "name=${BASE_CONTAINER_NAME}-*" --format "{{.Names}}" | sed "s/^${BASE_CONTAINER_NAME}-//" | sort -u; }
function uninstall_node() { local node_id=$1; local container_name="${BASE_CONTAINER_NAME}-${node_id}"; echo "æ­£åœ¨åœæ­¢å¹¶åˆ é™¤å®¹å™¨ $container_name..."; if docker rm -f "$container_name" >/dev/null 2>&1; then echo "å®¹å™¨å·²åˆ é™¤ã€‚"; else echo "å®¹å™¨ä¸å­˜åœ¨ã€‚"; fi; }
function view_node_logs() { local node_id=$1; local container_name="${BASE_CONTAINER_NAME}-${node_id}"; if ! docker ps -a --format '{{.Names}}' | grep -qw "$container_name"; then echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°èŠ‚ç‚¹ $node_id çš„å®¹å™¨ã€‚"; return 1; fi; echo "æ˜¾ç¤ºèŠ‚ç‚¹ '$node_id' çš„æ—¥å¿—... Ctrl+C é€€å‡ºã€‚"; sleep 1; docker logs -f "$container_name"; }
function select_node_for_action() { local action_callback=$1; local prompt_message=$2; local all_nodes=($(get_all_node_ids)); if [ ${#all_nodes[@]} -eq 0 ]; then echo "å½“å‰æ²¡æœ‰å¯æ“ä½œçš„èŠ‚ç‚¹ã€‚"; read -p "æŒ‰ä»»æ„é”®è¿”å›..." -n1 -s; return; fi; echo "è¯·é€‰æ‹©è¦'$prompt_message'çš„èŠ‚ç‚¹:"; echo "0. è¿”å›"; for i in "${!all_nodes[@]}"; do printf "%2d. %s\n" $((i+1)) "${all_nodes[$i]}"; done; read -rp "è¯·è¾“å…¥é€‰é¡¹: "; if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 0 ] || [ "$choice" -gt ${#all_nodes[@]} ]; then echo "æ— æ•ˆé€‰é¡¹ã€‚"; sleep 1; return; fi; [ "$choice" -eq 0 ] && return; local selected_node_id=${all_nodes[$((choice-1))]} ; "$action_callback" "$selected_node_id"; }
function uninstall_all_nodes_and_image() { echo "!!!!!! æåº¦å±é™©æ“ä½œ !!!!!!"; echo "å°†åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹å®¹å™¨å’Œé•œåƒ $IMAGE_NAME"; read -rp "è¾“å…¥ 'yes' ç¡®è®¤: "; if [ "$confirmation" != "yes" ]; then echo "æ“ä½œå–æ¶ˆã€‚"; return; fi; local all_nodes=($(get_all_node_ids)); if [ ${#all_nodes[@]} -gt 0 ]; then echo "æ­£åœ¨å¸è½½æ‰€æœ‰èŠ‚ç‚¹..."; for node_id in "${all_nodes[@]}"; do uninstall_node "$node_id"; done; fi; if docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then echo "åˆ é™¤é•œåƒ..."; docker rmi -f "$IMAGE_NAME"; fi; echo "æ¸…ç†å®Œæˆã€‚"; }

# --- ä¸»èœå•å¾ªç¯ (V5) ---
function main_menu() {
    while true; do
        clear
        echo "è„šæœ¬ç”±å“ˆå“ˆå“ˆå“ˆç¼–å†™ï¼Œæ¨ç‰¹ @ferdie_jhovieï¼Œå…è´¹å¼€æºï¼Œè¯·å‹¿ç›¸ä¿¡æ”¶è´¹"
        echo "========= Nexus ç®¡ç† (8æ ¸16G æé™ä¼˜åŒ–ç‰ˆ V5) ========="
        echo "1. ã€æ¨èã€‘ä¸€é”®éƒ¨ç½² 3 èŠ‚ç‚¹æ–¹æ¡ˆ (ä¸“ä¸º8æ ¸/16G)"
        echo "2. å®‰è£…/å¯åŠ¨å•ä¸ªè‡ªå®šä¹‰èŠ‚ç‚¹"
        echo "3. æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹æ—¥å¿—"
        echo "4. å¸è½½æŒ‡å®šèŠ‚ç‚¹"
        echo "5. å¸è½½æ‰€æœ‰èŠ‚ç‚¹å¹¶åˆ é™¤é•œåƒ (å±é™©!)"
        echo "6. é€€å‡ºè„šæœ¬"
        echo "-----------------------------------------------------------"
        echo "é¢„è®¾èµ„æº: CPU=${CPU_LIMIT}/èŠ‚ç‚¹, å†…å­˜=${MEMORY_LIMIT}/èŠ‚ç‚¹"
        echo "==========================================================="
        list_nodes

        read -rp "è¯·è¾“å…¥é€‰é¡¹(1-6): " choice

        case $choice in
            1)
                deploy_recommended_setup
                read -p "æ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®è¿”å›èœå•..."
                ;;
            2)
                read -rp "è¯·è¾“å…¥æ‚¨çš„ Node ID: " NODE_ID
                if [ -n "$NODE_ID" ]; then
                    build_image
                    run_container "$NODE_ID"
                else
                    echo "Node ID ä¸èƒ½ä¸ºç©ºï¼"
                fi
                read -p "æ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®è¿”å›èœå•..."
                ;;
            3)
                select_node_for_action "view_node_logs" "æŸ¥çœ‹æ—¥å¿—"
                ;;
            4)
                select_node_for_action "uninstall_node" "å¸è½½"
                read -p "æ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®è¿”å›..."
                ;;
            5)
                uninstall_all_nodes_and_image
                read -p "æ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®è¿”å›..."
                ;;
            6)
                echo "é€€å‡ºè„šæœ¬ã€‚"
                exit 0
                ;;
            *)
                echo "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚"
                sleep 1
                ;;
        esac
    done
}

# --- è„šæœ¬æ‰§è¡Œå…¥å£ ---
check_docker
# åˆ›å»ºä¸´æ—¶çš„ entrypoint.sh ç”¨äº Docker build context
cat > entrypoint.sh <<'EOF'
#!/bin/sh
set -e
if [ -z "$NODE_ID" ]; then echo "é”™è¯¯ï¼šç¼ºå°‘ NODE_ID ç¯å¢ƒå˜é‡ï¼" >&2; exit 1; fi
mkdir -p /root/.nexus && echo "$NODE_ID" > /root/.nexus/node-id
echo "èŠ‚ç‚¹ [ $NODE_ID ] é…ç½®å®Œæˆï¼Œå¯åŠ¨ä¸»è¿›ç¨‹..."
echo "æ—¥å¿—å°†ç”± Docker æ•è·, ä½¿ç”¨ 'docker logs <å®¹å™¨å>' æŸ¥çœ‹ã€‚"
exec nexus-network start --node-id "$NODE_ID"
EOF

# ä¸»é€»è¾‘
main_menu

# è„šæœ¬ç»“æŸæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f entrypoint.sh
